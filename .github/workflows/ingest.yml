name: Daily Ingestion

on:
  schedule:
    # Main ingestion runs daily at 08:15 UTC
    - cron: "15 8 * * *"
    # Tournament discovery runs weekly on Sundays at 06:00 UTC
    - cron: "0 6 * * 0"
  workflow_dispatch:
    inputs:
      run_discovery:
        description: "Run tournament discovery"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      skip_elo:
        description: "Skip ELO recalculation"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      skip_rankings:
        description: "Skip GotSport rankings update"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  # Weekly tournament discovery job
  discover:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 6 * * 0' || github.event.inputs.run_discovery == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: pip install requests beautifulsoup4 python-dotenv

      - name: Run tournament discovery
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: python scripts/discover_tournaments.py --known-only

  # Daily match ingestion job
  ingest:
    runs-on: ubuntu-latest
    needs: [discover]
    if: always() && (needs.discover.result == 'success' || needs.discover.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Run ingestion script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: node scripts/ingest_heartland.js

  # Daily GotSport rankings update job (NEW)
  rankings:
    runs-on: ubuntu-latest
    needs: [discover]
    if: always() && (needs.discover.result == 'success' || needs.discover.result == 'skipped') && github.event.inputs.skip_rankings != 'true'
    timeout-minutes: 240
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Run GotSport rankings scraper
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: node scripts/scrape_gotsport_rankings.js --import

      - name: Upload rankings artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rankings-data-${{ github.run_number }}
          path: gotsport_rankings_data/
          retention-days: 7

  # ELO recalculation job (runs after ingestion AND rankings)
  elo:
    runs-on: ubuntu-latest
    needs: [ingest, rankings]
    if: always() && (needs.ingest.result == 'success' || needs.rankings.result == 'success') && github.event.inputs.skip_elo != 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Recalculate ELO ratings
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: node scripts/recalculate_elo.js

      - name: Summary
        run: |
          echo "## Daily Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Ingestion: ${{ needs.ingest.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Rankings: ${{ needs.rankings.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ELO Recalculation: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u)" >> $GITHUB_STEP_SUMMARY
