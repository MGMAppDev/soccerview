name: Daily Ingestion

on:
  schedule:
    # Main ingestion runs daily at 08:15 UTC
    - cron: "15 8 * * *"
    # Tournament discovery runs weekly on Sundays at 06:00 UTC
    - cron: "0 6 * * 0"
  workflow_dispatch:
    inputs:
      run_discovery:
        description: "Run tournament discovery"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      skip_elo:
        description: "Skip ELO recalculation"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  # Weekly tournament discovery job
  discover:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 6 * * 0' || github.event.inputs.run_discovery == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: pip install requests beautifulsoup4 python-dotenv

      - name: Run tournament discovery
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: python scripts/discover_tournaments.py --known-only

  # Daily match ingestion job
  ingest:
    runs-on: ubuntu-latest
    needs: [discover]
    if: always() && (needs.discover.result == 'success' || needs.discover.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Run ingestion script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: node scripts/ingest_heartland.js

  # ELO recalculation job (runs after ingestion)
  elo:
    runs-on: ubuntu-latest
    needs: [ingest]
    if: always() && needs.ingest.result == 'success' && github.event.inputs.skip_elo != 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Recalculate ELO ratings
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: node scripts/recalculate_elo.js

      - name: Summary
        run: |
          echo "## Daily Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Ingestion: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- ELO Recalculation: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u)" >> $GITHUB_STEP_SUMMARY
