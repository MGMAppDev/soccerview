name: Daily Data Sync (V2 Architecture)

# =============================================================================
# SoccerView Daily Data Pipeline - V2 Architecture
# =============================================================================
# Uses the three-layer database architecture:
#   Staging Tables -> Validation Pipeline -> Production Tables -> App Views
#
# Pipeline Flow:
#   1. DATA COLLECTION (parallel):
#      - GotSport active events       -> staging_games
#      - HTGSports tournaments        -> staging_games
#      - Heartland league             -> staging_games
#      - SINC Sports leagues (NC/TN)  -> staging_games
#      - TotalGlobalSports (ECNL)    -> staging_games (Puppeteer+stealth)
#      - MLS Next                    -> staging_games (Puppeteer)
#      - SportsAffinity (7 states)   -> staging_games (Cheerio)
#      - Demosphere (NCSL VA/DC)     -> staging_games (Cheerio)
#      - PlayMetrics (CO/SDL/WI)      -> staging_games (Puppeteer)
#   1.5. STANDINGS SCRAPING (parallel with Phase 1):
#      - League standings (heartland + sincsports) -> staging_standings
#   2. VALIDATION PIPELINE:
#      - Process staging_games -> matches_v2
#      - Create/link teams in teams_v2
#      - Create/link events in leagues/tournaments
#   2.6. STANDINGS PROCESSING (lightweight resolver ‚Äî NO fuzzy matching):
#      - Process staging_standings -> league_standings (exact match + create-if-missing)
#   2.7. GOTSPORT RANKINGS REFRESH (Session 94):
#      - Fetch rankings from GotSport API -> teams_v2 (LEAST/GREATEST safe)
#   3. ELO CALCULATION - Update power ratings in teams_v2
#   4. PREDICTION SCORING - Score user predictions
#   5. REFRESH VIEWS - Refresh all materialized views (including hybrid standings)
#
# SCRAPER FRAMEWORK:
#   - Default: Universal Scraper Framework (scripts/universal/coreScraper.js)
#   - Fallback: Legacy scrapers (scripts/daily/syncActiveEvents.js, etc.)
#   - Toggle via workflow_dispatch input: use_universal_framework
#
# Runtime: ~30-45 minutes total
# =============================================================================

on:
  schedule:
    # Run daily at 6 AM UTC (1 AM EST / midnight CST)
    - cron: "0 6 * * *"
  workflow_dispatch:
    inputs:
      sync_type:
        description: "Type of sync to run"
        required: true
        default: "full"
        type: choice
        options:
          - full
          - gotsport_only
          - heartland_only
          - validation_only
          - elo_only
          - scoring_only
      use_universal_framework:
        description: "Use new Universal Scraper Framework"
        required: false
        default: true
        type: boolean
      fallback_on_error:
        description: "Fall back to legacy scrapers if universal fails"
        required: false
        default: true
        type: boolean
      run_dedup:
        description: "Run weekly deduplication check (normally Sundays only)"
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: "20"
  # Default to universal framework for scheduled runs
  USE_UNIVERSAL: ${{ github.event.inputs.use_universal_framework == 'true' || github.event.inputs.use_universal_framework == null }}
  FALLBACK_ENABLED: ${{ github.event.inputs.fallback_on_error == 'true' || github.event.inputs.fallback_on_error == null }}

jobs:
  # ============================================================================
  # PHASE 0: EVENT DISCOVERY (Session 82) - Analyze orphan patterns
  # ============================================================================

  discover-events:
    name: "üîç Discover GotSport Events"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 5
    outputs:
      orphan_count: ${{ steps.discover.outputs.orphan_count }}
      coverage_rate: ${{ steps.discover.outputs.coverage_rate }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Analyze Orphan Patterns
        id: discover
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          node scripts/daily/discoverGotSportEvents.cjs --report 2>&1 | tee discover_output.txt

          # Extract metrics from output
          ORPHANS=$(grep -oP 'Total orphan teams:\s*\K[\d,]+' discover_output.txt | tr -d ',' | tail -1 || echo "0")
          COVERAGE=$(grep -oP 'Teams with matches:\s*[\d,]+\s*\(\K[\d.]+' discover_output.txt | tail -1 || echo "0")
          echo "orphan_count=$ORPHANS" >> $GITHUB_OUTPUT
          echo "coverage_rate=$COVERAGE" >> $GITHUB_OUTPUT
        timeout-minutes: 3
        continue-on-error: true

  # ============================================================================
  # PHASE 1: DATA COLLECTION (Parallel) - All write to staging_games
  # ============================================================================

  sync-gotsport:
    name: "üìä GotSport Events"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == 'gotsport_only' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 60
    outputs:
      matches_staged: ${{ steps.sync.outputs.matches_staged || steps.fallback.outputs.matches_staged }}
      status: ${{ steps.sync.outcome || steps.fallback.outcome }}
      framework_used: ${{ steps.sync.outputs.framework || steps.fallback.outputs.framework }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Sync GotSport (Universal Framework)
        id: sync
        if: ${{ env.USE_UNIVERSAL == 'true' }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üöÄ Using Universal Scraper Framework"
          node scripts/universal/coreScraper.js --adapter gotsport --active-only 2>&1 | tee sync_output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          # Extract staged match count from output
          MATCHES=$(grep -oP 'Total matches staged:\s*\K\d+' sync_output.txt | tail -1 || echo "0")
          echo "matches_staged=$MATCHES" >> $GITHUB_OUTPUT
          echo "framework=universal" >> $GITHUB_OUTPUT

          exit $EXIT_CODE
        timeout-minutes: 90
        continue-on-error: ${{ env.FALLBACK_ENABLED == 'true' }}

      - name: Sync GotSport (Legacy Fallback)
        id: fallback
        if: ${{ env.USE_UNIVERSAL != 'true' || (steps.sync.outcome == 'failure' && env.FALLBACK_ENABLED == 'true') }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üì¶ Using Legacy Scraper (syncActiveEvents.js)"
          node scripts/daily/syncActiveEvents.js 2>&1 | tee sync_output.txt

          # Extract staged match count from output
          MATCHES=$(grep -oP 'Staged \K\d+' sync_output.txt | tail -1 || echo "0")
          echo "matches_staged=$MATCHES" >> $GITHUB_OUTPUT
          echo "framework=legacy" >> $GITHUB_OUTPUT
        timeout-minutes: 90

  sync-htgsports:
    name: "üèÜ HTGSports Tournaments"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == 'heartland_only' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 60
    outputs:
      matches_staged: ${{ steps.sync.outputs.matches_staged || steps.fallback.outputs.matches_staged }}
      status: ${{ job.status }}
      framework_used: ${{ steps.sync.outputs.framework || steps.fallback.outputs.framework }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Puppeteer browsers
        run: npx puppeteer browsers install chrome

      - name: Sync HTGSports (Universal Framework)
        id: sync
        if: ${{ env.USE_UNIVERSAL == 'true' }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üöÄ Using Universal Scraper Framework"
          node scripts/universal/coreScraper.js --adapter htgsports --active-only 2>&1 | tee htg_output.txt || true

          # Extract staged match count from output
          MATCHES=$(grep -oP 'Total matches staged:\s*\K\d+' htg_output.txt | tail -1 || echo "0")
          echo "matches_staged=$MATCHES" >> $GITHUB_OUTPUT
          echo "framework=universal" >> $GITHUB_OUTPUT
        timeout-minutes: 45
        continue-on-error: true

      - name: Sync HTGSports (Legacy Fallback)
        id: fallback
        if: ${{ env.USE_UNIVERSAL != 'true' || steps.sync.outcome == 'failure' }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üì¶ Using Legacy Scraper (scrapeHTGSports.js)"
          node scripts/scrapers/scrapeHTGSports.js --active-only 2>&1 | tee htg_output.txt || true

          MATCHES=$(grep -oP 'Staged: \K\d+' htg_output.txt | tail -1 || echo "0")
          echo "matches_staged=$MATCHES" >> $GITHUB_OUTPUT
          echo "framework=legacy" >> $GITHUB_OUTPUT
        timeout-minutes: 45
        continue-on-error: true

  sync-heartland:
    name: "‚öΩ Heartland League"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == 'heartland_only' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 45
    outputs:
      matches_staged: ${{ steps.sync.outputs.matches_staged || steps.fallback.outputs.matches_staged }}
      status: ${{ job.status }}
      framework_used: ${{ steps.sync.outputs.framework || steps.fallback.outputs.framework }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Sync Heartland (Universal Framework)
        id: sync
        if: ${{ env.USE_UNIVERSAL == 'true' }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üöÄ Using Universal Scraper Framework"
          node scripts/universal/coreScraper.js --adapter heartland --active-only 2>&1 | tee heartland_output.txt || true

          # Extract staged match count from output
          MATCHES=$(grep -oP 'Total matches staged:\s*\K\d+' heartland_output.txt | tail -1 || echo "0")
          echo "matches_staged=$MATCHES" >> $GITHUB_OUTPUT
          echo "framework=universal" >> $GITHUB_OUTPUT
        timeout-minutes: 30
        continue-on-error: true

      - name: Sync Heartland (Legacy Fallback)
        id: fallback
        if: ${{ env.USE_UNIVERSAL != 'true' || steps.sync.outcome == 'failure' }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üì¶ Using Legacy Scrapers"
          # Run both league calendar and results scrapers
          node scripts/scrapers/scrapeHeartlandLeague.js --active-only 2>&1 | tee league_output.txt || true
          node scripts/scrapers/scrapeHeartlandResults.js 2>&1 | tee results_output.txt || true

          LEAGUE_MATCHES=$(grep -oP 'Staged: \K\d+' league_output.txt | tail -1 || echo "0")
          RESULTS_MATCHES=$(grep -oP 'Staged \K\d+' results_output.txt | tail -1 || echo "0")
          TOTAL=$((LEAGUE_MATCHES + RESULTS_MATCHES))
          echo "matches_staged=$TOTAL" >> $GITHUB_OUTPUT
          echo "framework=legacy" >> $GITHUB_OUTPUT
        timeout-minutes: 30
        continue-on-error: true

  sync-sincsports:
    name: "üèüÔ∏è SINC Sports Leagues"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 60
    outputs:
      matches_staged: ${{ steps.sync.outputs.matches_staged }}
      status: ${{ job.status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Puppeteer browsers
        run: npx puppeteer browsers install chrome

      - name: Sync SINC Sports (Universal Framework)
        id: sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üèüÔ∏è Scraping SINC Sports leagues (NC)"
          node scripts/universal/coreScraper.js --adapter sincsports --active-only 2>&1 | tee sinc_output.txt || true

          MATCHES=$(grep -oP 'Matches staged:\s*\K\d+' sinc_output.txt | tail -1 || echo "0")
          echo "matches_staged=$MATCHES" >> $GITHUB_OUTPUT
          echo "üèüÔ∏è SINC Sports matches staged: $MATCHES"
        timeout-minutes: 45
        continue-on-error: true

  sync-totalglobalsports:
    name: "üèÖ TotalGlobalSports (ECNL)"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 120
    outputs:
      matches_staged: ${{ steps.sync.outputs.matches_staged }}
      status: ${{ job.status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Puppeteer browsers
        run: npx puppeteer browsers install chrome

      - name: Sync TotalGlobalSports / ECNL (Puppeteer + Stealth)
        id: sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üèÖ Scraping TotalGlobalSports (ECNL/ECRL/Pre-ECNL)"
          node scripts/universal/coreScraper.js --adapter totalglobalsports --active-only 2>&1 | tee tgs_output.txt || true

          MATCHES=$(grep -oP 'Total matches staged:\s*\K\d+' tgs_output.txt | tail -1 || echo "0")
          echo "matches_staged=$MATCHES" >> $GITHUB_OUTPUT
          echo "üèÖ TGS matches staged: $MATCHES"
        timeout-minutes: 110
        continue-on-error: true

  sync-mlsnext:
    name: "‚öΩ MLS Next"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 30
    outputs:
      matches_staged: ${{ steps.sync.outputs.matches_staged }}
      status: ${{ job.status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Puppeteer browsers
        run: npx puppeteer browsers install chrome

      - name: Sync MLS Next (Puppeteer)
        id: sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "‚öΩ Scraping MLS Next (Modular11)"
          node scripts/universal/coreScraper.js --adapter mlsnext --active-only 2>&1 | tee mls_output.txt || true

          MATCHES=$(grep -oP 'Total matches staged:\s*\K\d+' mls_output.txt | tail -1 || echo "0")
          echo "matches_staged=$MATCHES" >> $GITHUB_OUTPUT
          echo "‚öΩ MLS Next matches staged: $MATCHES"
        timeout-minutes: 25
        continue-on-error: true

  sync-sportsaffinity:
    name: "üåê SportsAffinity"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 30
    outputs:
      matches_staged: ${{ steps.sync.outputs.matches_staged }}
      status: ${{ job.status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Sync SportsAffinity (Cheerio - 7 states)
        id: sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üåê Scraping SportsAffinity (GA, MN, UT, OR, NE, PA-W, HI)"
          node scripts/universal/coreScraper.js --adapter sportsaffinity --active-only 2>&1 | tee sa_output.txt || true

          MATCHES=$(grep -oP 'Total matches staged:\s*\K\d+' sa_output.txt | tail -1 || echo "0")
          echo "matches_staged=$MATCHES" >> $GITHUB_OUTPUT
          echo "üåê SportsAffinity matches staged: $MATCHES"
        timeout-minutes: 25
        continue-on-error: true

  sync-demosphere:
    name: "üèõÔ∏è Demosphere (NCSL VA/DC)"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 30
    outputs:
      matches_staged: ${{ steps.sync.outputs.matches_staged }}
      status: ${{ job.status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Sync Demosphere (Cheerio - NCSL VA/DC)
        id: sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üèõÔ∏è Scraping Demosphere (NCSL VA/DC)"
          node scripts/universal/coreScraper.js --adapter demosphere --active-only 2>&1 | tee demo_output.txt || true

          MATCHES=$(grep -oP 'Total matches staged:\s*\K\d+' demo_output.txt | tail -1 || echo "0")
          echo "matches_staged=$MATCHES" >> $GITHUB_OUTPUT
          echo "üèõÔ∏è Demosphere matches staged: $MATCHES"
        timeout-minutes: 25
        continue-on-error: true

  sync-playmetrics:
    name: "üèîÔ∏è PlayMetrics (CO/SDL/WI)"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 60
    outputs:
      matches_staged: ${{ steps.sync.outputs.matches_staged }}
      status: ${{ job.status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Puppeteer browsers
        run: npx puppeteer browsers install chrome

      - name: Sync PlayMetrics (Puppeteer - CO/SDL)
        id: sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üèîÔ∏è Scraping PlayMetrics (CO CAL + SDL)"
          node scripts/universal/coreScraper.js --adapter playmetrics --active-only 2>&1 | tee pm_output.txt || true

          MATCHES=$(grep -oP 'Total matches staged:\s*\K\d+' pm_output.txt | tail -1 || echo "0")
          echo "matches_staged=$MATCHES" >> $GITHUB_OUTPUT
          echo "üèîÔ∏è PlayMetrics matches staged: $MATCHES"
        timeout-minutes: 50
        continue-on-error: true

  # ============================================================================
  # PHASE 1.5: STANDINGS SCRAPING (Parallel with match scraping)
  # Scrape authoritative league standings ‚Üí staging_standings
  # Universal: works for ANY adapter with standings.enabled = true
  # ============================================================================

  scrape-standings:
    name: "üìã Scrape Standings"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == 'heartland_only' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 30
    outputs:
      standings_staged: ${{ steps.scrape.outputs.standings }}
      status: ${{ job.status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Puppeteer browsers
        run: npx puppeteer browsers install chrome

      - name: Scrape League Standings (All Adapters)
        id: scrape
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üìã Scraping authoritative league standings"
          TOTAL=0

          # Heartland standings (CGI/Cheerio)
          node scripts/universal/scrapeStandings.js --adapter heartland 2>&1 | tee standings_heartland.txt || true
          HL=$(grep -oP 'Inserted \K\d+' standings_heartland.txt | tail -1 || echo "0")
          echo "üìã Heartland standings: $HL"
          TOTAL=$((TOTAL + HL))

          # SINC Sports standings (Puppeteer)
          node scripts/universal/scrapeStandings.js --adapter sincsports 2>&1 | tee standings_sinc.txt || true
          SC=$(grep -oP 'Inserted \K\d+' standings_sinc.txt | tail -1 || echo "0")
          echo "üìã SINC Sports standings: $SC"
          TOTAL=$((TOTAL + SC))

          echo "standings=$TOTAL" >> $GITHUB_OUTPUT
          echo "üìã Total standings scraped: $TOTAL"
        timeout-minutes: 25
        continue-on-error: true

  # ============================================================================
  # PHASE 2: VALIDATION PIPELINE (After all data collected)
  # Process staging_games -> matches_v2, create/link teams, refresh views
  # ============================================================================

  validation-pipeline:
    name: "üîÑ Validation Pipeline"
    runs-on: ubuntu-latest
    needs: [sync-gotsport, sync-htgsports, sync-heartland, sync-sincsports, sync-totalglobalsports, sync-mlsnext, sync-sportsaffinity, sync-demosphere, sync-playmetrics]
    if: >-
      ${{
        always() &&
        (github.event.inputs.sync_type == 'full' ||
         github.event.inputs.sync_type == 'validation_only' ||
         github.event.inputs.sync_type == null) &&
        (needs.sync-gotsport.result == 'success' ||
         needs.sync-gotsport.result == 'skipped') &&
        (needs.sync-htgsports.result == 'success' ||
         needs.sync-htgsports.result == 'skipped' ||
         needs.sync-htgsports.result == 'failure') &&
        (needs.sync-heartland.result == 'success' ||
         needs.sync-heartland.result == 'skipped' ||
         needs.sync-heartland.result == 'failure') &&
        (needs.sync-sincsports.result == 'success' ||
         needs.sync-sincsports.result == 'skipped' ||
         needs.sync-sincsports.result == 'failure') &&
        (needs.sync-totalglobalsports.result == 'success' ||
         needs.sync-totalglobalsports.result == 'skipped' ||
         needs.sync-totalglobalsports.result == 'failure') &&
        (needs.sync-mlsnext.result == 'success' ||
         needs.sync-mlsnext.result == 'skipped' ||
         needs.sync-mlsnext.result == 'failure') &&
        (needs.sync-sportsaffinity.result == 'success' ||
         needs.sync-sportsaffinity.result == 'skipped' ||
         needs.sync-sportsaffinity.result == 'failure') &&
        (needs.sync-demosphere.result == 'success' ||
         needs.sync-demosphere.result == 'skipped' ||
         needs.sync-demosphere.result == 'failure') &&
        (needs.sync-playmetrics.result == 'success' ||
         needs.sync-playmetrics.result == 'skipped' ||
         needs.sync-playmetrics.result == 'failure')
      }}
    timeout-minutes: 45
    outputs:
      matches_validated: ${{ steps.validate.outputs.matches }}
      teams_created: ${{ steps.validate.outputs.teams }}
      views_refreshed: ${{ steps.validate.outputs.views }}
      engine_used: ${{ steps.validate.outputs.engine }}
      matches_inserted: ${{ steps.validate.outputs.inserted || '0' }}
      intake_fixed: ${{ steps.intake.outputs.fixed || '0' }}
      intake_rejected: ${{ steps.intake.outputs.rejected || '0' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # V2 ARCHITECTURE ENFORCEMENT (Session 79):
      # Step 1: Intake Validation Gate - Reject garbage data BEFORE processing
      - name: Run Intake Validation Gate
        id: intake
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üö™ Running Intake Validation Gate"
          node scripts/universal/intakeValidator.js --clean-staging --limit 50000 2>&1 | tee intake_output.txt

          # Extract metrics
          FIXED=$(grep -oP '\d+(?= auto-fixed)' intake_output.txt | tail -1 || echo "0")
          REJECTED=$(grep -oP 'Rejected:\s*\K\d+' intake_output.txt | tail -1 || echo "0")
          echo "fixed=$FIXED" >> $GITHUB_OUTPUT
          echo "rejected=$REJECTED" >> $GITHUB_OUTPUT
          echo "‚úÖ Intake validation complete: $FIXED fixed, $REJECTED rejected"
        timeout-minutes: 10

      # Step 2: Data Quality Engine - THE ONLY path from staging to production
      - name: Run Data Quality Engine
        id: validate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üöÄ Running Universal Data Quality Engine (V2 Architecture)"
          node scripts/universal/dataQualityEngine.js --process-staging 2>&1 | tee validate_output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          # Extract metrics from engine output
          MATCHES=$(grep -oP 'Records promoted:\s*\K\d+' validate_output.txt | tail -1 || echo "0")
          TEAMS=$(grep -oP 'Created:\s*\K\d+' validate_output.txt | head -1 || echo "0")
          INSERTED=$(grep -oP 'Inserted:\s*\K\d+' validate_output.txt | tail -1 || echo "0")
          echo "matches=$MATCHES" >> $GITHUB_OUTPUT
          echo "teams=$TEAMS" >> $GITHUB_OUTPUT
          echo "inserted=$INSERTED" >> $GITHUB_OUTPUT
          echo "views=yes" >> $GITHUB_OUTPUT
          echo "engine=dataQualityEngine" >> $GITHUB_OUTPUT

          exit $EXIT_CODE
        timeout-minutes: 40

  # ============================================================================
  # PHASE 2.5: INFERENCE LINKAGE (Fix orphaned matches over time)
  # Links unlinked matches by inferring event from team activity patterns
  # ============================================================================

  infer-event-linkage:
    name: "üîó Infer Event Linkage"
    runs-on: ubuntu-latest
    needs: validation-pipeline
    if: >-
      ${{
        always() &&
        (github.event.inputs.sync_type == 'full' ||
         github.event.inputs.sync_type == null) &&
        (needs.validation-pipeline.result == 'success' ||
         needs.validation-pipeline.result == 'skipped')
      }}
    timeout-minutes: 20
    outputs:
      matches_linked: ${{ steps.infer.outputs.matches }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Infer Event Linkage for Orphaned Matches
        id: infer
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node scripts/maintenance/inferEventLinkage.js 2>&1 | tee infer_output.txt
          MATCHES=$(grep -oP 'Matches updated:\s+\K\d+' infer_output.txt | tail -1 || echo "0")
          echo "matches=$MATCHES" >> $GITHUB_OUTPUT
        timeout-minutes: 15
        continue-on-error: true

  # ============================================================================
  # PHASE 2.6: STANDINGS PROCESSING (After validation + scraping)
  # Process staging_standings ‚Üí league_standings (production)
  # Universal: works for ANY source that writes to staging_standings
  # ============================================================================

  process-standings:
    name: "üìã Process Standings"
    runs-on: ubuntu-latest
    needs: [validation-pipeline, scrape-standings]
    if: >-
      ${{
        always() &&
        (github.event.inputs.sync_type == 'full' ||
         github.event.inputs.sync_type == 'heartland_only' ||
         github.event.inputs.sync_type == null) &&
        (needs.validation-pipeline.result == 'success' ||
         needs.validation-pipeline.result == 'skipped') &&
        (needs.scrape-standings.result == 'success' ||
         needs.scrape-standings.result == 'skipped')
      }}
    timeout-minutes: 15
    outputs:
      standings_resolved: ${{ steps.process.outputs.resolved }}
      standings_skipped: ${{ steps.process.outputs.skipped }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Process Standings (staging ‚Üí production)
        id: process
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üìã Processing standings: staging_standings ‚Üí league_standings"
          node scripts/maintenance/processStandings.cjs --verbose 2>&1 | tee process_output.txt || true

          # Extract metrics
          RESOLVED=$(grep -oP 'Resolved & upserted:\s*\K\d+' process_output.txt | tail -1 || echo "0")
          SKIPPED_TEAM=$(grep -oP 'Skipped \(no team\):\s*\K\d+' process_output.txt | tail -1 || echo "0")
          SKIPPED_LEAGUE=$(grep -oP 'Skipped \(no league\):\s*\K\d+' process_output.txt | tail -1 || echo "0")
          TOTAL_SKIPPED=$((SKIPPED_TEAM + SKIPPED_LEAGUE))
          echo "resolved=$RESOLVED" >> $GITHUB_OUTPUT
          echo "skipped=$TOTAL_SKIPPED" >> $GITHUB_OUTPUT
          echo "üìã Standings resolved: $RESOLVED, skipped: $TOTAL_SKIPPED"
        timeout-minutes: 10
        continue-on-error: true

  # ============================================================================
  # PHASE 2.25: WEEKLY DEDUPLICATION (Sundays only)
  # Scan for duplicate matches, teams, events and generate reports
  # ============================================================================

  weekly-dedup-check:
    name: "üîç Weekly Dedup Check"
    runs-on: ubuntu-latest
    needs: [validation-pipeline, infer-event-linkage]
    # Only run on Sundays (cron day 0) or manual trigger with full sync
    if: >-
      ${{
        always() &&
        (github.event.schedule != null && contains(github.event.schedule, '* * 0')) ||
        (github.event.inputs.sync_type == 'full' && github.event.inputs.run_dedup == 'true')
      }}
    timeout-minutes: 30
    outputs:
      match_dupes: ${{ steps.dedup.outputs.match_dupes }}
      team_dupes: ${{ steps.dedup.outputs.team_dupes }}
      event_dupes: ${{ steps.dedup.outputs.event_dupes }}
      canonical_events: ${{ steps.registry.outputs.canonical_events }}
      canonical_teams: ${{ steps.registry.outputs.canonical_teams }}
      canonical_clubs: ${{ steps.registry.outputs.canonical_clubs }}
      patterns_learned: ${{ steps.learn.outputs.team_patterns }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Deduplication Reports
        id: dedup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üîç Running weekly deduplication check..."

          # Run match dedup report
          node scripts/universal/deduplication/matchDedup.js --report 2>&1 | tee match_dedup.txt || true
          MATCH_DUPES=$(grep -oP 'duplicate groups:\s*\K\d+' match_dedup.txt | tail -1 || echo "0")
          echo "match_dupes=$MATCH_DUPES" >> $GITHUB_OUTPUT

          # Run team dedup report
          node scripts/universal/deduplication/teamDedup.js --report 2>&1 | tee team_dedup.txt || true
          TEAM_DUPES=$(grep -oP 'duplicate groups:\s*\K\d+' team_dedup.txt | tail -1 || echo "0")
          echo "team_dupes=$TEAM_DUPES" >> $GITHUB_OUTPUT

          # Run event dedup report
          node scripts/universal/deduplication/eventDedup.js --report 2>&1 | tee event_dedup.txt || true
          EVENT_DUPES=$(grep -oP 'duplicate groups:\s*\K\d+' event_dedup.txt | tail -1 || echo "0")
          echo "event_dupes=$EVENT_DUPES" >> $GITHUB_OUTPUT

          echo "üìä Dedup Summary: Matches=$MATCH_DUPES, Teams=$TEAM_DUPES, Events=$EVENT_DUPES"
        timeout-minutes: 25
        continue-on-error: true

      - name: Report Canonical Registry Growth
        id: registry
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üìä Canonical Registry Growth Report"
          echo ""

          # Query canonical registry counts using psql-compatible node script
          node -e "
            const { Pool } = require('pg');
            const pool = new Pool({ connectionString: process.env.DATABASE_URL });
            pool.query(\`
              SELECT
                (SELECT COUNT(*) FROM canonical_events) as events,
                (SELECT COUNT(*) FROM canonical_teams) as teams,
                (SELECT COUNT(*) FROM canonical_clubs) as clubs
            \`).then(res => {
              const { events, teams, clubs } = res.rows[0];
              console.log('canonical_events=' + events);
              console.log('canonical_teams=' + teams);
              console.log('canonical_clubs=' + clubs);
              // Write to outputs
              const fs = require('fs');
              fs.appendFileSync(process.env.GITHUB_OUTPUT, 'canonical_events=' + events + '\n');
              fs.appendFileSync(process.env.GITHUB_OUTPUT, 'canonical_teams=' + teams + '\n');
              fs.appendFileSync(process.env.GITHUB_OUTPUT, 'canonical_clubs=' + clubs + '\n');
              pool.end();
            }).catch(err => {
              console.error('Query failed:', err.message);
              process.exit(0); // Don't fail the job
            });
          "
        timeout-minutes: 5
        continue-on-error: true

      - name: Learn Patterns (Weekly)
        id: learn
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üìö Learning patterns from data..."

          # Learn team name patterns
          node scripts/universal/adaptiveLearning.js --learn-teams --source all 2>&1 | tee learn_teams.txt || true

          # Learn event patterns
          node scripts/universal/adaptiveLearning.js --learn-events --source all 2>&1 | tee learn_events.txt || true

          # Extract and report counts
          TEAM_PATTERNS=$(grep -oP 'Learned \K\d+' learn_teams.txt | head -1 || echo "0")
          echo "team_patterns=$TEAM_PATTERNS" >> $GITHUB_OUTPUT
          echo "üìä Patterns learned: Teams=$TEAM_PATTERNS"
        timeout-minutes: 10
        continue-on-error: true

  # ============================================================================
  # PHASE 2.75: DATA INTEGRITY VERIFICATION (Session 79)
  # Automated checks after processing to ensure data quality
  # ============================================================================

  verify-integrity:
    name: "üîç Verify Data Integrity"
    runs-on: ubuntu-latest
    needs: [validation-pipeline, infer-event-linkage]
    if: >-
      ${{
        always() &&
        (github.event.inputs.sync_type == 'full' ||
         github.event.inputs.sync_type == null) &&
        (needs.validation-pipeline.result == 'success' ||
         needs.validation-pipeline.result == 'skipped')
      }}
    timeout-minutes: 10
    outputs:
      checks_passed: ${{ steps.verify.outputs.passed }}
      checks_warned: ${{ steps.verify.outputs.warned }}
      checks_failed: ${{ steps.verify.outputs.failed }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Verify Data Integrity
        id: verify
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          node scripts/daily/verifyDataIntegrity.js 2>&1 | tee verify_output.txt
          # Extract metrics
          PASSED=$(grep -oP 'Passed:\s+\K\d+' verify_output.txt | tail -1 || echo "0")
          WARNED=$(grep -oP 'Warnings:\s+\K\d+' verify_output.txt | tail -1 || echo "0")
          FAILED=$(grep -oP 'Failed:\s+\K\d+' verify_output.txt | tail -1 || echo "0")
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "warned=$WARNED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
        timeout-minutes: 5
        continue-on-error: true

  # ============================================================================
  # PHASE 2.8: ADAPTIVE LEARNING VERIFICATION (Session 79)
  # Verify the adaptive learning system is healthy and improving
  # ============================================================================

  verify-adaptive-learning:
    name: "üß† Verify Adaptive Learning"
    runs-on: ubuntu-latest
    needs: [validation-pipeline, verify-integrity]
    if: >-
      ${{
        always() &&
        (github.event.inputs.sync_type == 'full' ||
         github.event.inputs.sync_type == null) &&
        (needs.validation-pipeline.result == 'success' ||
         needs.validation-pipeline.result == 'skipped')
      }}
    timeout-minutes: 5
    outputs:
      total_patterns: ${{ steps.verify.outputs.total_patterns }}
      team_patterns: ${{ steps.verify.outputs.team_patterns }}
      usage_rate: ${{ steps.verify.outputs.usage_rate }}
      failure_rate: ${{ steps.verify.outputs.failure_rate }}
      healthy: ${{ steps.verify.outputs.healthy }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Verify Adaptive Learning System
        id: verify
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          node scripts/daily/verifyAdaptiveLearning.js --verbose 2>&1 | tee learning_output.txt

          # Extract metrics from output
          TOTAL=$(grep -oP 'Total patterns:\s*\K\d+' learning_output.txt | tail -1 || echo "0")
          TEAM=$(grep -oP 'Team patterns:\s*\K\d+' learning_output.txt | tail -1 || echo "0")
          USAGE=$(grep -oP 'Usage rate:\s*\K[\d.]+' learning_output.txt | tail -1 || echo "0")
          FAILURE=$(grep -oP 'Failure rate:\s*\K[\d.]+' learning_output.txt | tail -1 || echo "0")

          # Check if healthy
          if grep -q "ADAPTIVE LEARNING SYSTEM HEALTHY" learning_output.txt; then
            HEALTHY="yes"
          else
            HEALTHY="no"
          fi

          echo "total_patterns=$TOTAL" >> $GITHUB_OUTPUT
          echo "team_patterns=$TEAM" >> $GITHUB_OUTPUT
          echo "usage_rate=$USAGE" >> $GITHUB_OUTPUT
          echo "failure_rate=$FAILURE" >> $GITHUB_OUTPUT
          echo "healthy=$HEALTHY" >> $GITHUB_OUTPUT
        timeout-minutes: 3
        continue-on-error: true

  # ============================================================================
  # PHASE 2.7: GOTSPORT RANKINGS REFRESH (Session 94)
  # Fetch current GotSport rankings and update teams_v2 using LEAST/GREATEST
  # Only enhances data ‚Äî never overwrites better values
  # ============================================================================

  refresh-gotsport-rankings:
    name: "üèÖ Refresh GotSport Rankings"
    runs-on: ubuntu-latest
    needs: validation-pipeline
    if: >-
      ${{
        always() &&
        (github.event.inputs.sync_type == 'full' ||
         github.event.inputs.sync_type == null) &&
        (needs.validation-pipeline.result == 'success' ||
         needs.validation-pipeline.result == 'skipped')
      }}
    timeout-minutes: 75
    outputs:
      teams_matched: ${{ steps.rankings.outputs.matched }}
      teams_not_found: ${{ steps.rankings.outputs.not_found }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - name: Install dependencies
        run: npm ci

      - name: Refresh GotSport Rankings
        id: rankings
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üèÖ Refreshing GotSport rankings (LEAST/GREATEST safe)"
          node scripts/maintenance/restoreGotSportRanks.cjs --execute 2>&1 | tee rankings_output.txt

          MATCHED=$(grep -oP 'Total matched:\s*\K\d+' rankings_output.txt | tail -1 || echo "0")
          NOT_FOUND=$(grep -oP 'Not found:\s*\K\d+' rankings_output.txt | tail -1 || echo "0")
          echo "matched=$MATCHED" >> $GITHUB_OUTPUT
          echo "not_found=$NOT_FOUND" >> $GITHUB_OUTPUT
          echo "üèÖ Rankings refreshed: $MATCHED matched, $NOT_FOUND not found"
        timeout-minutes: 70
        continue-on-error: true

  # ============================================================================
  # PHASE 3: ELO CALCULATION (Uses matches_v2)
  # ============================================================================

  recalculate-elo:
    name: "üìà Recalculate ELO"
    runs-on: ubuntu-latest
    needs: [validation-pipeline, infer-event-linkage, verify-integrity, verify-adaptive-learning, refresh-gotsport-rankings]
    if: >-
      ${{
        always() &&
        (github.event.inputs.sync_type == 'full' ||
         github.event.inputs.sync_type == 'elo_only' ||
         github.event.inputs.sync_type == null) &&
        (needs.validation-pipeline.result == 'success' ||
         needs.validation-pipeline.result == 'skipped')
      }}
    timeout-minutes: 30
    outputs:
      teams_rated: ${{ steps.elo.outputs.teams }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Recalculate ELO Ratings
        id: elo
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node scripts/daily/recalculate_elo_v2.js 2>&1 | tee elo_output.txt
          TEAMS=$(grep -oP 'Teams with ELO: \K\d+' elo_output.txt | tail -1 || echo "0")
          echo "teams=$TEAMS" >> $GITHUB_OUTPUT
        timeout-minutes: 20

  # ============================================================================
  # PHASE 4: PREDICTION SCORING
  # ============================================================================

  score-predictions:
    name: "üéØ Score Predictions"
    runs-on: ubuntu-latest
    needs: recalculate-elo
    if: >-
      ${{
        always() &&
        (github.event.inputs.sync_type == 'full' ||
         github.event.inputs.sync_type == 'scoring_only' ||
         github.event.inputs.sync_type == null) &&
        (needs.recalculate-elo.result == 'success' ||
         needs.recalculate-elo.result == 'skipped')
      }}
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Score Pending Predictions
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: node scripts/daily/scorePredictions.js
        timeout-minutes: 10

  # ============================================================================
  # PHASE 5: REFRESH VIEWS (Final step - ensure app data is current)
  # ============================================================================

  refresh-views:
    name: "üîÑ Refresh App Views"
    runs-on: ubuntu-latest
    needs: [recalculate-elo, score-predictions]
    if: >-
      ${{
        always() &&
        (github.event.inputs.sync_type == 'full' ||
         github.event.inputs.sync_type == null) &&
        (needs.recalculate-elo.result == 'success' ||
         needs.recalculate-elo.result == 'skipped')
      }}
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Refresh Materialized Views
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: node scripts/refresh_views_manual.js
        timeout-minutes: 10

      - name: Ensure View Indexes (Self-Healing)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: node scripts/maintenance/ensureViewIndexes.js --fix
        timeout-minutes: 5

  # ============================================================================
  # SUMMARY & REPORTING
  # ============================================================================

  summary:
    name: "üìä Generate Summary"
    runs-on: ubuntu-latest
    needs:
      - discover-events
      - sync-gotsport
      - sync-htgsports
      - sync-heartland
      - sync-sincsports
      - sync-totalglobalsports
      - sync-mlsnext
      - sync-sportsaffinity
      - sync-demosphere
      - sync-playmetrics
      - scrape-standings
      - validation-pipeline
      - process-standings
      - infer-event-linkage
      - weekly-dedup-check
      - verify-integrity
      - verify-adaptive-learning
      - refresh-gotsport-rankings
      - recalculate-elo
      - score-predictions
      - refresh-views
    if: always()

    steps:
      - name: Generate Pipeline Summary
        run: |
          echo "# üèÜ SoccerView Daily Data Sync (V2)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }} | **Triggered:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üîç Phase 0: Event Discovery (Session 82)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.discover-events.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Orphan Teams | ${{ needs.discover-events.outputs.orphan_count || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage Rate | ${{ needs.discover-events.outputs.coverage_rate || '-' }}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üìä Phase 1: Data Collection (Staging)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Source | Status | Matches | Framework |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|---------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| GotSport | ${{ needs.sync-gotsport.result || '‚è≠Ô∏è skipped' }} | ${{ needs.sync-gotsport.outputs.matches_staged || '-' }} | ${{ needs.sync-gotsport.outputs.framework_used || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| HTGSports | ${{ needs.sync-htgsports.result || '‚è≠Ô∏è skipped' }} | ${{ needs.sync-htgsports.outputs.matches_staged || '-' }} | ${{ needs.sync-htgsports.outputs.framework_used || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Heartland | ${{ needs.sync-heartland.result || '‚è≠Ô∏è skipped' }} | ${{ needs.sync-heartland.outputs.matches_staged || '-' }} | ${{ needs.sync-heartland.outputs.framework_used || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SINC Sports | ${{ needs.sync-sincsports.result || '‚è≠Ô∏è skipped' }} | ${{ needs.sync-sincsports.outputs.matches_staged || '-' }} | universal |" >> $GITHUB_STEP_SUMMARY
          echo "| TGS (ECNL) | ${{ needs.sync-totalglobalsports.result || '‚è≠Ô∏è skipped' }} | ${{ needs.sync-totalglobalsports.outputs.matches_staged || '-' }} | universal |" >> $GITHUB_STEP_SUMMARY
          echo "| MLS Next | ${{ needs.sync-mlsnext.result || '‚è≠Ô∏è skipped' }} | ${{ needs.sync-mlsnext.outputs.matches_staged || '-' }} | universal |" >> $GITHUB_STEP_SUMMARY
          echo "| SportsAffinity | ${{ needs.sync-sportsaffinity.result || '‚è≠Ô∏è skipped' }} | ${{ needs.sync-sportsaffinity.outputs.matches_staged || '-' }} | universal |" >> $GITHUB_STEP_SUMMARY
          echo "| Demosphere | ${{ needs.sync-demosphere.result || '‚è≠Ô∏è skipped' }} | ${{ needs.sync-demosphere.outputs.matches_staged || '-' }} | universal |" >> $GITHUB_STEP_SUMMARY
          echo "| PlayMetrics | ${{ needs.sync-playmetrics.result || '‚è≠Ô∏è skipped' }} | ${{ needs.sync-playmetrics.outputs.matches_staged || '-' }} | universal |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üìã Phase 1.5: Standings Scraping" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.scrape-standings.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Standings Staged | ${{ needs.scrape-standings.outputs.standings_staged || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üö™ Phase 1.75: Intake Validation Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Records Fixed | ${{ needs.validation-pipeline.outputs.intake_fixed || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Records Rejected | ${{ needs.validation-pipeline.outputs.intake_rejected || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üîÑ Phase 2: Data Quality Engine" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.validation-pipeline.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Engine | ${{ needs.validation-pipeline.outputs.engine_used || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Records Promoted | ${{ needs.validation-pipeline.outputs.matches_validated || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Matches Inserted | ${{ needs.validation-pipeline.outputs.matches_inserted || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Teams Created | ${{ needs.validation-pipeline.outputs.teams_created || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üìã Phase 2.6: Standings Processing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.process-standings.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Standings Resolved | ${{ needs.process-standings.outputs.standings_resolved || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Standings Skipped | ${{ needs.process-standings.outputs.standings_skipped || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üèÖ Phase 2.7: GotSport Rankings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.refresh-gotsport-rankings.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Teams Matched | ${{ needs.refresh-gotsport-rankings.outputs.teams_matched || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Teams Not Found | ${{ needs.refresh-gotsport-rankings.outputs.teams_not_found || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üîç Phase 2.25: Weekly Dedup Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Entity | Duplicate Groups |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Matches | ${{ needs.weekly-dedup-check.outputs.match_dupes || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Teams | ${{ needs.weekly-dedup-check.outputs.team_dupes || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Events | ${{ needs.weekly-dedup-check.outputs.event_dupes || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üìö Canonical Registry Growth" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Registry | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| canonical_events | ${{ needs.weekly-dedup-check.outputs.canonical_events || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| canonical_teams | ${{ needs.weekly-dedup-check.outputs.canonical_teams || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| canonical_clubs | ${{ needs.weekly-dedup-check.outputs.canonical_clubs || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üß† Adaptive Learning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### System Health (Daily)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.verify-adaptive-learning.outputs.healthy == 'yes' && '‚úÖ Healthy' || '‚ö†Ô∏è Needs Attention' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Patterns | ${{ needs.verify-adaptive-learning.outputs.total_patterns || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Team Patterns | ${{ needs.verify-adaptive-learning.outputs.team_patterns || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Usage Rate | ${{ needs.verify-adaptive-learning.outputs.usage_rate || '‚è≠Ô∏è skipped' }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Failure Rate | ${{ needs.verify-adaptive-learning.outputs.failure_rate || '‚è≠Ô∏è skipped' }}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Weekly Pattern Learning (Sundays)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Patterns Learned | ${{ needs.weekly-dedup-check.outputs.patterns_learned || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üîó Phase 2.5: Inference Linkage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.infer-event-linkage.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Orphaned Matches Linked | ${{ needs.infer-event-linkage.outputs.matches_linked || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üîç Phase 2.75: Data Integrity Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check Result | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Passed | ${{ needs.verify-integrity.outputs.checks_passed || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ö†Ô∏è Warnings | ${{ needs.verify-integrity.outputs.checks_warned || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failed | ${{ needs.verify-integrity.outputs.checks_failed || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üìà Phase 3-5: Processing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Recalculate ELO | ${{ needs.recalculate-elo.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Score Predictions | ${{ needs.score-predictions.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Refresh Views | ${{ needs.refresh-views.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ needs.sync-gotsport.result }}" == "failure" ]] || \
             [[ "${{ needs.validation-pipeline.result }}" == "failure" ]] || \
             [[ "${{ needs.recalculate-elo.result }}" == "failure" ]]; then
            echo "## ‚ö†Ô∏è Pipeline completed with errors" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚úÖ Pipeline completed successfully" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*V2 Architecture: staging_games ‚Üí dataQualityEngine ‚Üí matches_v2 ‚Üí app_* views*" >> $GITHUB_STEP_SUMMARY
          echo "*Standings: staging_standings ‚Üí processStandings ‚Üí league_standings ‚Üí app_league_standings (hybrid)*" >> $GITHUB_STEP_SUMMARY
          echo "*Rankings: GotSport API ‚Üí restoreGotSportRanks (LEAST/GREATEST) ‚Üí teams_v2*" >> $GITHUB_STEP_SUMMARY
          echo "*Scraper: Universal Framework | Data Quality: Universal Engine | Weekly Dedup: Sundays*" >> $GITHUB_STEP_SUMMARY
