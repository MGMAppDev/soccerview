name: Daily Data Sync (V2 Architecture)

# =============================================================================
# SoccerView Daily Data Pipeline - V2 Architecture
# =============================================================================
# Uses the three-layer database architecture:
#   Staging Tables -> Validation Pipeline -> Production Tables -> App Views
#
# Pipeline Flow:
#   1. DATA COLLECTION (parallel):
#      - GotSport active events       -> staging_games
#      - Heartland tournaments         -> staging_games
#      - Heartland league calendar     -> staging_games
#      - Heartland results (scores)    -> staging_games
#   2. VALIDATION PIPELINE:
#      - Process staging_games -> matches_v2
#      - Create/link teams in teams_v2
#      - Create/link events in leagues/tournaments
#      - Refresh materialized views
#   3. ELO CALCULATION - Update power ratings in teams_v2
#   4. PREDICTION SCORING - Score user predictions
#
# Runtime: ~30-45 minutes total
# =============================================================================

on:
  schedule:
    # Run daily at 6 AM UTC (1 AM EST / midnight CST)
    - cron: "0 6 * * *"
  workflow_dispatch:
    inputs:
      sync_type:
        description: "Type of sync to run"
        required: true
        default: "full"
        type: choice
        options:
          - full
          - gotsport_only
          - heartland_only
          - validation_only
          - elo_only
          - scoring_only

env:
  NODE_VERSION: "20"

jobs:
  # ============================================================================
  # PHASE 1: DATA COLLECTION (Parallel) - All write to staging_games
  # ============================================================================

  sync-gotsport:
    name: "ðŸ“Š GotSport Events"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == 'gotsport_only' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 60
    outputs:
      matches_staged: ${{ steps.sync.outputs.matches_staged }}
      status: ${{ steps.sync.outcome }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Sync Active GotSport Events (to staging)
        id: sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node scripts/daily/syncActiveEvents.js 2>&1 | tee sync_output.txt
          # Extract staged match count from output
          MATCHES=$(grep -oP 'Staged \K\d+' sync_output.txt | tail -1 || echo "0")
          echo "matches_staged=$MATCHES" >> $GITHUB_OUTPUT
        timeout-minutes: 45

  sync-heartland-puppeteer:
    name: "ðŸˆ Heartland (Puppeteer)"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == 'heartland_only' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 90
    outputs:
      htgsports_staged: ${{ steps.htgsports.outputs.matches }}
      league_staged: ${{ steps.league.outputs.matches }}
      status: ${{ job.status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Puppeteer browsers
        run: npx puppeteer browsers install chrome

      - name: Sync HTGSports Tournaments (to staging)
        id: htgsports
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node scripts/scrapers/scrapeHTGSports.js --active-only 2>&1 | tee htg_output.txt || true
          MATCHES=$(grep -oP 'Staged: \K\d+' htg_output.txt | tail -1 || echo "0")
          echo "matches=$MATCHES" >> $GITHUB_OUTPUT
        timeout-minutes: 45
        continue-on-error: true

      - name: Sync Heartland League Calendar (to staging)
        id: league
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node scripts/scrapers/scrapeHeartlandLeague.js --active-only 2>&1 | tee league_output.txt || true
          MATCHES=$(grep -oP 'Staged: \K\d+' league_output.txt | tail -1 || echo "0")
          echo "matches=$MATCHES" >> $GITHUB_OUTPUT
        timeout-minutes: 30
        continue-on-error: true

  sync-heartland-results:
    name: "ðŸ“‹ Heartland Results (Scores)"
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.inputs.sync_type == 'full' ||
        github.event.inputs.sync_type == 'heartland_only' ||
        github.event.inputs.sync_type == null
      }}
    timeout-minutes: 30
    outputs:
      matches_staged: ${{ steps.results.outputs.matches }}
      status: ${{ steps.results.outcome }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Scrape Heartland Results (to staging)
        id: results
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node scripts/scrapers/scrapeHeartlandResults.js 2>&1 | tee results_output.txt
          MATCHES=$(grep -oP 'Staged \K\d+' results_output.txt | tail -1 || echo "0")
          echo "matches=$MATCHES" >> $GITHUB_OUTPUT
        timeout-minutes: 20

  # ============================================================================
  # PHASE 2: VALIDATION PIPELINE (After all data collected)
  # Process staging_games -> matches_v2, create/link teams, refresh views
  # ============================================================================

  validation-pipeline:
    name: "ðŸ”„ Validation Pipeline"
    runs-on: ubuntu-latest
    needs: [sync-gotsport, sync-heartland-puppeteer, sync-heartland-results]
    if: >-
      ${{
        always() &&
        (github.event.inputs.sync_type == 'full' ||
         github.event.inputs.sync_type == 'validation_only' ||
         github.event.inputs.sync_type == null) &&
        (needs.sync-gotsport.result == 'success' ||
         needs.sync-gotsport.result == 'skipped') &&
        (needs.sync-heartland-puppeteer.result == 'success' ||
         needs.sync-heartland-puppeteer.result == 'skipped' ||
         needs.sync-heartland-puppeteer.result == 'failure') &&
        (needs.sync-heartland-results.result == 'success' ||
         needs.sync-heartland-results.result == 'skipped')
      }}
    timeout-minutes: 45
    outputs:
      matches_validated: ${{ steps.validate.outputs.matches }}
      teams_created: ${{ steps.validate.outputs.teams }}
      views_refreshed: ${{ steps.validate.outputs.views }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Validation Pipeline
        id: validate
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node scripts/daily/validationPipeline.js --refresh-views 2>&1 | tee validate_output.txt
          MATCHES=$(grep -oP 'Matches validated: \K\d+' validate_output.txt | tail -1 || echo "0")
          TEAMS=$(grep -oP 'Teams created: \K\d+' validate_output.txt | tail -1 || echo "0")
          VIEWS=$(grep -oP 'Views refreshed' validate_output.txt && echo "yes" || echo "no")
          echo "matches=$MATCHES" >> $GITHUB_OUTPUT
          echo "teams=$TEAMS" >> $GITHUB_OUTPUT
          echo "views=$VIEWS" >> $GITHUB_OUTPUT
        timeout-minutes: 40

  # ============================================================================
  # PHASE 3: ELO CALCULATION (Uses matches_v2)
  # ============================================================================

  recalculate-elo:
    name: "ðŸ“ˆ Recalculate ELO"
    runs-on: ubuntu-latest
    needs: validation-pipeline
    if: >-
      ${{
        always() &&
        (github.event.inputs.sync_type == 'full' ||
         github.event.inputs.sync_type == 'elo_only' ||
         github.event.inputs.sync_type == null) &&
        (needs.validation-pipeline.result == 'success' ||
         needs.validation-pipeline.result == 'skipped')
      }}
    timeout-minutes: 30
    outputs:
      teams_rated: ${{ steps.elo.outputs.teams }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Recalculate ELO Ratings
        id: elo
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node scripts/daily/recalculate_elo_v2.js 2>&1 | tee elo_output.txt
          TEAMS=$(grep -oP 'Teams with ELO: \K\d+' elo_output.txt | tail -1 || echo "0")
          echo "teams=$TEAMS" >> $GITHUB_OUTPUT
        timeout-minutes: 20

  # ============================================================================
  # PHASE 4: PREDICTION SCORING
  # ============================================================================

  score-predictions:
    name: "ðŸŽ¯ Score Predictions"
    runs-on: ubuntu-latest
    needs: recalculate-elo
    if: >-
      ${{
        always() &&
        (github.event.inputs.sync_type == 'full' ||
         github.event.inputs.sync_type == 'scoring_only' ||
         github.event.inputs.sync_type == null) &&
        (needs.recalculate-elo.result == 'success' ||
         needs.recalculate-elo.result == 'skipped')
      }}
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Score Pending Predictions
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: node scripts/daily/scorePredictions.js
        timeout-minutes: 10

  # ============================================================================
  # PHASE 5: REFRESH VIEWS (Final step - ensure app data is current)
  # ============================================================================

  refresh-views:
    name: "ðŸ”„ Refresh App Views"
    runs-on: ubuntu-latest
    needs: [recalculate-elo, score-predictions]
    if: >-
      ${{
        always() &&
        (github.event.inputs.sync_type == 'full' ||
         github.event.inputs.sync_type == null) &&
        (needs.recalculate-elo.result == 'success' ||
         needs.recalculate-elo.result == 'skipped')
      }}
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Refresh Materialized Views
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);
          (async () => {
            console.log('Refreshing materialized views...');
            const { error } = await supabase.rpc('refresh_app_views');
            if (error) {
              console.error('Error:', error.message);
              process.exit(1);
            }
            console.log('Views refreshed successfully');
          })();
          "
        timeout-minutes: 10

  # ============================================================================
  # SUMMARY & REPORTING
  # ============================================================================

  summary:
    name: "ðŸ“Š Generate Summary"
    runs-on: ubuntu-latest
    needs:
      - sync-gotsport
      - sync-heartland-puppeteer
      - sync-heartland-results
      - validation-pipeline
      - recalculate-elo
      - score-predictions
      - refresh-views
    if: always()

    steps:
      - name: Generate Pipeline Summary
        run: |
          echo "# ðŸ† SoccerView Daily Data Sync (V2)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }} | **Triggered:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“Š Phase 1: Data Collection (Staging)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Source | Status | Matches Staged |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| GotSport Events | ${{ needs.sync-gotsport.result || 'â­ï¸ skipped' }} | ${{ needs.sync-gotsport.outputs.matches_staged || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| HTGSports | ${{ needs.sync-heartland-puppeteer.result || 'â­ï¸ skipped' }} | ${{ needs.sync-heartland-puppeteer.outputs.htgsports_staged || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Heartland League | ${{ needs.sync-heartland-puppeteer.result || 'â­ï¸ skipped' }} | ${{ needs.sync-heartland-puppeteer.outputs.league_staged || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Heartland Results | ${{ needs.sync-heartland-results.result || 'â­ï¸ skipped' }} | ${{ needs.sync-heartland-results.outputs.matches_staged || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ”„ Phase 2: Validation Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.validation-pipeline.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Matches Validated | ${{ needs.validation-pipeline.outputs.matches_validated || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Teams Created | ${{ needs.validation-pipeline.outputs.teams_created || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“ˆ Phase 3-5: Processing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Recalculate ELO | ${{ needs.recalculate-elo.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Score Predictions | ${{ needs.score-predictions.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Refresh Views | ${{ needs.refresh-views.result || 'â­ï¸ skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ needs.sync-gotsport.result }}" == "failure" ]] || \
             [[ "${{ needs.validation-pipeline.result }}" == "failure" ]] || \
             [[ "${{ needs.recalculate-elo.result }}" == "failure" ]]; then
            echo "## âš ï¸ Pipeline completed with errors" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Pipeline completed successfully" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*V2 Architecture: staging_games â†’ matches_v2 â†’ app_* views*" >> $GITHUB_STEP_SUMMARY
