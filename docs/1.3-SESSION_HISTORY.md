# SoccerView Session History

> **Last Updated:** February 4, 2026 | Session 87.2 Complete
>
> This document archives the detailed session history from the SoccerView project.
> For current project status, see [CLAUDE.md](../CLAUDE.md).
> **ðŸš¨ Read [GUARDRAILS](1.1-GUARDRAILS_v2.md) before starting work.**
> **ðŸ“‹ For data issues, see [DATA_ISSUE_PROTOCOL](DATA_ISSUE_PROTOCOL.md).**

---

## Project Phases Overview

| Phase | Focus | Status | Sessions |
|-------|-------|--------|----------|
| Phase 0-4 | MVP Development | âœ… Complete | 1-33 |
| Phase 5 | QC Testing (24 issues) | âœ… Complete | 34 |
| Phase 6 | Performance Optimization | âœ… Complete | 35-37 |
| Phase 7 | UX & Infrastructure | âœ… Complete | 38-44 |
| Database Restructure | V2 Architecture | âœ… Complete | 48-50 |
| Data Integrity | V2 QC & Optimization | âœ… Complete | 51-56 |
| Universal Pipeline | Source-Agnostic Framework | âœ… Complete | 57 |
| DevOps & Security | GitHub Actions + RLS | âœ… Complete | 58 |
| Data Quality | Duplicate League Fix | âœ… Complete | 59 |
| Universal Data Quality | Pipeline Integration | âœ… Complete | 60 |
| Data Integrity | Alphanumeric Team ID Fix | âœ… Complete | 61 |
| Canonical Registries | Self-Learning System | âœ… Complete | 62 |
| Universal Discovery | Adaptive Learning Infra | âœ… Complete | 63 |
| Adaptive Learning | Pipeline Integration | âœ… Complete | 64 |
| UI/UX | Ranking Journey Chart Fix | âœ… Complete | 65 |
| UI/UX | V1â†’V2 UI Migration Fix | âœ… Complete | 66 |
| UI/UX | Team Details UI Refinements | âœ… Complete | 67 |
| UI/UX | Rating Journey Chart Redesign | âœ… Complete | 68 |
| Infrastructure | Index Maintenance + Backlog Clear | âœ… Complete | 69 |
| Ranking Algorithm | Consistent Baseline Methodology | âœ… Complete | 70 |
| UI/UX | Compare Chart Fix | âœ… Complete | 71 |
| Data Integrity | NULL Score Fix | âœ… Complete | 72 |
| UI/UX | VS Battle Page Fixes | âœ… Complete | 73 |
| Data Integrity | HTGSports Division Detection Fix | âœ… Complete | 74 |
| Data Integrity | Real-Time Data Consistency Fix | âœ… Complete | 75 |
| Data Integrity | GotSport Rankings Bypass Fix | âœ… Complete | 76 |
| Data Integrity | NULL Metadata & Orphan Merge | âœ… Complete | 77 |
| Data Integrity | Orphan Root Cause Analysis | âœ… Complete | 78 |
| V2 Architecture | Pipeline Enforcement & Docs | âœ… Complete | 79 |
| V2 Architecture | Git Hygiene & Heartland Gap ID | âœ… Complete | 80 |
| Infrastructure | Pipeline Reliability & Unified Adapter | âœ… Complete | 81 |
| V2 Migration | V1 Archive Migration to V2 | âœ… Complete | 82 |
| Data Quality | Complete V1 Extraction & Foundation First | âœ… Complete | 83 |
| Data Policy | Premier-Only Data Policy | âœ… Complete | 84 |
| Data Architecture | Universal SoccerView ID Architecture | âœ… Complete | 85 |
| Data Recovery | Match Recovery & Soft Delete Pattern | âœ… Complete | 86 |
| Data Quality | Universal Canonical Resolver & Gender Fix | âœ… Complete | 87 |
| Data Pipeline | HTGSports Scraping + Pipeline Fixes | âœ… Complete | 87.2 |

---

## Session 87.2 - HTGSports Scraping + Pipeline Fixes (February 4, 2026) - COMPLETE

**Focus:** Complete HTGSports scraping, fix staging pipeline constraints, create universal bulk processor.

### Problem Statement

- `staging_games.source_match_key` had NO unique constraint, only a non-unique index
- `coreScraper.js` `ON CONFLICT (source_match_key) DO NOTHING` silently failed without unique constraint
- 87,638 duplicate staging rows existed (26,787 groups)
- `dataQualityEngine.js` too slow for bulk processing (3+ DB round trips per record)
- Heartland CGI endpoints dead between seasons (Feb 2026)

### Solution

1. **Fixed staging constraint:** Deleted 87,638 duplicates, added `UNIQUE (source_match_key)` to `staging_games`
2. **Created `fastProcessStaging.cjs`:** Universal bulk processor - 7,200 matches in 30 seconds vs DQE's 0 in 10 minutes
3. **Updated Heartland adapter (v5.0):** Detects between-season state, exits in seconds
4. **Fixed `verifyDataIntegrity.js`:** Checks 1 & 2 now filter `deleted_at IS NULL`
5. **Ran HTGSports scraper:** Processed all available tournament data

### Key Changes

**1. Staging Games Unique Constraint**
```sql
-- Delete duplicates first (keep earliest)
DELETE FROM staging_games WHERE id NOT IN (
  SELECT MIN(id) FROM staging_games GROUP BY source_match_key
);
-- Add constraint
ALTER TABLE staging_games ADD CONSTRAINT staging_games_source_match_key_unique
  UNIQUE (source_match_key);
```

**2. Fast Process Staging (`fastProcessStaging.cjs`)**
- Uses dedicated client (not pool) for pipeline auth session variables
- Bulk team resolution + bulk match insert + batch deduplication
- Universal: works for any `source_platform` via `--source` flag
- 240x faster than DQE for bulk processing

**3. Heartland v5.0 Between-Season Detection**
- `subdiv_results.cgi`: DEAD (301 â†’ www â†’ 404)
- `subdiv_standings.cgi`: ALIVE but empty between seasons
- `team_results.cgi`: ALIVE (returns real data)
- Adapter now detects empty responses and exits gracefully

### Results

| Metric | Before | After |
|--------|--------|-------|
| staging_games duplicates | 87,638 | 0 |
| Staging constraint | Non-unique index | UNIQUE |
| Unprocessed staging | 7,200+ | 0 |
| matches_v2 (active) | ~408K | 410,319 |
| Semantic duplicates | Unknown | 0 |
| Duplicate source_match_keys | Unknown | 0 |

### Files Created/Modified

| File | Change |
|------|--------|
| `scripts/maintenance/fastProcessStaging.cjs` | NEW - Universal bulk staging processor |
| `scripts/maintenance/fastProcessHTG.cjs` | NEW - HTGSports-specific fast processor |
| `scripts/adapters/heartland.js` | MODIFIED - v5.0, between-season detection |
| `scripts/daily/verifyDataIntegrity.js` | MODIFIED - Filter deleted_at IS NULL |
| `scripts/universal/coreScraper.js` | MODIFIED - pg Pool for writes |

---

## Session 87 - Universal Canonical Resolver & Gender Fix (February 4, 2026) - COMPLETE

**Focus:** Fix cross-gender team merging bug in `teamDedup.js` and create universal canonical resolver.

### Problem Statement

- `teamDedup.js` was merging teams across genders (Boys team merged with Girls team)
- Fuzzy matching on team name alone without constraining on exact-match fields (birth_year, gender)
- 306 teams incorrectly merged in Session 86

### Solution

1. **Fixed `teamDedup.js`:** Added gender and birth_year as exact-match constraints before fuzzy name matching
2. **Created `canonicalResolver.js`:** Universal entity resolution with configurable exact-match and fuzzy-match fields
3. **Unmerged 306 incorrectly merged teams**

### Key Principle

**Fuzzy matching MUST be constrained by exact-match fields:**
```javascript
// âŒ WRONG - Fuzzy match on name alone
findSimilar(teamName)  // Could match "FC Dallas 2014 Boys" with "FC Dallas 2014 Girls"

// âœ… CORRECT - Exact match on gender+birth_year, THEN fuzzy on name
findSimilar(teamName, { gender: 'M', birth_year: 2014 })
```

### Files Created/Modified

| File | Change |
|------|--------|
| `scripts/universal/deduplication/teamDedup.js` | MODIFIED - Gender constraint |
| `scripts/universal/deduplication/matchDedup.js` | MODIFIED - Soft delete pattern |

---

## Session 86 - Match Recovery & Soft Delete Architecture (February 4, 2026) - COMPLETE

**Focus:** Recover matches lost from Session 85's hard-delete deduplication and implement soft-delete architecture.

### Problem Statement

- Session 85 changed match uniqueness from `source_match_key` to `(match_date, home_team_id, away_team_id)`
- `matchDedup.js` hard-deleted 9,160 matches as "duplicates"
- These were NOT duplicates - they were the same real-world match from different sources
- ALL match history disappeared from Team Details pages

### Solution

1. **Recovered 6,053 matches from `audit_log`** using `recoverSession85Matches.cjs`
2. **Added soft-delete columns** to `matches_v2`: `deleted_at` (TIMESTAMPTZ), `deletion_reason` (TEXT)
3. **Updated `matchDedup.js`** to use `UPDATE SET deleted_at = NOW()` instead of `DELETE`
4. **Ran semantic deduplication** with soft delete: 1,660 true duplicates soft-deleted
5. **Recalculated ELO:** 192,689 matches processed, 60,864 teams rated (range 1157-1781)
6. **Refreshed all views** via `scripts/refresh_views_manual.js`

### Key Architecture Change

```sql
-- Migration 086: Add soft-delete to matches_v2
ALTER TABLE matches_v2 ADD COLUMN deleted_at TIMESTAMPTZ DEFAULT NULL;
ALTER TABLE matches_v2 ADD COLUMN deletion_reason TEXT DEFAULT NULL;

-- In all queries:
SELECT * FROM matches_v2 WHERE deleted_at IS NULL;  -- Active matches only
```

### Results

| Metric | Before (S85 damage) | After Recovery |
|--------|---------------------|----------------|
| Active matches | ~401K | 410,319 |
| Recovered from audit_log | - | 6,053 |
| Soft-deleted duplicates | - | 1,660 |
| ELO-rated teams | - | 60,864 |
| ELO-rated matches | - | 192,689 |

### Files Created/Modified

| File | Change |
|------|--------|
| `scripts/migrations/086_add_soft_delete_matches.sql` | NEW - Soft delete columns |
| `scripts/maintenance/recoverSession85Matches.cjs` | NEW - Audit log recovery |
| `scripts/maintenance/recoverDeletedMatches.cjs` | NEW - General recovery tool |
| `scripts/maintenance/analyzeDeletedMatches.cjs` | NEW - Deletion analysis |
| `scripts/universal/deduplication/matchDedup.js` | MODIFIED - Soft delete |
| `scripts/maintenance/bulkMergeDuplicateTeams.cjs` | NEW - Bulk team merger |
| `docs/CANONICAL_RESOLUTION_STRATEGY.md` | NEW - Entity resolution methodology |

---

## Session 85 - Universal SoccerView ID Architecture (February 4, 2026) - COMPLETE

**Focus:** Align `matches_v2` uniqueness with SoccerView ID strategy to eliminate duplicates.

### Problem Statement

- Team Details page showed duplicate matches (same game appearing 2+ times)
- Season Stats were inflated (W-L-D counts too high)
- ELO ratings were skewed by counting same match multiple times
- Root cause: `source_match_key` uniqueness allowed same match from different sources

### Solution

Changed match uniqueness from source-specific (`source_match_key`) to semantic using SoccerView Team IDs:

```sql
-- NEW constraint (Session 85)
UNIQUE (match_date, home_team_id, away_team_id)

-- OLD constraint (dropped)
UNIQUE (source_match_key)
```

### Execution Summary

| Phase | Task | Result |
|-------|------|--------|
| 1 | Diagnose duplicates | 6,053 duplicate groups, 8,959 extra records |
| 2 | Fix existing duplicates | 8,251 duplicates removed, 6,053 kept |
| 3 | Add semantic constraint | Migration 085 applied |
| 4 | Update pipeline | dataQualityEngine.js ON CONFLICT updated |
| 5 | Update verification | verifyDataIntegrity.js semantic check added |
| 6 | Audit workflows | No changes needed (already use dataQualityEngine) |
| 7 | Recalculate ELO | 192,643 matches processed, 60,964 teams updated |
| 8 | Update documentation | CLAUDE.md, GUARDRAILS, ARCHITECTURE, SESSION_HISTORY |

### Key Changes

**1. New Database Constraint**
```sql
ALTER TABLE matches_v2 DROP CONSTRAINT IF EXISTS matches_v2_source_match_key_unique;
ALTER TABLE matches_v2 ADD CONSTRAINT unique_match_semantic
  UNIQUE (match_date, home_team_id, away_team_id);
```

**2. Pipeline ON CONFLICT Update (`dataQualityEngine.js`)**
```sql
ON CONFLICT (match_date, home_team_id, away_team_id) DO UPDATE SET
  home_score = CASE WHEN matches_v2.home_score IS NOT NULL THEN matches_v2.home_score ELSE EXCLUDED.home_score END,
  -- Preserves existing scores, fills in missing data
```

**3. Deduplication Logic (`matchDedup.js`)**
- Changed from "strong match" (included scores) to semantic grouping (date + team IDs only)
- Priority for keeping: scored > linked to event > earliest created

**4. Verification Check (`verifyDataIntegrity.js`)**
- Added `checkSemanticDuplicates()` function
- Reports any matches that share (date, home_team_id, away_team_id)

### Files Created/Modified

| File | Change |
|------|--------|
| `scripts/migrations/085_add_semantic_match_constraint.sql` | NEW - Migration SQL |
| `scripts/migrations/run_migration_085.js` | NEW - Migration runner |
| `scripts/universal/dataQualityEngine.js` | MODIFIED - ON CONFLICT clause |
| `scripts/universal/deduplication/matchDedup.js` | MODIFIED - Semantic grouping |
| `scripts/daily/verifyDataIntegrity.js` | MODIFIED - Semantic duplicate check |
| `docs/SESSION_85_SOCCERVIEW_ID_CHECKLIST.md` | NEW - Execution checklist |
| `CLAUDE.md` | MODIFIED - Principle 29 added |
| `docs/1.1-GUARDRAILS_v2.md` | MODIFIED - Match uniqueness rule |
| `docs/1.2-ARCHITECTURE.md` | MODIFIED - Constraint documentation |

### Architecture After Implementation

| Entity | Uniqueness Strategy | Uses SoccerView IDs? |
|--------|--------------------|--------------------|
| Teams | canonical_teams â†’ team_v2_id | âœ… |
| Clubs | canonical_clubs â†’ club_id | âœ… |
| Leagues | canonical_events â†’ league_id | âœ… |
| Tournaments | canonical_events â†’ tournament_id | âœ… |
| Schedules | (date, home_team_id, away_team_id) | âœ… |
| **Matches** | **(date, home_team_id, away_team_id)** | âœ… **FIXED** |

**Result:** ALL entities now use SoccerView IDs as their uniqueness anchor.

---

## Session 81 - Pipeline Reliability & Unified Heartland Adapter (February 3, 2026) - COMPLETE

**Focus:** Fix validation pipeline reliability issues and unify Heartland adapter.

### Problem Statement

- Validation pipeline crashed after ~30 minutes with `Connection terminated unexpectedly`
- Heartland adapter only covered CGI results, not calendar schedules
- Adaptive learning API failures (Cloudflare 500 errors) caused cascading failures

### Completed

| Task | Deliverable |
|------|-------------|
| Unified Heartland adapter | `scripts/adapters/heartland.js` v2.0 (CGI + Calendar) |
| Pipeline reliability | Circuit breaker, retry logic, pool error handler |
| Column fix | Removed `updated_at` from `matches_v2` UPDATE |
| Validation test | **24m 9s** success (vs 30m+ failure before) |

### Key Changes

**1. Unified Heartland Adapter (`scripts/adapters/heartland.js` v2.0)**
- Single adapter handles both data sources
- CGI Results (Cheerio): `heartland-premier-2026`, `heartland-recreational-2026`
- Calendar (Puppeteer): `heartland-calendar-2026`
- Routes via `event.level` property in `scrapeEvent()`

**2. Pipeline Reliability (`dataQualityEngine.js`)**
- Pool-level error handler prevents unhandled crashes
- `refreshViewsWithRetry()` with 3 retries, exponential backoff (5s, 15s, 30s)
- Fresh connections for each retry attempt
- 10-minute statement_timeout at pool level

**3. Circuit Breaker (`adaptiveLearning.js`)**
- Opens after 5 consecutive failures
- Resets after 60 seconds
- Limits error logging to first 3 failures
- Prevents Supabase/Cloudflare issues from cascading

### Commits

| Commit | Description |
|--------|-------------|
| `396f8f9` | Unify Heartland adapter with CGI + Calendar scraping |
| `ac01b45` | Fix validation pipeline reliability issues |
| `df5ec21` | Fix updated_at column reference + adapter cleanup |

---

## Session 80 - Heartland Data Coverage Gap (February 3, 2026) - COMPLETE

**Focus:** Identify and document Heartland data coverage gap; establish Git hygiene protocol.

### Completed

- âœ… Fixed ECONNRESET in view refresh (`scripts/refresh_views_manual.js`)
- âœ… Committed 380 V2 architecture files (commit `4e6ea74`)
- âœ… Added Git Hygiene Protocol to governance docs (GUARDRAILS Â§15, CLAUDE.md Principle 26)
- âœ… Added Project Tools & Integrations section to CLAUDE.md
- âœ… Identified Heartland calendar adapter gap (fixed in Session 81)

### Git Hygiene Protocol (CLAUDE.md Principle 26)

| Trigger | Action |
|---------|--------|
| Task completed | Commit with descriptive message |
| 10+ uncommitted files | Warn user, offer to commit |
| End of session | ALWAYS commit and push |
| Start of session | Check `git status` for uncommitted work |

---

## Session 79 - V2 Architecture Enforcement (February 2-3, 2026) - COMPLETE

**Focus:** Build a scalable, repeatable system that enforces ONE entry point and ONE processing path for all data.

### Problem Statement

- 48+ scripts could write to the database
- Multiple paths to production (validationPipeline, dataQualityEngine, batchProcessStaging, direct writes)
- No intake validation (garbage data enters staging)
- No integrity verification (issues caught by users, not system)

### Completed Phases

| Phase | Description | Deliverables |
|-------|-------------|--------------|
| Phase 1 | Intake Validation Gate | `intakeValidator.js` - rejects garbage BEFORE staging |
| Phase 2 | Consolidate to ONE Processor | Archived legacy processors, updated GitHub Actions |
| Phase 3 | Block Direct Writes | Database triggers on teams_v2/matches_v2 |
| Phase 4 | Integrity Verification | `verifyDataIntegrity.js` - automated post-processing checks |

### Key Files Created

| File | Purpose |
|------|---------|
| `scripts/universal/intakeValidator.js` | Pre-staging validation gate |
| `scripts/daily/verifyDataIntegrity.js` | Post-processing integrity checks |
| `scripts/migrations/070_create_write_protection_triggers.sql` | Write protection triggers |
| `scripts/universal/pipelineAuth.js` | Authorization helper module |
| `docs/DATA_ISSUE_PROTOCOL.md` | Standard prompt template for data issues |

### Pipeline Enforcement

```
Scrapers â†’ staging_games â†’ intakeValidator â†’ dataQualityEngine â†’ production
                              â†“ (garbage)
                         staging_rejected
```

### Additional Work

- Created DATA_ISSUE_PROTOCOL.md with copy-paste prompt template
- Documentation optimization plan created
- Cleaned 876 duplicate canonical entries

---

## Session 78 - Orphan Root Cause Analysis (February 2, 2026) - COMPLETE

**Focus:** Universal fix for 16,823 orphan teams showing 0W-0L-0D.

### Key Finding: Orphans Are Coverage Gaps, NOT Duplicates

**Initial Approach (WRONG - Abandoned):**
Attempted aggressive fuzzy matching to merge orphans with teams that have matches.

**Why This Was Wrong:**
- "2014B" = birth year 2014 = U12 in 2026
- "15" = birth year 2015 = U11 in 2026
- These are DIFFERENT TEAMS in DIFFERENT AGE GROUPS!

### Root Cause: Data Coverage Gaps

| State | Coverage Rate | Orphan Rate |
|-------|---------------|-------------|
| Georgia | 20.2% | 80% orphans |
| South Carolina | 21.2% | 79% orphans |
| North Carolina | 22.3% | 78% orphans |
| Kansas | 83.4% | 17% orphans |
| Texas | 86.5% | 14% orphans |

States with low coverage contribute the most orphans. Merging won't fix this - need to expand data coverage.

### New Principle Established (Principle 24)

**Orphans Are Coverage Gaps - NOT Duplicates**
- Teams with GotSport points but 0 matches are playing in leagues we don't scrape
- Aggressive merging based on similar names is DANGEROUS
- Birth year differences CANNOT be ignored (different age groups)

### Correct Fix Strategy

1. **Expand coverage** - Add scrapers for states with <50% coverage
2. **Fix birth_year inconsistencies** - Only where name is internally consistent
3. **Accept some orphans** - Until coverage improves, some teams will remain orphans

---

## Session 77 - NULL Metadata & Orphan Merge Fix (February 2, 2026) - COMPLETE

**Focus:** Fix teams with GotSport points still showing 0W-0L-0D after Session 76 fixes.

### Root Causes Identified

1. **NULL Metadata:** Teams with matches had NULL birth_year/gender, preventing deduplication matching
2. **Multiple Duplicate Entries:** Same team existed under different names/states
3. **Suffix Mismatch:** Orphan names had "(U11 Boys)" suffix, match-having teams didn't

### 3-Phase Fix Applied

| Phase | Action | Result |
|-------|--------|--------|
| Phase 1 | Fix NULL birth_year/gender using V2 normalizer | 10,571 teams fixed |
| Phase 2 | Merge orphans with match-having counterparts | 1,707 orphans merged |
| Phase 3 | Recalculate team stats | 16 teams updated |

### Final Data State

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| Total teams | 150,101 | **148,391** | -1,710 |
| NULL birth_year | 17,182 | **3,288** | -13,894 |
| NULL gender | 15,703 | **6,320** | -9,383 |
| Orphans (GS pts, no matches) | 18,531 | **16,823** | -1,708 |

### Key Script Created

`scripts/maintenance/fixNullMetadataAndMerge.cjs` - 3-phase fix: normalize â†’ merge â†’ stats

### Key Learning

Teams with NULL metadata can't be matched during deduplication. Phase 1 (fix NULL metadata) must complete BEFORE Phase 2 (merge orphans).

---

## Session 76 - GotSport Rankings Bypass Fix (February 2, 2026) - COMPLETE

**Focus:** Fix teams appearing in rankings with 0 matches, 0W-0L-0D.

### Root Cause Identified

GotSport rankings scraper (`scripts/_archive/scrape_gotsport_rankings.js`) wrote DIRECTLY to `teams_v2`, bypassing:
1. Staging tables
2. V2 normalizers (didn't remove duplicate prefixes like "One FC One FC")
3. Canonical registries (didn't register teams for deduplication)

This created 57,532 orphaned teams with GS rank but no matches.

### Fixes Applied (Using V2 Architecture)

| Phase | Fix | Count | Speed |
|-------|-----|-------|-------|
| 1 | Team stats recalculated from matches_v2 | 42,674 | 1,215/sec |
| 2 | Birth year mismatches fixed | 25,659 | 1,271/sec |
| 3 | Exact-name duplicates merged | 11 | â€” |
| 4 | Canonical teams registry populated | **+118,977** | **11,000/sec** |
| 5 | Orphans merged via normalizer logic | **3,751** | 38/sec |
| Prior | Fuzzy-match merges | 1,756 | â€” |

### Key Discovery: Canonical Registry Was Empty

The canonical_teams registry only had 19,275 entries for 155,608 teams (12% coverage). This meant the V2 deduplication architecture was effectively broken.

**Fix:** `populateCanonicalTeams.cjs` added 118,977 entries in 10.8 seconds.

### Final Data State

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| Total teams | 155,608 | **150,101** | -5,507 |
| GS-ranked WITH matches | 63,556 | **64,874** | +1,318 |
| Orphaned (GS rank, no matches) | 57,532 | **52,025** | -5,507 |
| Canonical teams registry | 19,275 | **138,252** | +118,977 |

### Key Scripts Created

| Script | Purpose | Speed |
|--------|---------|-------|
| `populateCanonicalTeams.cjs` | Seed canonical_teams from teams_v2 | 11K/sec |
| `mergeOrphansByNormalizedName.cjs` | Merge orphans using normalizer logic | 38/sec |
| `fixDataDisconnect.cjs` | Recalc stats + fix birth_year + merge dupes | 1.2K/sec |

### GUARDRAILS Created

Created [GUARDRAILS](1.1-GUARDRAILS_v2.md) v1.1 with:
- Canonical registry health check requirement
- Speed optimization patterns with benchmarks
- Duplicate prefix detection SQL patterns
- Root cause pattern documentation

### Files Modified

- [GUARDRAILS](1.1-GUARDRAILS_v2.md) - NEW: Mandatory pre-flight checklist
- [CLAUDE.md](../CLAUDE.md) - Added GUARDRAILS reference, Session 76 entry
- New maintenance scripts in `scripts/maintenance/`

---

## Session 75 - Real-Time Data Consistency Fix (February 2, 2026) - COMPLETE

**Focus:** Fix Season Stats and Power Rating not matching actual database values on Team Details page.

### Problems Identified

1. **Season Stats mismatch:** Showed 14 matches (6W-7L-1D) but Match History showed 19 matches (10W-7L-2D)
2. **Power Rating stale:** ELO 1,469, #3,689 national instead of current 1,528, #859

### Root Cause

| Component | Data Source | Issue |
|-----------|-------------|-------|
| Season Stats | `teams_v2.matches_played` | Pre-computed by ELO script (STALE) |
| Match History | `matches_v2` direct query | Real-time (CURRENT) |
| Power Rating | `app_team_profile` view | Depends on view refresh (STALE) |

- ELO script hadn't run since Jan 30, 2026
- 269,534 matches added since then
- Materialized view refresh was delayed

### Universal Fix (Layer 3 - Presentation)

Changed `app/team/[id].tsx` to query source tables directly:

1. **Season Stats** - Query `matches_v2` directly (not pre-computed values)
2. **Power Rating** - Query `teams_v2` directly (bypass stale view)

### Three-Layer Verification

| Layer | Component | Status |
|-------|-----------|--------|
| Layer 1 (Intake) | Scrapers | âœ… Correctly insert to staging |
| Layer 2 (Processing) | ELO Script | âœ… Ran manually, updated teams_v2 |
| Layer 3 (Presentation) | App | âœ… **FIXED** - Queries source tables |

### Results

| Metric | Before | After |
|--------|--------|-------|
| Season Stats | 14mp, 6W-7L-1D | **19mp, 10W-7L-2D** |
| ELO Rating | 1,469 | **1,528** |
| National Rank | #3,689 | **#859** â¬†ï¸ 2,830 spots |
| State Rank | #57 | **#10** â¬†ï¸ 47 spots |

### New Principle

**Principle 23:** Real-Time Data for Team Details - Never Trust Pre-Computed Values

### Files Modified

- `app/team/[id].tsx` - Real-time queries for Season Stats + Power Rating
- `CLAUDE.md` - Added Principle 23, Session 75 entry

---

## Session 74 - HTGSports Division Detection Fix (February 2, 2026) - COMPLETE

**Focus:** Fix HTGSports scraper missing 37 of 38 divisions in Sporting Classic 2025 tournament.

### Problem

User reported "Sporting BV Pre-NAL 15 (U11 Boys)" team was missing Sporting Classic 2025 tournament matches. Investigation revealed the HTGSports scraper was only finding 1 division when 38 existed.

### Root Cause

The `divisionPattern` regex in `scripts/adapters/htgsports.js` required a hyphen in age groups:

```javascript
// BUG: Regex required "U-11" but site used "U11" (no dash)
divisionPattern: /U-\d+|2017|2016|.../i
```

The HTGSports site uses formats like "Girls U09 Gold", "Boys U11 Gold" (no dash), but the regex only matched "U-11" (with dash).

### Fix Applied

```javascript
// FIXED: Made dash optional with U-?
divisionPattern: /U-?\d{1,2}\b|20[01]\d/i
```

Changed in 3 locations within htgsports.js:
- Line 77: Config `divisionPattern`
- Line 345: `filter()` for division dropdown options
- Line 375: `some()` check for identifying division dropdown

### Results

| Metric | Before | After |
|--------|--------|-------|
| Divisions found | 1 | **38** |
| Matches scraped | ~10 | **336** |
| Matches processed | 0 | **335** |

### Additional Fixes

| Issue | Fix |
|-------|-----|
| Duplicate staging records | Deleted 4 duplicates causing batch insert failure |
| Team name mismatch | Merged "SBV Pre-NAL 15" â†’ canonical "Sporting BV Pre-NAL 15" |
| Checkpoint logic | Only mark events processed when `matches.length > 0` |

### New Principles Added

Three new principles added to CLAUDE.md:

| Principle | Title |
|-----------|-------|
| 20 | Division Detection Regex - Universal Pattern |
| 21 | Checkpoint Logic - Only Mark Processed When Data Found |
| 22 | Team Name Variations - Same Team, Different Names |

### Files Modified

| File | Change |
|------|--------|
| `scripts/adapters/htgsports.js` | Fixed division regex pattern (3 locations) |
| `scripts/adapters/_template.js` | Updated template with correct pattern |
| `CLAUDE.md` | Added Principles 20-22, Session 74 entry |
| `docs/2-UNIVERSAL_DATA_QUALITY_SPEC.md` | Added anti-patterns 10-12 |
| `docs/3-DATA_SCRAPING_PLAYBOOK.md` | Added division detection guidance |

### Verification

- âœ… Team "Sporting BV Pre-NAL 15" now shows 4 Sporting Classic matches
- âœ… All 38 divisions scraped from tournament
- âœ… Fix is universal - works for ANY source with "U11" or "U-11" format

### Full Lifecycle Audit (All 3 Layers)

Audited the entire data architecture to ensure universal patterns flow correctly from scraping through presentation.

| Layer | Component | Pattern/Method | Status |
|-------|-----------|----------------|--------|
| **Layer 1** | htgsports.js | `/U-?\d{1,2}\b\|20[01]\d/i` | âœ… Fixed |
| **Layer 1** | _template.js | `/U-?\d{1,2}\b\|20[01]\d/i` | âœ… Correct |
| **Layer 1** | scrapeHTGSports.js | `/U-?\d{1,2}\b\|20[01]\d/i` | âœ… Fixed |
| **Layer 2** | validationPipeline.js | `/\bU[-\s]?(\d+)\b/i` | âœ… Correct |
| **Layer 2** | teamNormalizer.js | `/\bU[-\s]?(\d+)\b/i` | âœ… Correct |
| **Layer 2** | clubNormalizer.js | `/^U-?\d+$/i` | âœ… Correct |
| **Layer 2** | dataQualityEngine.js | Uses `birth_year` for matching | âœ… Correct |
| **Layer 3** | SQL views | Dynamic: `'U' \|\| (season_year - birth_year)` | âœ… Dynamic |
| **Layer 3** | App filter UI | Hardcoded U8-U19 list (appropriate) | âœ… Correct |

**Key Findings:**
1. All adapters now use universal optional-dash pattern
2. Validation layer uses `birth_year` (integer) for team matching, not `age_group` (string)
3. App views compute `age_group` dynamically from `birth_year + get_current_season_year()`
4. No hardcoded year calculations anywhere in the pipeline
5. Legacy scraper `scrapeHTGSports.js` also fixed as fallback safety

---

## Session 73 - VS Battle Page Fixes (February 2, 2026) - COMPLETE

**Focus:** Fix multiple issues on the VS Battle (Predict) page reported via user screenshots.

### Issues Fixed

| Issue | Root Cause | Fix |
|-------|------------|-----|
| Team A card missing name | `loadTeamFromParams` didn't map `display_name` to `team_name` | Added `team_name: data.display_name` transformation |
| Gender showing "M" instead of "Boys" | Raw DB value displayed | Added `GENDER_DISPLAY` conversion throughout |
| Search not returning results | Query used `team_name` but view has `display_name` | Changed to `.ilike("display_name", ...)` |
| Gender filter not defaulting | Passed DB format to modal expecting display format | Convert with `GENDER_DISPLAY` in `suggestedGender` prop |
| What If sliders not working | Incomplete useEffect dependency array | Added `showWhatIf, homeTeam, awayTeam` to dependencies |
| Team names truncated | `numberOfLines={2}` on Text components | Removed all `numberOfLines` per Principle 4 |
| State filter UX inconsistent | Different pattern than Rankings tab | Implemented type-ahead with chips |
| Analytical Factors unclear | Red/green bars had no team indicator | Added legend row showing team colors |

### Key Pattern: Gender Conversion

The app stores gender as "M"/"F" in the database but displays "Boys"/"Girls" in the UI:

```typescript
// Import centralized mappings
import { GENDER_DISPLAY, GENDER_FROM_DISPLAY, GenderType } from "../../lib/supabase.types";

// Display: DB â†’ UI
{GENDER_DISPLAY[team.gender as GenderType] ?? team.gender}

// Query filter: UI â†’ DB
const dbGender = GENDER_FROM_DISPLAY[selectedGender];
if (dbGender) dbQuery = dbQuery.eq("gender", dbGender);
```

### Analytical Factors Legend

Added a sleek legend at the top of the factors section showing which team each color represents:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸŸ¢ Team A Name   â”‚   ðŸ”´ Team B Name    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ELO Rating    [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     ]     -27%   â”‚
â”‚  Goal Diff     [           ]       0%   â”‚
â”‚  Win Rate      [â–ˆâ–ˆâ–ˆ        ]      -7%   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Files Modified

| File | Change |
|------|--------|
| `app/predict/index.tsx` | All VS Battle fixes + Analytical Factors legend |

---

## Session 72 - NULL Score Fix for Scheduled Matches (February 2, 2026) - COMPLETE

**Focus:** Fix the Upcoming section not showing scheduled matches for teams.

### Problem

User reported "Sporting BV Pre-NAL 15 (U11 Boys)" showed 0 upcoming matches despite spring games being published. Investigation revealed a critical bug affecting ALL scheduled matches.

### Root Cause

Both `validationPipeline.js` and `dataQualityEngine.js` were converting NULL scores to 0:

```javascript
// BUG (was in both files)
home_score: game.home_score ?? 0,  // NULL â†’ 0
away_score: game.away_score ?? 0,  // NULL â†’ 0
```

This made 9,210 scheduled matches appear as played 0-0 games, hiding them from the Upcoming section.

### App Logic

```javascript
// app/team/[id].tsx determines upcoming vs recent:
const hasScores = match.home_score !== null && match.away_score !== null &&
                  (match.home_score > 0 || match.away_score > 0);
// NULL scores + future date = upcoming
// 0-0 scores = appears played (wrong!)
```

### Fixes Applied

| File | Fix |
|------|-----|
| `scripts/daily/validationPipeline.js` | Remove `?? 0` fallback |
| `scripts/universal/dataQualityEngine.js` | Remove `?? 0` fallback + fix needsUpdate logic |
| `scripts/adapters/heartland.js` | Return NULL for matches without scores |
| Database schema | `ALTER TABLE matches_v2 ALTER COLUMN home_score DROP NOT NULL` |
| Database data | Updated 9,210 future 0-0 matches to NULL scores |

### Impact

- 9,210 scheduled matches now correctly appear in Upcoming section
- Future scheduled matches will be preserved with NULL scores
- Teams now show their upcoming games properly

### Documentation

Added new Principle 6b to CLAUDE.md: "NULL Scores vs 0-0 Scores"

---

## Session 71 - Compare Chart Fix (February 1, 2026) - COMPLETE

**Focus:** Fix the Compare chart in Ranking Journey to properly overlay SoccerView and GotSport ranking data.

### Problem

The Compare chart using react-native-gifted-charts failed to reliably render two overlaid lines:
- Disconnected dots from lines
- Gray/white area fills appearing unexpectedly
- Incorrect rendering on State scope
- 10+ hours of failed attempts with various configurations

### Root Cause

react-native-gifted-charts has documented issues with multi-line charts where datasets have different data ranges/lengths (GitHub issue #975). Despite fixes in v1.4.56+, rendering problems persisted with our specific use case (SoccerView has 6 months of data, GotSport has ~10 days).

### Solution

Use `react-native-chart-kit` (ChartKitLineChart) for Compare view ONLY:

| View | Library | Status |
|------|---------|--------|
| SoccerView individual | gifted-charts | âœ… Unchanged |
| GotSport individual | gifted-charts | âœ… Unchanged |
| Compare overlay | **chart-kit** | âœ… New |

### Implementation

```javascript
<ChartKitLineChart
  data={{
    labels: dateLabels,  // ~7 sampled date labels
    datasets: [
      { data: svNormalizedData, color: () => "#3B82F6", strokeWidth: 2.5 },
      { data: gsNormalizedData, color: () => "#f59e0b", strokeWidth: 3 },
    ],
  }}
  bezier
  withDots={true}
  withShadow={false}
  formatYLabel={formatCompareYLabel}
/>
```

### Universal Design

The solution follows universal principles:
- Combines dates from ANY sources dynamically
- Same normalization logic for all sources
- Same forward-fill algorithm for any dataset
- No source-specific conditionals (`if source === 'gotsport'`)
- Easily extensible to N sources

### Files Modified

| File | Change |
|------|--------|
| `app/team/[id].tsx` | Compare chart uses ChartKitLineChart |

### Lesson Learned

**When a library fails after extensive debugging, switch libraries.** Don't spend 10+ hours fighting a library's limitations when alternatives exist. The solution was simple once we stopped trying to make gifted-charts work for this specific use case.

---

## Session 70 - Ranking Journey Chart Fix + Rank Calculation Methodology (February 1, 2026) - COMPLETE

**Focus:** Fix Ranking Journey chart Y-axis and correct fundamental rank calculation methodology.

### Problem Identified

The Ranking Journey chart showed incorrect data:
- Team displayed at #1 rank when never actually ranked #1
- Historical ranks used pool-relative calculation (changing baseline)
- Y-axis padding showed #1 even when best rank was #304

### Root Cause Analysis

Historical rank backfill was fundamentally flawed:
- Early season: 100 teams had entries â†’ team ranked #5
- Current: 45,000 teams â†’ same ELO ranks #3,551
- Result: Misleading chart showing fake #1 rankings

### Solution - GotSport-Inspired Consistent Baseline

Adopted GotSport's approach: rank each historical ELO against the CURRENT full team pool.

| Approach | Description | Result |
|----------|-------------|--------|
| Pool-relative (old) | Rank vs teams with snapshots on that date | Artificially high early ranks |
| Consistent baseline (new) | Rank vs TODAY's full pool | Meaningful, comparable ranks |

### Results

**Sporting BV Pre-NAL 15 (U11 Boys):**

| Date | ELO | National Rank | State Rank | Notes |
|------|-----|---------------|------------|-------|
| 2025-08-08 | 1484 | #2,967 | #44 | Season start |
| 2025-10-04 | 1558 | **#304** | #6 | PEAK (top 7%) |
| 2025-11-09 | 1501 | #1,879 | #28 | After losses |
| 2026-02-01 | 1469 | #3,551 | #55 | Current |

### Performance

| Metric | Value |
|--------|-------|
| Records updated | 193,399 |
| Processing time | ~5 minutes |
| Speed | 650 records/second |
| Algorithm | Binary search + batch CASE updates |

### Chart Y-Axis Fix

Fixed padding calculation that caused #1 to appear on Y-axis:

```javascript
// OLD: Percentage of RANGE (huge for large ranges)
const padding = Math.ceil(range * 0.1);  // 10% of 3500 = 350 â†’ shows #1

// NEW: Percentage of actual VALUES
const topPadding = Math.ceil(minRank * 0.1);  // 10% of 304 = 30 â†’ shows #274
const bottomPadding = Math.ceil(maxRank * 0.1);  // Proper bottom padding
```

### Files Created/Modified

| File | Purpose |
|------|---------|
| `scripts/maintenance/recalculateHistoricalRanks.cjs` | Universal rank recalculation |
| `app/team/[id].tsx` | Chart Y-axis padding fix |
| Multiple debug scripts | Investigation and verification |

### Key Principle Added

**Principle 18:** Rank Calculation - Consistent Baseline
- Historical ranks MUST use consistent baseline (current team pool)
- Rankings should be meaningful and comparable across time
- GotSport-inspired methodology

---

## Session 69 - Home Tab Timeout Fix + Staging Backlog Clear (February 1, 2026) - COMPLETE

**Focus:** Fix Home tab timeout error, clear 31K staging backlog, sync all documentation.

### Issues Fixed

| Issue | Root Cause | Solution |
|-------|------------|----------|
| Home Tab Timeout (57014) | 9 missing indexes on materialized views | `ensureViewIndexes.js` (universal self-healing) |
| 31K Staging Backlog | `learned_patterns` table missing | Created table + bulk SQL processor |

### Results

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| Unprocessed staging | 31,421 | **0** | âœ… Cleared |
| teams_v2 | 147,794 | **155,408** | +7,614 |
| matches_v2 | 304,624 | **314,114** | +9,490 |
| View indexes | 12/21 | **21/21** | âœ… Fixed |

### Universal Solutions Created

| Script | Purpose | Speed |
|--------|---------|-------|
| `scripts/maintenance/ensureViewIndexes.js` | Self-healing index maintenance | <1 min |
| `scripts/_debug/fastBulkProcess.js` | Clear staging backlogs | 23K/27s |
| `scripts/migrations/040_create_learned_patterns.sql` | Adaptive learning table | â€” |

### V1â†’V2 Migration Audit

Documented the intentional data cleanup during migration:
- V1 `match_results_deprecated`: 470,641 (archived)
- V2 `matches_v2`: 314,114 (production)
- Difference: 156K cleaned (duplicates, garbage dates, failed validation)

### Documentation Synced

All docs updated with accurate row counts:
- `1-ARCHITECTURE.md` - v3.2
- `2-UNIVERSAL_DATA_QUALITY_SPEC.md` - Session 69 status
- `3-DATA_EXPANSION_ROADMAP.md` - v2.4
- `CLAUDE.md` - All counts updated

---

## Session 68 - Rating Journey Chart Redesign + QC (January 31 - February 1, 2026) - COMPLETE

**Focus:** Redesign the Rating Journey widget with a two-level filter system, then QC testing to ensure charts display correctly.

### Features Implemented

| Feature | Description |
|---------|-------------|
| Source Selector | Segmented control with SV, GotSport, Both options |
| Scope Selector | National vs State toggle |
| Gradient Fills | Subtle fills under chart lines |
| Dynamic Stats | Labels reflect selected scope |
| Compare Mode | Normalized 0-100 scale overlay |

### Source Selector Design

Replaced cramped pills with clean segmented control:
- **SV** (SoccerView) - Blue active state (`#3B82F6`)
- **GotSport** - Amber active state (`#f59e0b`)
- **Both** - Green active state (`#10b981`)

Each button shows icon + short label, preventing text wrap issues.

### QC Testing Fixes (February 1, 2026)

| Issue | Root Cause | Fix |
|-------|-----------|-----|
| Chart showing ELO not Rank | Y-axis displayed 1469 instead of #3,689 | Added `formatYLabel` to convert values to rank format |
| Inverted chart direction | Up should = better rank | Transform: `maxRank + minRank - r` so lower rank appears higher |
| Missing vertical scale | GotSport chart had no Y-axis labels | Added `withHorizontalLabels` prop |
| Compare stats verbose | Showed "Current" and "Best" for both | Simplified to just "SoccerView" and "GotSport" labels |
| Invalid historical ranks | Backfill calculated #9 for team that was never #9 | Re-ran backfill with proper pool comparison |

### Chart Y-Axis Solution

```javascript
// Invert ranks: lower rank (better) appears higher on chart
const rawRanks = sampled.map((p) => getSVRank(p) || 1);
const maxRank = Math.max(...rawRanks);
const minRank = Math.min(...rawRanks);
const data = rawRanks.map((r) => maxRank + minRank - r);

// Format Y-axis to show actual rank values
formatYLabel: (val) => `#${formatNumber(maxRank + minRank - Number(val))}`
```

### Data Operations

| Operation | Result |
|-----------|--------|
| Re-ran `backfillRankHistory.js` | 389,846 rank updates across 150 dates |
| Captured today's snapshot | 124,178 teams with accurate ranks |
| Verified alignment | teams_v2 and rank_history_v2 now match |

### Scope-Aware Data Logic

```typescript
const getGSRank = (h: RankHistoryPoint) =>
  journeyScope === "national" ? h.national_rank : h.state_rank;
```

This function is used throughout:
- Filtering valid data points
- Building chart datasets
- Calculating current/best stats

### Universal Design Verification

Confirmed NO source-specific logic:
- Same code works for ANY team from ANY data source
- `journeySource` selector is for ranking METHODOLOGY (SoccerView vs GotSport), not data PLATFORM
- Chart calculations are dynamic from actual data values
- `formatYLabel` adapts to any rank range

### Files Modified

| File | Changes |
|------|---------|
| `app/team/[id].tsx` | Rating Journey redesign + QC fixes |
| `scripts/onetime/backfillRankHistory.js` | Historical rank calculation from ELO |
| `scripts/daily/captureRankSnapshot.js` | v3.1 with SoccerView rank columns |
| `CLAUDE.md` | Session 68 entry |
| `docs/1-SESSION_HISTORY.md` | Session 68 entry |

---

## Session 67 - Team Details UI Refinements (January 31, 2026) - COMPLETE

**Focus:** Polish Team Details page UI components based on user feedback.

### Changes Implemented

| Component | Issue | Fix |
|-----------|-------|-----|
| Season Stats | 4 boxes wrapping to multiple rows | Explicit `width: "23%"` + `justifyContent: "space-between"` |
| Gender display | Showing "M" instead of "Boys" | Added conversion logic in `getTeamMeta()` |
| GotSport Rankings | Headers not aligned | Both sections now use identical `gotsportHeader` style |
| Ranking Journey icon | Emoji didn't match design | Custom outlined 3-bar chart with gold glow |
| Help icons | Inconsistent sizes (18 vs 20) | Standardized all to `size={18}` |
| Icon containers | Trophy cut off | Fixed width container (28x24) with margin |

### Custom Bar Chart Icon

Created a custom outlined bar chart icon with gold hue/glow:
- Three bars at heights 10, 16, 12px
- Gold border (`#f59e0b`) with transparent fill
- Shadow glow effect (`shadowOpacity: 0.6`, `shadowRadius: 4`)
- Matches trophy emoji size for alignment

### Files Modified

| File | Changes |
|------|---------|
| `app/team/[id].tsx` | Season Stats layout, gender conversion, header alignment, custom icon |
| `CLAUDE.md` | Session 67 entry |
| `docs/1-SESSION_HISTORY.md` | Session 67 entry |

### UI Protection Protocol

All modifications followed Principle 17 - backups created before each edit using `node scripts/ui-backup.js`.

---

## Session 66 - V1â†’V2 UI Migration Fix (January 31, 2026) - COMPLETE

**Focus:** Fix Team Details page crash and restore UI features after V1 tables were removed.

### Problem

Team Details page crashed with error:
```
Could not find the table 'public.team_elo' in the schema cache
Hint: Perhaps you meant the table 'public.teams_v2'
```

The app code in `app/team/[id].tsx` was never updated when V1 tables were archived in Session 50.

### Root Cause Analysis

| V1 Table (Removed) | When Removed | App Still Using |
|--------------------|--------------|-----------------|
| `team_elo` | Session 50 | âœ… Yes - Line 541 |
| `match_results` | Session 50 | âœ… Yes - Lines 551, 558 |
| `rank_history` | Session 50 | âœ… Yes - Line 579 |

### Solution

**V1â†’V2 Database Query Migration:**

| Query | V1 (Broken) | V2 (Fixed) |
|-------|-------------|------------|
| Team info | `team_elo` | `app_team_profile` + display_name mapping |
| Matches | `match_results` | `matches_v2` + Supabase joins for team names |
| Rank history | `rank_history` | `rank_history_v2` |

**UI Features Restored:**
- League/Tournament grouping in Match History
- Event cards with win-loss-draw records
- Date ranges per event
- Proper team name display

### Files Modified

| File | Changes |
|------|---------|
| `app/team/[id].tsx` | V1â†’V2 query migration, event grouping UI |
| `CLAUDE.md` | Added Principle 16, Session 66 |
| `docs/SESSION_HISTORY.md` | Session 66 entry |

### New Documentation

**Principle 16 Added:** "App UI Must Use V2 Views - NEVER V1 Tables"

Includes:
- V1â†’V2 table mapping reference
- Column name mapping guide
- Match query pattern for V2
- Anti-patterns to avoid

### Lessons Learned

1. **Database migrations must include app code updates** - V1 tables were archived in Session 50, but app code was never updated
2. **Never `git checkout` files with uncommitted features** - Lost the League/Tournament grouping that was in progress
3. **Need schema validation tests** - Automated tests should catch V1 table references before deployment

---

## Session 65 - Ranking Journey Chart Fix (January 31, 2026) - COMPLETE

**Focus:** Fix "My Team's Journey" chart to display historical ranking progression.

### Problem Identified

The Ranking Journey chart on Team Details page showed "Rank history coming soon" despite:
- `captureRankSnapshot.js` running nightly and writing to `rank_history_v2`
- The V2 architecture being fully deployed

**Root Cause:** App was reading from deprecated V1 `rank_history` table instead of V2 `rank_history_v2`.

### Solution

| Change | Description |
|--------|-------------|
| Data source fix | Changed query from `rank_history` to `rank_history_v2` |
| ELO backfill | Created script to replay ELO from match history |
| Historical data | 171,712 ELO records spanning 150 unique dates |

### ELO Backfill Script

Created `scripts/onetime/backfillEloHistory.js`:
- Replays all matches chronologically (149,847 matches)
- Calculates ELO at each match date
- Writes to `rank_history_v2` with upsert
- Preserves existing GotSport rank data

### Data State

| Metric | Records | Coverage |
|--------|---------|----------|
| Total rank_history_v2 | 416,904 | â€” |
| With ELO rating | 416,904 | Aug 2025 â†’ Jan 2026 |
| With GotSport rank | 242,198 | Jan 30, 2026 only |

### Key Insight

**GotSport ranks cannot be backfilled** - they are external data from GotSport's proprietary algorithm. Unlike ELO (which we calculate from matches), historical GotSport ranks can only be captured via daily snapshots going forward.

### Files Modified
- `app/team/[id].tsx` - Fixed data source to V2 table
- `scripts/onetime/backfillEloHistory.js` - NEW: ELO history backfill script

### Chart Behavior
- Shows "Rank history coming soon" until 2+ days of GotSport rank data
- Will automatically populate as nightly snapshots accumulate
- No code changes needed - just needs time for data to accumulate

---

## Session 64 - Adaptive Learning Integration (January 31, 2026) - COMPLETE

**Focus:** Wire adaptive learning INTO the data quality pipeline so the system improves over time.

### Problem Identified

Adaptive learning INFRASTRUCTURE existed but was NOT integrated:
- `adaptiveLearning.js` existed (364 lines) but had broken Supabase methods
- `learned_patterns` table schema existed but wasn't deployed
- Normalizers didn't use learned patterns
- dataQualityEngine.js didn't call feedback functions

### Changes Made

| Component | Change |
|-----------|--------|
| `adaptiveLearning.js` | Fixed `supabase.raw()` â†’ proper update patterns |
| `teamNormalizer.js` | Added `initializeLearnedPatterns()` + checks learned prefixes first |
| `eventNormalizer.js` | Added `initializeLearnedPatterns()` + checks learned keywords first |
| `dataQualityEngine.js` | Imports + initializes patterns; records success/failure feedback |
| `daily-data-sync.yml` | Added "Learn Patterns (Weekly)" step + summary section |

### The Feedback Loop

```
Data In â†’ Normalize (uses patterns) â†’ Resolve â†’ Create/Match â†’ Learn â†’ Prevent Future
     â†‘                                                                        â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Patterns feed back â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Files Modified
- `scripts/universal/adaptiveLearning.js`
- `scripts/universal/normalizers/teamNormalizer.js`
- `scripts/universal/normalizers/eventNormalizer.js`
- `scripts/universal/dataQualityEngine.js`
- `.github/workflows/daily-data-sync.yml`
- `CLAUDE.md`

### Deployment Required
1. Run `scripts/migrations/040_create_learned_patterns.sql` in Supabase
2. Bootstrap: `node scripts/universal/adaptiveLearning.js --learn-teams --source all`

---

## Session 63 - QC Testing, Universal Discovery & Adaptive Learning (January 30, 2026) - COMPLETE

**Focus:** Complete QC testing, fix League Standings errors, make event discovery universal, add adaptive learning.

### Issues Identified & Fixed

| Issue | Symptom | Root Cause | Fix |
|-------|---------|------------|-----|
| Season Stats math discrepancy | 14 â‰  W+L+D | Used stored value | Calculate from actual matches |
| League Standings crash | Typo `season_id_id` | Fixed to `season_id` |
| League Standings column error | Wrong column `season` | Changed to `season_id` |
| Static event lists | Manual maintenance | Universal DB-based discovery |

### Universal Event Discovery (NEW)

Added `discoverEventsFromDatabase()` to core engine - works for ANY source:

```javascript
// Extracts prefix from matchKeyFormat
const matchKeyPrefix = this.adapter.matchKeyFormat?.split('-')[0];
// Queries matches_v2 filtered by source pattern
await supabase.from("matches_v2").like("source_match_key", `${matchKeyPrefix}-%`);
```

**Results:**
| Source | Matches | Prefix |
|--------|---------|--------|
| gotsport | 9,268 | `gotsport` |
| htgsports | 5,224 | `htg` |
| heartland | 5,129 | `heartland` |

### Adaptive Learning Infrastructure (NEW)

| Component | Purpose |
|-----------|---------|
| `adaptiveLearning.js` | Core learning engine |
| `040_create_learned_patterns.sql` | Database schema |

**Learning Types:** Team name patterns, event classification, feedback loops

### Data Integrity Validation

**Test Case:** Sporting BV Pre-NAL 15 - Heartland Premier League

| Match Date | Opponent | DB | Official | âœ… |
|------------|----------|----|---------|----|
| Aug 23 | Wichita SC Alliance | 3-4 | 3-4 | âœ… |
| Aug 30 | Sporting BV IA 2015 | 2-1 | 2-1 | âœ… |
| Sep 6 | Armour SC Armour | 7-3 | 7-3 | âœ… |
| Sep 14 | Union KC Jr Elite B15 | 4-1 | 4-1 | âœ… |
| Sep 20 | KC Dynamos 15B | 3-0 | 3-0 | âœ… |
| Sep 28 | Breakers FC Pre-Aca... | 3-4 | 3-4 | âœ… |
| Oct 5 | Heat FC B2015 | 5-4 | 5-4 | âœ… |
| Oct 12 | KC Fusion 2015 | 0-2 | 0-2 | âœ… |

**Result:** 100% match - all 8 matches verified.

### Files Created/Modified

| File | Change |
|------|--------|
| `scripts/universal/coreScraper.js` | Added `discoverEventsFromDatabase()` |
| `scripts/universal/adaptiveLearning.js` | **NEW** - Adaptive learning engine |
| `scripts/migrations/040_create_learned_patterns.sql` | **NEW** - Learning schema |
| `scripts/adapters/*.js` | All adapters now use universal discovery |
| `lib/leagues.ts` | Fixed typo (165), column (557) |
| `app/team/[id].tsx` | Fixed Season Stats calculation |

### Verification

- âœ… Universal discovery works for ALL sources
- âœ… No manual static list maintenance
- âœ… Adaptive learning stores patterns
- âœ… 100% data integrity vs official source

---

## Session 62 - Self-Learning Canonical Registries (January 30, 2026) - COMPLETE

**Focus:** Bootstrap canonical registries to prevent future duplicates.

### Problem

Canonical registries were created but empty:
- canonical_events: 4 rows (Heartland only)
- canonical_teams: 0 rows
- canonical_clubs: 0 rows

### Solution

Implemented self-learning system:
1. `seedCanonicalRegistries.js` - Bulk SQL bootstrap (20K records in seconds)
2. `mergeTeams.js` / `mergeEvents.js` - Auto-add merged names as aliases
3. `dataQualityEngine.js` - Add new teams/events to registry on creation
4. `teamDedup.js` - Auto-merge at â‰¥0.95 similarity

### Results

| Registry | Before | After |
|----------|--------|-------|
| canonical_teams | 0 | 19,271 |
| canonical_events | 4 | 1,795 |
| canonical_clubs | 0 | 7,301 |

---

## Session 61 - Alphanumeric Team ID Fix (January 30, 2026) - COMPLETE

**Focus:** Fix missing matches caused by regex only matching numeric team IDs in Heartland scraper.

### Problem Discovered

User reported that their son's team (Sporting BV Pre-NAL 15) showed 7 league matches when it should have shown 8. They provided a TeamSnap screenshot proving the Sep 14, 2025 match against Union KC Jr Elite B15 existed (4-1 win).

### Root Cause Analysis

**Location:** `scripts/adapters/heartland.js`

**Issue:** The `extractTeamId()` and `normalizeTeamName()` functions used regex `^\d+` which only matched pure numeric team IDs.

Heartland CGI data uses alphanumeric team IDs:
- "7115" (numeric) âœ… Matched
- "711A" (alphanumeric) âŒ **Skipped entirely**

The Sep 14 match had team ID "711A" for Union KC Jr Elite B15, causing the entire match row to be skipped.

### Universal Fix Applied

```javascript
// BEFORE (broken):
extractTeamId: (name) => {
  const match = name.match(/^(\d+)\s+/);  // Only digits!
  return match ? match[1] : null;
},

// AFTER (fixed):
extractTeamId: (name) => {
  const match = name.match(/^([A-Za-z0-9]+)\s+/);  // Alphanumeric!
  return match ? match[1] : null;
},
```

Same fix applied to `normalizeTeamName()` function.

### Recovery Actions

1. **Created `scripts/_debug/scrape_missing_matches.cjs`** - Re-scraped U11 Boys Premier subdivisions 1-9 with fixed regex
2. **Captured 64 new matches** across all subdivisions that had alphanumeric team IDs
3. **Created `scripts/_debug/process_sept14_match.cjs`** - Manually processed the specific Sep 14 match
4. **Inserted match ID:** `30b1c922-bf17-4ac4-b388-07eb36f17dc3`
5. **Refreshed materialized views** to update app_team_profile and app_league_standings

### Verification Results

| Metric | Before | After |
|--------|--------|-------|
| Sporting BV Pre-NAL 15 league matches | 7 | **8** |
| Record | 4W-0D-3L | **5W-0D-3L** |
| Points | 12 | **15** |

### Files Modified

| File | Change |
|------|--------|
| `scripts/adapters/heartland.js` | Fixed regex to match alphanumeric IDs |
| `docs/UNIVERSAL_DATA_QUALITY_SPEC.md` | Added anti-pattern #9, updated normalizer spec |
| `docs/DATA_SCRAPING_PLAYBOOK.md` | Added adapter guideline for alphanumeric IDs |
| `docs/SESSION_HISTORY.md` | This entry |
| `CLAUDE.md` | Updated session status |

### Debug Scripts Created

| Script | Purpose |
|--------|---------|
| `scripts/_debug/scrape_missing_matches.cjs` | Re-scrape with fixed regex |
| `scripts/_debug/process_sept14_match.cjs` | Manual match insertion |
| `scripts/_debug/verify_fix.cjs` | Verify team league matches |
| `scripts/_debug/test_team_id_regex.cjs` | Test regex patterns |
| `scripts/_debug/check_sept14_status.cjs` | Check match status |
| `scripts/_debug/test_heartland_fix.cjs` | Test adapter fix |

### Key Lesson

**Never assume IDs are purely numeric.** Always use alphanumeric-capable regex patterns (`[A-Za-z0-9]+`) for ID extraction in adapters. This bug silently skipped 64 matches per Heartland subdivision.

### Data Quality Principle Added

Added to UNIVERSAL_DATA_QUALITY_SPEC.md Anti-Patterns:
> **9. DO NOT use restrictive regex patterns for team IDs**
> - Team IDs can be alphanumeric (e.g., "711A", "12AB", "7115")
> - Use regex `^[A-Za-z0-9]+` not `^\d+`

---

## Session 60 - Universal Data Quality System Complete (January 30, 2026) - COMPLETE

**Focus:** Complete Phase 6 of Universal Data Quality System - Pipeline Integration

### Goal

Integrate `dataQualityEngine.js` into the nightly GitHub Actions pipeline, replacing `validationPipeline.js` as the primary processor.

### Phases Completed (0-6)

| Phase | Description | Status |
|-------|-------------|--------|
| Phase 0 | Immediate Fixes (Heartland merge, seasons) | âœ… Complete |
| Phase 1 | Canonical Registries (DB functions) | âœ… Complete |
| Phase 2 | Normalizers (team, event, match, club) | âœ… Complete |
| Phase 3 | Core Engine (dataQualityEngine.js) | âœ… Complete |
| Phase 4 | Deduplication (match, team, event dedup) | âœ… Complete |
| Phase 5 | Infrastructure Population (clubs, leagues) | âœ… Complete |
| Phase 6 | Pipeline Integration (GitHub Actions) | âœ… Complete |

### Phase 6 Deliverables

1. **Updated `.github/workflows/daily-data-sync.yml`:**
   - Replaced validation-pipeline job to use `dataQualityEngine.js` as primary
   - Added legacy fallback to `validationPipeline.js` if engine fails
   - Added `weekly-dedup-check` job (runs Sundays only)
   - Added `run_dedup` workflow input for manual dedup trigger
   - Updated workflow summary with engine info and dedup results

2. **Workflow Changes:**
   ```yaml
   # Primary engine
   node scripts/universal/dataQualityEngine.js --process-staging

   # Fallback (if primary fails)
   node scripts/daily/validationPipeline.js --refresh-views
   ```

3. **Weekly Deduplication (Sundays):**
   - `matchDedup.js --report`
   - `teamDedup.js --report`
   - `eventDedup.js --report`

### Pipeline Test Results

- **Workflow Run:** Daily Data Sync #18
- **Duration:** 39m 1s
- **Status:** âœ… SUCCESS
- **Engine Used:** Universal (dataQualityEngine.js)

### Database State (Final)

| Table | Rows | Notes |
|-------|------|-------|
| staging_games | 41,095 | 0 unprocessed |
| teams_v2 | 147,706 | 100% have club_id |
| matches_v2 | 304,293 | Duplicates removed |
| clubs | 124,650 | 2,232 new in Phase 5 |
| leagues | 280 | 38 with state metadata |
| tournaments | 1,727 | â€” |
| canonical_events | 4 | Heartland mappings |
| seasons | 3 | â€” |

### Additional Session Work

1. **GitHub CLI Setup:** Installed and authenticated (for future workflow triggers)
2. **iOS Build:** Initiated TestFlight build via EAS
   - Build ID: `06a16265-82fa-4993-84db-1451f0b9451f`
   - Status: âœ… Completed
   - Next: `eas submit --platform ios --latest` to push to TestFlight

### Documentation Updated

- `CLAUDE.md` - Session 60 status, version 7.1
- `docs/UNIVERSAL_DATA_QUALITY_SPEC.md` - All phases marked complete
- `docs/SESSION_HISTORY.md` - This entry
- `docs/_NEXT_SESSION_PROMPT.md` - Updated for next session

### Key Achievement

**Universal Data Quality System is FULLY OPERATIONAL in production.**

The nightly pipeline now automatically:
1. Scrapes data from 3 sources (GotSport, HTGSports, Heartland)
2. Processes staging via dataQualityEngine.js
3. Falls back to legacy pipeline if needed
4. Runs weekly deduplication checks (Sundays)
5. Recalculates ELO ratings
6. Refreshes all materialized views

---

## Session 59 - Heartland League Duplicate Fix (January 30, 2026) - COMPLETE

**Focus:** Fix duplicate Heartland leagues appearing on Team Details page.

### Problem Identified

User reported that team "Sporting BV Pre-NAL 15 (U11 Boys)" showed TWO Heartland leagues in the Leagues section:
- "Heartland Premier League 2025" (7 matches)
- "Heartland Soccer League 2025" (2 matches)

### Root Cause Analysis

Two different scrapers created separate league entries for the same real-world league:

| Scraper | League Name | source_event_id |
|---------|-------------|-----------------|
| `scrapeHeartlandLeague.js` (calendar) | Heartland Soccer League 2025 | `heartland-league-2025` |
| `scrapeHeartlandResults.js` (results) | Heartland Premier League 2025 | `heartland-premier-2025` |

The same physical match was recorded twice:
- Different `source_match_key` formats (e.g., `heartland-7112-7115-2025-09-27` vs `heartland-premier-7112-7115-2025-09-27-3509`)
- Slight team name variations caused different `team_id` lookups
- Result: Same match linked to different leagues

### Fix Applied

Created `scripts/maintenance/mergeHeartlandLeagues.js`:

1. **Identified duplicates** using Heartland team IDs embedded in source_match_key
2. **Deleted 1,581 duplicate matches** from "Heartland Soccer League 2025"
3. **Migrated 446 unique matches** to "Heartland Premier League 2025"
4. **Deleted empty league** "Heartland Soccer League 2025"

### Results

| Metric | Before | After |
|--------|--------|-------|
| matches_v2 | 300,564 | 295,575 |
| leagues | 280 | 279 |
| Heartland Premier League matches | 3,972 | 4,418 |
| Team shows leagues | 2 | 1 |

### Files Created

- `scripts/maintenance/mergeHeartlandLeagues.js` - Merge duplicate league entries
- `scripts/_debug/investigate_heartland_leagues.js` - Diagnostic script
- `scripts/_debug/find_duplicate_heartland_matches.js` - Duplicate finder
- `scripts/_debug/find_duplicate_teams_heartland.js` - Team duplicate analysis
- `scripts/_debug/list_all_tables.js` - Database table inventory

### Documentation Updated

- CLAUDE.md: Added Principle 9 "Prevent Duplicate League Entries"
- CLAUDE.md: Updated database stats
- SESSION_HISTORY.md: This entry

### Prevention

Added documentation requiring all scrapers for a source to use identical `source_event_id` format to prevent future duplicate league entries.

---

## Session 58 - GitHub Actions Fixes & Security Hardening (January 30, 2026) - COMPLETE

**Focus:** Fix failing GitHub Actions workflows and address Supabase security vulnerabilities.

### Problems Identified

1. **Daily Data Sync workflow failing** - GotSport timeout, Refresh Views crash
2. **Daily Rank Snapshot failing** - Wrong script path, ESM import issues
3. **Supabase Security Advisor** - 27 errors + 32 warnings

### Issue 1: GitHub Actions Workflow Failures

**Root Causes Found:**

| Job | Error | Root Cause |
|-----|-------|------------|
| GotSport Events | Timeout (45 min) | CLI flag `--active` not recognized (expected `--active-only`) |
| Refresh App Views | Module not found | `refresh_views_manual.js` never committed |
| Capture Rank Snapshot | Table not found | Wrong script path + ESM dotenv import |

**Fixes Applied:**

1. Fixed CLI flag mismatch in `daily-data-sync.yml` (3 places)
2. Committed missing `scripts/refresh_views_manual.js`
3. Fixed script path in `capture-rank-snapshot.yml`
4. Fixed ESM dotenv imports (`import "dotenv/config"` instead of `import dotenv from "dotenv"`)
5. Increased GotSport timeout from 45 to 90 minutes

### Issue 2: Supabase Security Vulnerabilities

**Security Advisor Report:**
- 21 ERRORS (RLS disabled, Security Definer views)
- 32 WARNINGS (function search paths, permissive policies)

**Migration Created:** `scripts/migrations/enable_rls_security.sql`

| Fix | Count | Details |
|-----|-------|---------|
| Enable RLS | 15 tables | All production and staging tables |
| Create policies | 60+ | Public SELECT, service role writes |
| Fix function search_path | 23 functions | Prevents path manipulation |
| Drop permissive policies | 3 | Deprecated tables |

**RLS Strategy:**
- **Core data** (teams, matches, leagues, etc.): Public read, service role write
- **Staging tables**: Service role only
- **User data** (favorites, predictions): Open for now (app doesn't use auth)

### Issue 3: Performance Optimization

Rewrote `syncActiveEvents.js` v3.0 with parallel processing:

**Before (v2.0):**
- Sequential event processing
- Fixed 1500-3000ms delays between requests
- Per-event database writes
- ~45 min for 79 events (timeout)

**After (v3.0):**
- 5 concurrent events (p-limit)
- 3 concurrent groups per event
- Reactive rate limiting (300ms base, backs off on 429)
- Single bulk insert at end
- Target: 10-20 minutes

**Key Changes:**
```javascript
// Concurrency limits
const eventLimit = pLimit(5);   // 5 events at once
const groupLimit = pLimit(3);   // 3 groups per event

// Reactive rate limiting
let currentBackoff = 300;  // Start at 300ms
function onRateLimit() {
  currentBackoff = Math.min(60000, currentBackoff * 2);
}
function onSuccess() {
  if (consecutiveSuccesses >= 10) {
    currentBackoff = Math.max(300, currentBackoff / 2);
  }
}
```

### Files Changed

| File | Change |
|------|--------|
| `.github/workflows/daily-data-sync.yml` | Fixed `--active-only`, timeout 90min |
| `.github/workflows/capture-rank-snapshot.yml` | Fixed script path |
| `scripts/daily/syncActiveEvents.js` | v3.0 parallel processing |
| `scripts/daily/captureRankSnapshot.js` | Fixed ESM dotenv |
| `scripts/maintenance/inferEventLinkage.js` | Fixed ESM dotenv |
| `scripts/refresh_views_manual.js` | NEW - committed missing file |
| `scripts/migrations/enable_rls_security.sql` | NEW - RLS migration |
| `package.json` | Added p-limit dependency |

### Commits

1. `3273d1b` - Fix GitHub Actions workflow failures and add RLS security
2. `449ac6b` - Fix capture-rank-snapshot workflow path
3. `0e222a3` - Add missing refresh_views_manual.js script
4. `d09c47e` - Increase GotSport scraper timeout to 90 minutes
5. `6f3d628` - Optimize syncActiveEvents.js with parallel processing (v3.0)

### Results

- âœ… Daily Rank Snapshot workflow: PASSING
- âœ… RLS enabled on all 43 tables
- âœ… Security policies applied
- â³ Daily Data Sync: Pending test with v3.0 parallel scraper

---

## Session 57 - Universal Data Pipeline Framework (January 30, 2026) - COMPLETE

**Focus:** Build a source-agnostic Universal Data Pipeline to replace custom per-source scripts with a single engine + lightweight adapters.

### Problem Solved

Before Session 57, adding a new data source required:
- Writing 200+ line custom scraper
- Understanding source-specific quirks
- Duplicating rate-limiting, checkpointing, error handling logic

After Session 57:
- New source = ~50 line adapter config file
- Core engine handles all common logic
- Time to add source: ~1-2 hours vs ~1-2 days

### Phase 1: Script Audit

Analyzed 135+ scripts across 6 directories to identify patterns to preserve:

| Directory | Scripts | Key Patterns |
|-----------|---------|--------------|
| `scripts/daily/` | 6 | Pipeline orchestration |
| `scripts/scrapers/` | 6 | Rate limiting, checkpoints |
| `scripts/maintenance/` | 23 | Data healing, audits |
| `scripts/onetime/` | 13 | Migrations |
| `scripts/_archive/` | 45+ | Legacy reference |

**12 Critical Patterns Documented:**
1. Rate limiting (minimum delay between requests)
2. Checkpoint/resume capability
3. Pagination handling
4. Error retry with exponential backoff
5. Batch database inserts
6. `source_match_key` generation
7. Raw data preservation
8. Event registration
9. Technology abstraction (Cheerio vs Puppeteer)
10. Progress logging
11. Dry-run mode
12. Stats summary

### Phase 2: Framework Design

Created adapter schema specification:

```javascript
// Adapter structure
export default {
  platform: "gotsport",           // Unique identifier
  technology: "cheerio",          // "cheerio" | "puppeteer" | "api"
  baseUrl: "https://...",
  rateLimit: { minDelay: 1000 },
  selectors: { ... },             // CSS/XPath selectors
  fieldMappings: { ... },         // Transform raw â†’ staging
  generateMatchKey: (match) => `gotsport-${match.eventId}-${match.id}`,
};
```

### Phase 3: Build Framework

| File | Purpose | Lines |
|------|---------|-------|
| `scripts/universal/coreScraper.js` | Core engine | 841 |
| `scripts/adapters/gotsport.js` | GotSport adapter | ~120 |
| `scripts/adapters/htgsports.js` | HTGSports adapter (Puppeteer) | ~150 |
| `scripts/adapters/heartland.js` | Heartland adapter | ~100 |
| `scripts/adapters/_template.js` | Template for new sources | ~80 |

**Core Engine Features:**
- Technology-agnostic (Cheerio, Puppeteer, or API)
- Automatic rate limiting from adapter config
- Checkpoint/resume via JSON files
- Batch inserts to staging_games
- Progress logging with stats
- Dry-run mode for testing
- Error handling with retries

### Phase 4: Database Migration (source_match_key)

The `source_match_key` column is the authoritative unique identifier for matches:

| Task | Count | Status |
|------|-------|--------|
| Backfill NULL keys | 286,253 | âœ… Complete |
| Deduplicate keys | 3,562 removed | âœ… Complete |
| Add UNIQUE constraint | enforced | âœ… Complete |
| Drop `unique_match` constraint | legacy | âœ… Removed |

**Key Format by Source:**
| Source | Format | Example |
|--------|--------|---------|
| GotSport | `gotsport-{eventId}-{matchNum}` | `gotsport-39064-91` |
| HTGSports | `htg-{eventId}-{matchId}` | `htg-12345-678` |
| Heartland | `heartland-{level}-{homeId}-{awayId}-{date}-{gameNum}` | `heartland-premier-abc123-...` |
| Legacy | `legacy-{eventId8}-{homeId8}-{awayId8}-{date}` | `legacy-b2c9a5aa-...` |

### Phase 5: Integration Test

**Mt Olive Cup Test:**
- 209 staging records scraped via Universal Framework
- 207 matches successfully inserted to production
- 2 matches skipped (fuzzy matching same-team issue)

**Fuzzy Matching Bug Found:**
- Problem: Similar team names ("Sporting 2014 Blue" vs "Sporting 2014 White") matched to same team
- Impact: ~2% of matches with nearly identical names
- Fix: Validation pipeline now detects `home_team_id == away_team_id` and skips with error log

### Phase 6: GitHub Actions Update

Updated `.github/workflows/daily-data-sync.yml` with Universal Framework + fallback:

| Input | Default | Purpose |
|-------|---------|---------|
| `use_universal_framework` | `true` | Use adapter-based scrapers |
| `fallback_on_error` | `true` | Auto-fallback to legacy if universal fails |

**Workflow now:**
1. Tries Universal Framework first
2. Falls back to legacy scrapers on failure
3. Summary report shows which framework was used

### Scripts Created

| Script | Purpose |
|--------|---------|
| `scripts/universal/coreScraper.js` | Core scraping engine (841 lines) |
| `scripts/adapters/gotsport.js` | GotSport adapter |
| `scripts/adapters/htgsports.js` | HTGSports adapter (Puppeteer) |
| `scripts/adapters/heartland.js` | Heartland adapter |
| `scripts/adapters/_template.js` | Template for new sources |
| `scripts/migrations/backfillSourceMatchKey.js` | Backfill NULL keys |
| `scripts/migrations/deduplicateMatchKeys.js` | Remove duplicates |
| `scripts/migrations/applyConstraint.js` | Add UNIQUE constraint |

### Documentation Created

| Document | Purpose |
|----------|---------|
| `docs/PHASE1_AUDIT_REPORT.md` | Script inventory and patterns |
| `docs/PHASE2_FRAMEWORK_DESIGN.md` | Architecture design |

### Key Achievement

**Before:** Adding new source = 1-2 days (custom 200+ line script)
**After:** Adding new source = 1-2 hours (~50 line adapter config)

### Principle Added: Fuzzy Matching Limitations

Very similar team names may incorrectly match to the same team. Validation pipeline now skips these with error logging instead of crashing.

---

## Session 56 - Complete Unlinked Match Remediation (January 29, 2026) - COMPLETE

**Focus:** Complete the unlinked match fix from Session 55, addressing all fixable platforms.

### Final Results Summary

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| Total unlinked | 17,347 | **~5,789** | -11,558 (67% fixed) |
| HTGSports unlinked | 2,228 | **0** | âœ… All fixed |
| Heartland unlinked | 48 | **0** | âœ… All fixed |
| Gotsport legacy | 15,071 | **~5,789** | V1 archive + inference |
| app_upcoming_schedule | 906 | **4,753** | Verified matches only |

### Phase 1: Platform-Specific Fixes

#### HTGSports Fix: Event Pattern Matching
Created `scripts/maintenance/linkByEventPattern.js`:
- Extracts event ID from `source_match_key` pattern (htg-{event_id}-{match_id})
- Creates tournaments for each event ID
- Links all matches with that event pattern

**13 HTGSports Tournaments Created:**
- 2025 Border Battle (536 matches)
- HTGSports Event 12093 (591 matches)
- HTGSports Event 12092 (441 matches)
- Plus 10 more smaller events

#### Heartland Fix
- All 48 linked to "Heartland Premier League 2026"

#### Garbage Deletion
- 51 matches with 2027+ dates deleted

### Phase 2: V1 Archive Linkage (Major Success)

Created `scripts/maintenance/linkFromV1Archive.js` to recover legacy gotsport matches:

**Approach:**
1. Load V1 archived `match_results_deprecated` (contains event_id, event_name)
2. Load V2 legacy matches (no league/tournament)
3. Join by: match_date + home_team_id + away_team_id (or swapped)
4. Get event info from V1, create/lookup in V2

**Results:**
| Metric | Count |
|--------|-------|
| V1 matches indexed | 165,000+ |
| V2 legacy matched | 10,097 (67.2%) |
| Events created | 203 total |
| - Tournaments | 123 |
| - Leagues | 80 |

### Phase 2.5: Inference Linkage (Self-Healing Pipeline)

Created `scripts/maintenance/inferEventLinkage.js` to link orphaned matches by inferring events from team activity patterns:

**Logic:**
- If Team A and Team B both play in "Event X" (from their linked matches)
- And they have an unlinked match within that date range
- Infer the match belongs to "Event X"

**Initial Run Results:**
| Metric | Count |
|--------|-------|
| Unlinked analyzed | 6,944 |
| Teams with event history | 5,997 |
| Matches inferred | 1,155 |
| - To leagues | 126 |
| - To tournaments | 1,029 |

**Added to Nightly Pipeline:** As more matches are scraped and linked, we learn more about team-event relationships, allowing more orphaned matches to find their home over time.

### Phase 3: Data Integrity Fix (Critical User Feedback)

**User Feedback:** "Why are we putting them in upcoming if we are unsure what they actually are?"

**Problem:** Initial migration showed ALL scheduled matches in Upcoming, including unlinked ones.

**Solution:** Updated `app_upcoming_schedule` with data integrity filter:
```sql
-- Only include matches with known events
AND (m.league_id IS NOT NULL OR m.tournament_id IS NOT NULL)
```

| Metric | Initial Fix | Final Fix |
|--------|-------------|-----------|
| app_upcoming_schedule rows | 6,282 | **4,753** |
| Unlinked matches included | Yes | **No** |
| "other" type events | Yes | **None** |

**Principle Established:** Upcoming section requires HIGHEST data integrity. Only verified matches shown.

### Documentation Updates

1. **CLAUDE.md Principle 6:** "Scheduled Matches Are Critical" (0-0 scores NOT garbage)
2. **CLAUDE.md Principle 7:** "Upcoming Section Data Integrity" (only linked matches)
3. **ARCHITECTURE.md:** Fixed garbage threshold from 2026+ to 2027+
4. **DATA_SCRAPING_PLAYBOOK.md:** Emphasized collecting scheduled matches

### Scripts Created

| Script | Purpose |
|--------|---------|
| `linkByEventPattern.js` | Links by extracting event ID from key pattern |
| `linkFromV1Archive.js` | Links legacy via V1 archived data (67% success) |
| `inferEventLinkage.js` | **NIGHTLY** Infers event from team patterns (self-healing) |
| `cleanupGarbageMatches.js` | Only deletes 2027+, preserves 2026 |
| `run_session56_migration.js` | **CRITICAL** Fixes app_upcoming_schedule view |

### Key Lessons Learned

1. **V1 archived data is valuable** - Don't assume old data is useless; it contains linkage info
2. **Data integrity > coverage** - Better to show 4,753 verified matches than 6,282 with unknowns
3. **User trust is paramount** - Parents plan weekends around Upcoming; accuracy is critical
4. **Self-healing pipelines** - Orphaned data can find a home over time as we learn patterns
5. **Every match deserves a home** - Inference linkage ensures orphans shrink, not grow

---

## Session 55 - Fix Unlinked Matches & Team Details QC (January 29, 2026) - COMPLETE

**Focus:** Fix data quality issue where matches had NULL league_id AND tournament_id, causing "Other Matches" to appear on Team Details page.

### Problem

Team Details page showed "Other Matches" section for matches without league/tournament linkage:
- 12,231 matches had NULL league_id AND tournament_id
- Test team (Sporting BV Pre-NAL 15) had 13 of 19 matches unlinked
- UI needed restructuring for Leagues/Tournaments sub-headers

### Solution: Source Match Key Linkage

Created `scripts/maintenance/linkUnlinkedMatches.js` with optimized approach:

1. **Source Match Key Matching** - Uses `source_match_key` field to join `matches_v2` back to `staging_games` (100% accurate, no fuzzy matching needed)
2. **Pagination** - All Supabase queries use pagination (handles >1000 rows)
3. **Auto-Create Events** - Creates missing tournaments/leagues from staging data
4. **Batch Updates** - Processes 100 matches per batch for speed

### Results

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| Unlinked matches | 12,231 | **2,276** | -9,955 (81% fixed) |
| Linked to leagues | 0 | 4,696 | new |
| Linked to tournaments | 0 | 5,259 | new |
| Test team unlinked | 13 | **0** | âœ… All fixed |
| Missing events created | â€” | 8 | new tournaments |

### CRITICAL FINDING: Full Analysis Revealed 17,347 Unlinked

Deeper analysis (late in session) revealed the initial count was incomplete:

| Category | Count | Issue | Status |
|----------|-------|-------|--------|
| GotSport no source_match_key | 15,071 | Legacy imports | **Needs date+teams matching** |
| HTGSports | 2,228 | Has key | Should link (re-run script) |
| Heartland old key format | 48 | Key mismatch | Match by date+teams |
| Garbage (2027/2031/2035) | 51 | Invalid dates | Safe to delete |

**By Year:**
```
2024: 8,500 | 2026: 7,226 | 2025: 954 | 2023: 338 | 2022: 172 | 2021: 91
```

**âš ï¸ CRITICAL:** The 7,226 "2026" matches are CURRENT SEASON (Jan 2026 = now), not future! These need linkage, not deletion.

### Next Session TODO

```bash
# 1. Delete only garbage (2027+)
node scripts/maintenance/cleanupGarbageMatches.js --delete

# 2. Re-run linkage for HTGSports matches
node scripts/maintenance/linkUnlinkedMatches.js

# 3. Create date+teams matching for legacy gotsport (15,071 matches)
# TODO: New script needed - linkLegacyMatches.js
```

### UI Fixes Completed

1. **Season Stats** - 4 equal pills in single row (removed flexWrap, reduced gap)
2. **Match History** - Restructured with Leagues/Tournaments sub-headers
3. **Team Display Names** - Proper capitalization with `formatTeamName()` helper
4. **Icons** - Changed to `podium-outline` for Leagues, âš½ for league cards

### Scripts Created

| Script | Purpose |
|--------|---------|
| `scripts/maintenance/linkUnlinkedMatches.js` | Link matches via source_match_key |
| `scripts/_debug/debug_staging.js` | Check team match linkage status |
| `scripts/_debug/analyze_unlinked.js` | Analyze remaining unlinked matches |

### Key Learning

**Don't match by team names across sources.** Team names are formatted differently:
- `staging_games`: Raw scraped names ("SLSG Premier Green 2015")
- `matches_v2`: Canonical names ("slsg green 2015")

Use `source_match_key` for accurate linkage instead.

---

## Session 54 - Complete Birth Year Data Cleanup (January 29, 2026) - COMPLETE

**Focus:** Finish data cleanup started in Session 53 - eliminate all birth_year mismatches.

### Problem

Session 53 built the dynamic age_group architecture, but data cleanup was only ~52% complete:
- 25,857 teams had birth_year mismatches (name contained year like "B2013" but stored birth_year didn't match)
- Many couldn't be fixed directly due to unique constraint violations (duplicate teams)

### Solution: Optimized 4-Phase SQL Batch Cleanup

Created `scripts/maintenance/completeBirthYearCleanup.js`:

| Phase | Action | Result |
|-------|--------|--------|
| 1 | Merge same-target duplicates (teams wanting same birth_year) | 818 teams merged |
| 2 | Merge blocking teams (existing team has target birth_year) | 38 teams merged |
| 3 | Batch UPDATE all remaining mismatches | 17,328 teams updated |
| 4 | Refresh all materialized views | 5 views refreshed |

### Results

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| Total teams | 143,523 | 142,541 | -982 (merged duplicates) |
| Name matches birth_year | 51,907 | **68,481** | +16,574 |
| Name mismatches | 25,857 | **0** | âœ… All fixed |
| Has birth_year | 98.1% | 98.1% | unchanged |
| NULL birth_year | 2,761 | 2,761 | (need manual review) |

### Key Insight

The initial approach of one-at-a-time updates was too slow and error-prone. The optimized approach:
1. First resolve all duplicate/blocking teams
2. Then run a single batch SQL UPDATE

This handles edge cases like:
- Multiple teams wanting the same unique key
- Matches needing transfer before team deletion
- Self-referential matches (team vs itself after merge)

### Script Features

```javascript
// Phase 1: Find duplicate groups wanting same (canonical_name, birth_year, gender, state)
// Keep oldest team, transfer matches, delete duplicates

// Phase 2: Find teams blocked by existing team with target birth_year
// Merge into existing team, transfer matches

// Phase 3: Single batch UPDATE (now safe)
UPDATE teams_v2
SET birth_year = (regexp_match(display_name, '(20[01][0-9])'))[1]::int
WHERE display_name ~ '20[01][0-9]'
  AND birth_year != extracted_year;
```

### Files Created/Modified

- `scripts/maintenance/completeBirthYearCleanup.js` (new)
- `CLAUDE.md` (session status)
- `docs/SESSION_HISTORY.md` (this file)
- `docs/ARCHITECTURE.md` (team counts)

---

## Session 53 - Foolproof Age Group Architecture (January 29, 2026) - COMPLETE

**Focus:** Make age_group calculation dynamic from database, eliminating hardcoded season years.

### Problem Solved

The `age_group` field used hardcoded `2026` season year in multiple places. This would break every August when the season changes, requiring code changes across multiple files.

### Solution: Dynamic Season Year

Implemented 8-phase architecture overhaul:

| Phase | Change | File(s) |
|-------|--------|---------|
| 1 | Added `year` column to seasons table | Migration 021 |
| 2 | Created `get_current_season_year()` SQL function | Migration 021 |
| 3 | Created `teams_v2_live` view | Migration 022 |
| 4 | Updated all materialized views with dynamic age_group | Migration 023 |
| 5 | Added cached season year helpers | `lib/supabase.types.ts` |
| 6 | Updated validation pipeline with `extractBirthYear()` | `scripts/daily/validationPipeline.js` |
| 7 | Updated ELO script to query seasons table | `scripts/daily/recalculate_elo_v2.js` |
| 8 | Documented season rollover procedure | All docs |

### Data Cleanup Results

| Metric | Count |
|--------|-------|
| Total teams | 143,523 |
| Has birth_year | 140,762 (98.1%) |
| NULL birth_year | 2,761 |
| Teams fixed | ~2,890 |

### Key Functions Created

- `get_current_season_year()` - SQL function (single source of truth)
- `getCurrentSeasonYear()` - TypeScript async helper with caching
- `calculateAgeGroup()` - TypeScript helper
- `ageGroupToBirthYear()` - TypeScript helper
- `extractBirthYear()` - Priority-based parsing from team names

### Season Rollover Procedure (Each August)

```sql
UPDATE seasons SET is_current = false WHERE is_current = true;
INSERT INTO seasons (name, start_date, end_date, year, is_current)
VALUES ('2026-27 Season', '2026-08-01', '2027-07-31', 2027, true);
SELECT refresh_app_views();
```

No code changes needed - just SQL updates and view refresh.

### Infrastructure

- **Compute upgraded:** Nano â†’ Micro (same price, 2x memory)
- **Disk IO budget:** Was exhausted on Nano; Micro provides more headroom

---

## Session 52 - V2 Data Integrity Deep Audit (January 28, 2026) - COMPLETE

**Focus:** Systematic audit of V2 data integrity after Session 51 uncovered age group issues.

### Critical Bug Found and Fixed

**Problem:** UI testing revealed age group filter was returning wrong teams. Filtering for "U11" showed teams with "(U10 Boys)" and "(U12 Boys)" in their names.

**Root Cause:** Multiple conflicting age calculation formulas existed across the codebase:
- GotSport API: `2026 - birthYear` â†’ U12
- Database trigger: `seasonYear - birthYear` â†’ U11 (tried to be "season-aware")
- TypeScript helper: `currentYear - birthYear + 1` â†’ U13
- Some birth_year values in DB didn't match team names (e.g., name said "2013B" but birth_year was 2014)

**Final Solution:** Align with GotSport formula directly:

```sql
-- Step 1: Disable the trigger that was overwriting age_group
DROP TRIGGER IF EXISTS trg_teams_v2_age_group ON teams_v2;

-- Step 2: Fix birth_year from team names
UPDATE teams_v2
SET birth_year = (regexp_match(display_name, '(20[01][0-9])'))[1]::int
WHERE display_name ~ '20[01][0-9]'
  AND (birth_year IS NULL OR birth_year != (regexp_match(display_name, '(20[01][0-9])'))[1]::int);

-- Step 3: Apply GotSport formula (2026 - birth_year)
UPDATE teams_v2
SET age_group = 'U' || (2026 - birth_year)
WHERE birth_year IS NOT NULL;

-- Step 4: Update display_name suffixes to match
UPDATE teams_v2
SET display_name = regexp_replace(
    display_name,
    '\(U\d+\s*(Boys|Girls)\)',
    '(' || age_group || ' ' || CASE WHEN gender = 'M' THEN 'Boys' ELSE 'Girls' END || ')'
)
WHERE display_name ~ '\(U\d+\s*(Boys|Girls)\)';
-- 137,872 total teams updated
```

**Result mapping:** 2013 â†’ U13, 2014 â†’ U12, 2015 â†’ U11

### Audit Findings

| Area | Status | Details |
|------|--------|---------|
| Stats Consistency | âœ… Pass | All teams have W+L+D = matches_played |
| Stats Scope | âœ… By Design | Current season only (Aug 1+) |
| Age Group Data | âœ… **Fixed** | 137,872 teams updated with GotSport formula |
| Rankings Partitioning | âœ… Correct | ELO ranks correctly partitioned by birth_year + gender |
| Rank History | âœ… Fixed | captureRankSnapshot.js uses V2 tables |

### All Fixes Applied

| Fix | Impact | Details |
|-----|--------|---------|
| Disabled age_group trigger | Prevents overwrites | `trg_teams_v2_age_group` dropped |
| Parsed birth_year from team names | Fixed mismatches | Regex extraction from display_name |
| GotSport formula applied | 137,872 teams | `'U' || (2026 - birth_year)` |
| Display name suffixes updated | UI consistency | Matches calculated age_group |
| V2 table references | Script functional | `captureRankSnapshot.js` uses V2 tables |
| Workflow path | Workflow functional | Points to `scripts/daily/` |

### Key Learnings

1. **Don't over-engineer:** GotSport uses `2026 - birth_year` â†’ we use `2026 - birth_year`. No need for "season-aware" calculations.

2. **Trust source data:** The source (team names, GotSport) already has the correct age group. Parse and use it directly.

3. **Triggers can fight you:** The `calculate_age_group()` trigger kept overwriting corrected values. Disabled it.

4. **UI testing catches data bugs:** Filter mismatches in the app revealed the underlying data issue.

---

## Session 51 - Data Integrity & Performance Optimizations (January 28, 2026) - COMPLETE

**Focus:** QC testing revealed data integrity issues; comprehensive fixes applied.

### Part 1: Team Data Fixes
- **Problem:** Team "Sporting Blue Valley SPORTING BV Pre-NAL 15 (U11 Boys)" had:
  - Wrong birth_year (2014 instead of 2015)
  - Wrong age_group (U10 instead of U11)
  - Season stats showing only 10 matches (should be 19)

- **Root Causes:**
  1. `app_team_profile.recent_matches` had `LIMIT 10`
  2. Season stats calculated from limited matches instead of stored values
  3. Age group calculation was inconsistent across 126,636 teams

### Part 2: Bulk Data Corrections
| Fix | SQL | Teams Affected |
|-----|-----|----------------|
| Age Group | `UPDATE teams_v2 SET age_group = 'U' \|\| (2026 - birth_year)` | 126,636 |
| Birth Year | Individual correction from team name parsing | 1 |

### Part 3: Code Fixes
- **`app/team/[id].tsx`** - Changed `calculatedStats` to use stored team stats:
  ```typescript
  const calculatedStats = useMemo((): CalculatedStats => {
    const matchesPlayed = team?.matches_played ?? 0;
    const wins = team?.wins ?? 0;
    const losses = team?.losses ?? 0;
    const draws = team?.draws ?? 0;
    // ...
  }, [team]);
  ```

- **`005_create_materialized_views.sql`** - Removed `LIMIT 10` from recent_matches

### Part 4: Performance Optimization
- Added `idx_app_rankings_featured` index for home tab queries
- Featured teams query now <100ms

### Part 5: Documentation Updates
- Updated ARCHITECTURE.md with Data Ingestion Workflow diagram
- Added Data Quality Enforcement section
- Documented Session 51 optimizations

### New Data Integrity Rule
> "There should be no limits put on matches or any data that could benefit the integrity of the whole picture data."

App layer handles pagination; database views include ALL relevant data.

---

## Session 50 - V2 Cutover, Archival & Project Cleanup (January 28, 2026) - COMPLETE

**Major Accomplishment:** Completed V2 database architecture cutover and project reorganization.

### Part 1: V2 Cutover
1. **Updated GitHub Actions** - `daily-data-sync.yml` now uses V2 pipeline
2. **Archived V1 Tables** - Renamed to `*_deprecated`:
   - `teams` â†’ `teams_deprecated`
   - `match_results` â†’ `match_results_deprecated`
   - `event_registry` â†’ `event_registry_deprecated`
   - `team_name_aliases` â†’ `team_name_aliases_deprecated`
   - `rank_history` â†’ `rank_history_deprecated`
   - `predictions` â†’ `predictions_deprecated`
3. **Archived V1 Scripts** - Moved 45 deprecated scripts to `scripts/_archive/`

### Part 2: Documentation Reorganization
- **CLAUDE.md reduced** from 2,093 lines to 346 lines (83% reduction)
- **Created `docs/` structure:**
  - `docs/ARCHITECTURE.md` - V2 database architecture
  - `docs/DATA_SCRAPING_PLAYBOOK.md` - Updated for V2
  - `docs/DATA_EXPANSION_ROADMAP.md` - Updated for V2
  - `docs/SESSION_HISTORY.md` - All session summaries
  - `docs/UI_PATTERNS.md` - Mandatory UI patterns
- **Archived 12 completed docs** to `docs/_archive/`

### Part 3: Scripts Reorganization
Reorganized 47 scripts into subdirectories:
```
scripts/
â”œâ”€â”€ daily/          â† 6 scripts (GitHub Actions)
â”œâ”€â”€ scrapers/       â† 6 scripts (data collection)
â”œâ”€â”€ maintenance/    â† 23 scripts (diagnostics)
â”œâ”€â”€ onetime/        â† 13 scripts (rarely used)
â”œâ”€â”€ migrations/     â† DB migrations
â”œâ”€â”€ _archive/       â† Deprecated V1 scripts
â””â”€â”€ _debug/         â† Debug output files
```

### Part 4: GitHub Actions Update
- Updated all script paths in `daily-data-sync.yml`
- Tested scripts locally - all working
- Pushed changes to GitHub

### Data Flow (Final):
```
Scrapers â†’ staging_games â†’ validationPipeline.js â†’ matches_v2 â†’ app_* views â†’ App
```

### Status: Ready for QC Testing

---

## Session 49 - V2 Data Strategy & App Integration (January 28, 2026)

### Part 1: Data Loss Discovery & Fix
- **Problem Found:** Original migration excluded teams without parseable birth_year/gender
- **Impact:** 46.3% of matches were lost (217,696 of 470,641)
- **Solution:** Inclusive migration with quality flags

### Part 2: Inclusive Migration Results
| Metric | Before | After | Change |
|--------|--------|-------|--------|
| teams_v2 | 132,947 | 137,582 | +4,635 |
| matches_v2 | 252,945 | 292,802 | +39,857 |

### Part 3: App Integration Verified
All tabs now using V2 materialized views:
- Rankings tab â†’ `app_rankings`
- Teams tab â†’ `app_rankings`
- Matches tab â†’ `app_matches_feed`
- Home tab â†’ Multiple V2 views

---

## Session 48 - Database Restructure Phases 1-2 (January 28, 2026)

### Phase 1: Schema Creation
- Created 15 new tables
- Created `gender_type` enum
- Created 18 indexes, 18 triggers
- Created 5 materialized views
- Created `refresh_app_views()` function

### Phase 2: Data Migration
| Table | Old | New | Coverage |
|-------|-----|-----|----------|
| teams â†’ teams_v2 | 149,000 | 132,947 | 89.2% |
| matches â†’ matches_v2 | 448,644 | 252,945 | 56.4% |
| clubs (NEW) | - | 32,334 | - |
| leagues | - | 273 | 100% |
| tournaments | - | 1,492 | 100% |

---

## Session 47 - Event Registry Fix (January 27, 2026)

**Critical Discovery:** `event_id` without `event_registry` entry causes silent failures.

**Problem:** Heartland League matches had `event_id = 'heartland-league-2025'` but no registry entry.
**Impact:** League Standings button missing for all Heartland teams.
**Fix:** Added registry entry with `source_type = 'league'`.

**New Rule:** Every scraper MUST register events in `event_registry` with correct `source_type`.

---

## Session 46 - Filter & Search Parity (January 26-27, 2026)

### Accomplishments:
1. **Teams Tab State Picker** - Converted to type-ahead (matches Rankings)
2. **Selective Keyboard Collapse** - Only search bar collapses filters
3. **Dynamic Filter Height** - Uses `onLayout` measurement
4. **UI Consistency** - Clear button position, help modal padding

---

## Session 45 - Custom SVG Rank Chart (January 26, 2026)

**Problem:** `react-native-gifted-charts` could not reliably handle inverted Y-axis.

**Solution:** Built custom SVG chart using `react-native-svg`:
- Inverted Y-axis (rank #1 at top)
- Smooth quadratic bezier curves
- Gradient area fill
- Proper label spacing

---

## Session 44 - Daily Sync Pipeline Overhaul (January 26, 2026)

### Major Updates:
1. **Fixed GitHub Actions** - Deleted broken `ingest.yml`, updated `daily-data-sync.yml`
2. **HTGSports Discovery** - Covers 26+ states (not just Heartland!)
3. **Created DATA_EXPANSION_ROADMAP.md**

### New Pipeline Structure:
- Phase 1 (Parallel): GotSport + Heartland scraping
- Phase 2: Team integration
- Phase 3: Team linking
- Phase 4: ELO recalculation
- Phase 5: Match count sync
- Phase 6: Score predictions

---

## Session 43 - Heartland Results CGI Scraper (January 26, 2026)

### Major Breakthrough:
- Discovered CGI API: `heartlandsoccer.net/reports/cgi-jrb/subdiv_results.cgi`
- Created `scrapeHeartlandResults.js`
- **Result:** 4,634 matches with scores (93.6% coverage)

### Full Pipeline Run:
| Step | Result |
|------|--------|
| Heartland Results scrape | 4,634 matches |
| Team integration | 129 new teams |
| Heartland link rate | 100% |
| ELO recalculation | 47,094 teams rated |

---

## Session 42 - Single Source of Truth Architecture (January 26, 2026)

**Established Core Principle:** Every data source = first-class entity.

### Implementation:
- Created `integrateHeartlandTeams.js` - Full pipeline
- Created `deduplicateTeams.js` - Cross-source merging
- 100% link rate achieved for Heartland data

---

## Session 41 - Heartland Integration & League Standings (January 25, 2026)

### Heartland Data:
- HTGSports tournaments: 5,624 matches
- Heartland League: 2,801 matches
- **Total:** 8,425 new matches

### Database Optimization Phase 1:
- Dropped duplicate index: -31 MB
- Created reconciliation indexes
- Ready for 4x faster reconciliation

### League Standings Feature:
- `getLeaguePointsTable()` - Points calculation
- `getTeamsForm()` - Last 5 results
- Toggle UI: Points Table vs Power Ratings

### V1 Launch Readiness:
- All 5 criteria exceeded
- **Recommendation: READY FOR APP STORE**

---

## Sessions 38-40 - Data Pipeline Fixes (January 25, 2026)

### Session 40:
- Fixed HTGSports scraper (division dropdown iteration)
- Fixed Heartland League scraper (DOM selectors)
- Created DOM diagnostics for debugging

### Session 39:
- Heartland Soccer integration research
- Discovered HTGSports platform
- Created 5 new scraping scripts

### Session 38:
- Fixed stale `matches_played` field
- Created `syncMatchCounts.js`
- Created `transferRankings.js`

---

## Sessions 35-37 - UX & Data Improvements

### Session 37:
- Identified ranking discrepancy root cause
- Created `reconcileRankedTeams.js`
- Reconciled 138 priority teams

### Session 36:
- Aligned ELO methodology with GotSport
- Added `CURRENT_SEASON_START` filter
- Compacted rating cards on team details

### Session 35:
- Fixed match card consistency
- Created shared `MatchCard` component
- Standardized styling across all tabs

---

## Earlier Sessions (1-34)

### Session 34 (January 24, 2026):
- Created CLAUDE.md as single source of truth
- Verified database state: 85.6% linked

### Sessions 1-33:
- MVP development
- Core features implementation
- Initial data pipeline setup
- QC testing and bug fixes

---

## Key Technical Discoveries

### HTGSports Division Dropdowns (Session 40)
- Events have 50-100 divisions in dropdown
- Must iterate ALL options and wait for reload
- Without iteration: 1-3 matches; With iteration: 500-800 matches

### Soccer Season Date Logic (Session 43)
- Seasons span Aug-Jul (cross calendar year)
- Dates like "12/15" without year need season-aware parsing

### Event Registry Requirement (Session 47)
- Every `event_id` MUST exist in `event_registry`
- Missing entry = silent feature failure

### Prefix Matching Danger (Session 37)
- "Team 2013" must NOT match "Team 2015"
- Always validate year/gender/state

---

*This archive is maintained for historical reference.*
*For current status, see CLAUDE.md.*
