# SoccerView V2 Database Architecture

> **Version 5.0** | Last Updated: February 5, 2026 | Session 88 Complete
>
> This document describes the production V2 three-layer database architecture.
> For historical V1 architecture, see [docs/_archive/](docs/_archive/).
>
> **üö® Read [GUARDRAILS](1.1-GUARDRAILS_v2.md) before making any changes.**
> **üìã For data issues, see [DATA_ISSUE_PROTOCOL](DATA_ISSUE_PROTOCOL.md).**

---

## ‚ö†Ô∏è CRITICAL: V1 Tables Have Been Removed

**The following V1 tables NO LONGER EXIST in the database:**

| V1 Table (REMOVED) | V2 Replacement | Notes |
|--------------------|----------------|-------|
| `team_elo` | `app_team_profile` view | Use `display_name` not `team_name` |
| `match_results` | `matches_v2` table | Requires joins for team names |
| `rank_history` | `rank_history_v2` table | Different columns |

**App code MUST use V2 views/tables. See Principle 16 in CLAUDE.md.**

### V1 ‚Üí V2 Migration Data Quality (Session 69 Audit)

**Why V2 has fewer matches than V1:** This is **intentional data cleanup**, NOT data loss.

| Table | Rows | Status |
|-------|------|--------|
| `match_results_deprecated` (V1) | 470,641 | Archived |
| `matches_v2` (V2) | 314,852 | **Production** |
| Difference | 155,789 | Cleaned |

**What was cleaned:**
- ~12,697 exact duplicates (same date+teams+score)
- ~172,883 fuzzy duplicates / failed V2 validation
- ~58 garbage future dates (2027-2035)

**V2 enforces:**
- Unique `source_match_key` constraint
- No future garbage dates
- Proper team linkage
- No exact duplicates

---

## Overview

SoccerView uses a three-layer database architecture designed for:
- **Scalable data ingestion** from multiple sources
- **Data quality validation** before production use
- **Fast app queries** via pre-computed materialized views

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      SOCCERVIEW V2 DATABASE ARCHITECTURE                        ‚îÇ
‚îÇ                         Three-Layer Data Pipeline                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                           ‚îÇ    DATA SOURCES      ‚îÇ
                           ‚îÇ  GotSport‚îÇHTGSports  ‚îÇ
                           ‚îÇ  Heartland (Premier) ‚îÇ
                           ‚îÇ  (Session 84: PREMIER-ONLY)
                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                      ‚îÇ
                                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LAYER 1: STAGING TABLES (Raw Ingestion - No Constraints)                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                                 ‚îÇ
‚îÇ   staging_teams          staging_games           staging_events                 ‚îÇ
‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ           ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                 ‚îÇ
‚îÇ   ‚Ä¢ All fields TEXT      ‚Ä¢ All fields TEXT       ‚Ä¢ All fields TEXT             ‚îÇ
‚îÇ   ‚Ä¢ NO constraints       ‚Ä¢ UNIQUE source_match_key‚Ä¢ NO constraints             ‚îÇ
‚îÇ   ‚Ä¢ NO foreign keys      ‚Ä¢ NO foreign keys       ‚Ä¢ NO foreign keys             ‚îÇ
‚îÇ   ‚Ä¢ Batch ID tracking    ‚Ä¢ Batch ID tracking     ‚Ä¢ Batch ID tracking           ‚îÇ
‚îÇ   ‚Ä¢ Source platform      ‚Ä¢ Source platform       ‚Ä¢ Source platform             ‚îÇ
‚îÇ                                                                                 ‚îÇ
‚îÇ   Purpose: Accept ANY data from ANY source without validation failures          ‚îÇ
‚îÇ   Data flows in via: Scraper scripts (direct insert)                           ‚îÇ
‚îÇ                                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                      ‚îÇ
                                      ‚îÇ 1. intakeValidator.js (Reject garbage)
                                      ‚îÇ 2. dataQualityEngine.js (Normalize, resolve, promote)
                                      ‚îÇ (Session 79: SINGLE PATH - no alternatives)
                                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LAYER 2: PRODUCTION TABLES (Validated Core - Strict Constraints)               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                                 ‚îÇ
‚îÇ   teams_v2 (158,043)     matches_v2 (403,068*)   clubs (124,650)                ‚îÇ
‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ      ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                  ‚îÇ
‚îÇ   ‚Ä¢ UUID primary key     ‚Ä¢ Match date NOT NULL   ‚Ä¢ Normalized names            ‚îÇ
‚îÇ   ‚Ä¢ gender_type enum     ‚Ä¢ home ‚â† away team      ‚Ä¢ State tracking              ‚îÇ
‚îÇ   ‚Ä¢ birth_year INT       ‚Ä¢ Composite unique      ‚Ä¢ Logo URLs                   ‚îÇ
‚îÇ   ‚Ä¢ Proper FKs to clubs  ‚Ä¢ FKs to teams_v2       ‚Ä¢ Deduplication               ‚îÇ
‚îÇ   ‚Ä¢ Quality score 0-100  ‚Ä¢ FKs to leagues/tourn                                ‚îÇ
‚îÇ   ‚Ä¢ Unique constraints   ‚Ä¢ link_status tracking                                ‚îÇ
‚îÇ                                                                                 ‚îÇ
‚îÇ   leagues (280)          tournaments (1,711)     venues, schedules             ‚îÇ
‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ      ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ            ‚îÇ
‚îÇ   ‚Ä¢ source_event_id      ‚Ä¢ source_event_id       ‚Ä¢ Location data               ‚îÇ
‚îÇ   ‚Ä¢ Season tracking      ‚Ä¢ Date range            ‚Ä¢ Field names                 ‚îÇ
‚îÇ                                                                                 ‚îÇ
‚îÇ   * 403,068 active + ~5,468 soft-deleted (Sessions 86-90: soft-delete arch)    ‚îÇ
‚îÇ                                                                                 ‚îÇ
‚îÇ   Purpose: Clean, normalized, validated data with referential integrity         ‚îÇ
‚îÇ                                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                      ‚îÇ
                                      ‚îÇ refresh_app_views()
                                      ‚îÇ + ensureViewIndexes.js (Session 69)
                                      ‚îÇ (Refreshes views + ensures indexes exist)
                                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LAYER 3: MATERIALIZED VIEWS (App-Ready Read Layer - Pre-computed)              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                                 ‚îÇ
‚îÇ   app_rankings (158,043)           app_team_profile (158,043)                   ‚îÇ
‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ           ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                   ‚îÇ
‚îÇ   ‚Ä¢ Pre-joined team data           ‚Ä¢ Full team detail with JSONB               ‚îÇ
‚îÇ   ‚Ä¢ ELO + official ranks           ‚Ä¢ recent_matches[] embedded                 ‚îÇ
‚îÇ   ‚Ä¢ Win/loss/draw stats            ‚Ä¢ upcoming_schedule[] embedded              ‚îÇ
‚îÇ   ‚Ä¢ Age group calculated           ‚Ä¢ rank_history[] embedded                   ‚îÇ
‚îÇ   ‚Ä¢ Indexed for search             ‚Ä¢ leagues[] embedded                        ‚îÇ
‚îÇ                                                                                 ‚îÇ
‚îÇ   app_matches_feed (403,068)       app_league_standings (26,696)               ‚îÇ
‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ               ‚îÇ
‚îÇ   ‚Ä¢ home_team JSONB embedded       ‚Ä¢ Points table calculation                  ‚îÇ
‚îÇ   ‚Ä¢ away_team JSONB embedded       ‚Ä¢ Form (last 5 results)                     ‚îÇ
‚îÇ   ‚Ä¢ event JSONB embedded           ‚Ä¢ Position ranking                          ‚îÇ
‚îÇ   ‚Ä¢ venue JSONB embedded           ‚Ä¢ Goal difference                           ‚îÇ
‚îÇ                                                                                 ‚îÇ
‚îÇ   app_upcoming_schedule (4,990)                                                 ‚îÇ
‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                                  ‚îÇ
‚îÇ   ‚Ä¢ Future games only (VERIFIED)                                                ‚îÇ
‚îÇ   ‚Ä¢ UNION of schedules + matches_v2                                             ‚îÇ
‚îÇ   ‚Ä¢ ONLY linked matches (data integrity)                                        ‚îÇ
‚îÇ   ‚Ä¢ Full team/venue details                                                     ‚îÇ
‚îÇ                                                                                 ‚îÇ
‚îÇ   Purpose: Zero-join queries for app, sub-100ms response times                  ‚îÇ
‚îÇ   App queries ONLY these views - never touches Layer 1 or 2 directly            ‚îÇ
‚îÇ                                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                      ‚îÇ
                                      ‚ñº
                           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                           ‚îÇ    MOBILE APP        ‚îÇ
                           ‚îÇ  Rankings‚îÇTeams‚îÇHome ‚îÇ
                           ‚îÇ  Matches‚îÇTeam Detail ‚îÇ
                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Universal Scraper Framework (Session 57)

The Universal Scraper Framework replaces custom per-source scripts with a single engine that reads lightweight adapter configs.

### Architecture
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     SOURCE ADAPTERS                              ‚îÇ
‚îÇ  /scripts/adapters/gotsport.js    (Cheerio - static HTML)       ‚îÇ
‚îÇ  /scripts/adapters/htgsports.js   (Puppeteer - JavaScript SPA)  ‚îÇ
‚îÇ  /scripts/adapters/heartland.js   (Cheerio - CGI endpoints)     ‚îÇ
‚îÇ  /scripts/adapters/_template.js   (Template for new sources)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              CORE SCRAPER ENGINE                                 ‚îÇ
‚îÇ  /scripts/universal/coreScraper.js (841 lines)                  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚Ä¢ Reads adapter config                                          ‚îÇ
‚îÇ  ‚Ä¢ Handles rate limiting, retries, checkpoints                  ‚îÇ
‚îÇ  ‚Ä¢ Writes to staging_games with source_platform tag             ‚îÇ
‚îÇ  ‚Ä¢ Technology-agnostic (Cheerio, Puppeteer, or API)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              STAGING TABLES (Layer 1)                            ‚îÇ
‚îÇ  staging_games, staging_teams, staging_events                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Adding a New Data Source

1. Copy `scripts/adapters/_template.js` to `scripts/adapters/{source}.js`
2. Configure: base URL, selectors, field mappings, rate limits
3. Run: `node scripts/universal/coreScraper.js --adapter {source} --active`

**Time to add new source: ~1-2 hours (config only, no custom code)**

### Supported Technologies

| Technology | Use Case | Adapter Example |
|------------|----------|-----------------|
| Cheerio | Static HTML pages | gotsport.js, heartland.js |
| Puppeteer | JavaScript SPAs | htgsports.js |
| API | REST endpoints | (future) |

### Checkpoint Best Practices (Session 74)

The core scraper uses checkpoints to track which events have been processed, enabling:
- Resume after interruption
- Skip already-processed events
- Avoid re-scraping stable data

**CRITICAL:** Only mark events as processed when data is actually found:

```javascript
// ‚ùå WRONG - Marks event as processed even with no data
await scrapeEvent(eventId);
checkpoint.processedEvents.push(eventId);  // Always marks as "done"
saveCheckpoint(checkpoint);

// ‚úÖ CORRECT - Only mark when data exists
const matches = await scrapeEvent(eventId);
if (matches.length > 0) {
  checkpoint.processedEvents.push(eventId);
  saveCheckpoint(checkpoint);
} else {
  console.warn(`Event ${eventId} returned 0 matches - NOT marking as processed`);
}
```

**Why this matters:**
- Empty results may indicate network issues, not actual empty events
- Page structure changes can cause scrapers to silently fail
- Incorrect regex patterns can skip all divisions (Session 74 - 1 of 38 found)
- Marking empty as "processed" = event NEVER scraped again = permanent data loss

**Checkpoint file location:** `scripts/.{source}_scraper_checkpoint.json`

### Division Detection Pattern (Session 74)

For adapters that scrape division-based tournaments (HTGSports, etc.), use the universal division pattern:

```javascript
// ‚úÖ Universal pattern - matches both "U11" and "U-11"
divisionPattern: /U-?\d{1,2}\b|20[01]\d/i

// Pattern breakdown:
// U-?       = "U" followed by optional dash
// \d{1,2}   = One or two digits (U9 through U19)
// \b        = Word boundary (prevents matching "U115" in team names)
// 20[01]\d  = Birth years 2000-2019 (matches "2015", "2016", etc.)
```

**Bug fixed:** HTGSports adapter used `/U-\d+/` which required a dash. Sites using "U11" format were missed entirely (1 of 38 divisions found).

---

## Data Ingestion Workflow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                           DATA INGESTION WORKFLOW                               ‚îÇ
‚îÇ                     (Scraper ‚Üí Staging ‚Üí Production ‚Üí App)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    GotSport     ‚îÇ   ‚îÇ   HTGSports     ‚îÇ   ‚îÇ   Heartland     ‚îÇ
‚îÇ    Scraper      ‚îÇ   ‚îÇ    Scraper      ‚îÇ   ‚îÇ    Scraper      ‚îÇ
‚îÇ                 ‚îÇ   ‚îÇ                 ‚îÇ   ‚îÇ                 ‚îÇ
‚îÇ syncActive      ‚îÇ   ‚îÇ scrapeHTG       ‚îÇ   ‚îÇ scrapeHeartland ‚îÇ
‚îÇ Events.js       ‚îÇ   ‚îÇ Sports.js       ‚îÇ   ‚îÇ Results.js      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                     ‚îÇ                     ‚îÇ
         ‚îÇ   ALL TEXT FIELDS   ‚îÇ   NO CONSTRAINTS    ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ                     ‚îÇ
                    ‚ñº                     ‚ñº
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ          staging_games              ‚îÇ
          ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
          ‚îÇ  ‚Ä¢ id (BIGSERIAL)                   ‚îÇ
          ‚îÇ  ‚Ä¢ match_date (TEXT)                ‚îÇ
          ‚îÇ  ‚Ä¢ home_team_name (TEXT)            ‚îÇ
          ‚îÇ  ‚Ä¢ away_team_name (TEXT)            ‚îÇ
          ‚îÇ  ‚Ä¢ home_score (TEXT)                ‚îÇ
          ‚îÇ  ‚Ä¢ away_score (TEXT)                ‚îÇ
          ‚îÇ  ‚Ä¢ event_name (TEXT)                ‚îÇ
          ‚îÇ  ‚Ä¢ source_platform (TEXT)           ‚îÇ
          ‚îÇ  ‚Ä¢ processed (BOOLEAN)              ‚îÇ
          ‚îÇ  ‚Ä¢ created_at (TIMESTAMPTZ)         ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚îÇ dataQualityEngine.js
                            ‚îÇ (Normalize, resolve, promote)
                            ‚îÇ
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ           VALIDATION STEPS          ‚îÇ
          ‚îÇ  1. Parse dates ‚Üí DATE type         ‚îÇ
          ‚îÇ  2. Parse scores ‚Üí INTEGER type     ‚îÇ
          ‚îÇ  3. Normalize team names            ‚îÇ
          ‚îÇ  4. Match/Create teams_v2           ‚îÇ
          ‚îÇ  5. Link to leagues/tournaments     ‚îÇ
          ‚îÇ  6. Insert to matches_v2            ‚îÇ
          ‚îÇ  7. Mark staging as processed       ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ          matches_v2                 ‚îÇ
          ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
          ‚îÇ  ‚Ä¢ UUID primary key                 ‚îÇ
          ‚îÇ  ‚Ä¢ DATE type (validated)            ‚îÇ
          ‚îÇ  ‚Ä¢ INTEGER scores (validated)       ‚îÇ
          ‚îÇ  ‚Ä¢ Foreign keys to teams_v2         ‚îÇ
          ‚îÇ  ‚Ä¢ Foreign keys to leagues/tourn    ‚îÇ
          ‚îÇ  ‚Ä¢ Unique constraint enforced       ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚îÇ refresh_app_views()
                            ‚îÇ
                            ‚ñº
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ        Materialized Views           ‚îÇ
          ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
          ‚îÇ  ‚Ä¢ app_rankings                     ‚îÇ
          ‚îÇ  ‚Ä¢ app_matches_feed                 ‚îÇ
          ‚îÇ  ‚Ä¢ app_team_profile                 ‚îÇ
          ‚îÇ  ‚Ä¢ app_league_standings             ‚îÇ
          ‚îÇ  ‚Ä¢ app_upcoming_schedule            ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Data Quality Enforcement

### Validation Rules by Layer

| Layer | Table | Field | Validation | Action on Failure |
|-------|-------|-------|------------|-------------------|
| 1 | staging_games | source_match_key | UNIQUE constraint (Session 87.2) | ON CONFLICT DO NOTHING |
| 1 | staging_games | * (other fields) | None | Accept all |
| 2 | matches_v2 | match_date | Must parse to DATE | Reject record |
| 2 | matches_v2 | home_score/away_score | Must be INTEGER ‚â• 0 | Reject record |
| 2 | matches_v2 | home_team_id ‚â† away_team_id | CHECK constraint | Reject record |
| 2 | matches_v2 | home_team_id ‚â† away_team_id | dataQualityEngine | Skip with error log |
| 2 | matches_v2 | (date, home_team_id, away_team_id) | UNIQUE semantic constraint (Session 85) | Upsert (update existing) |
| 2 | teams_v2 | birth_year | 2008-2020 range | Flag for review |
| 2 | teams_v2 | gender | 'boys' or 'girls' enum | Flag for review |
| 3 | app_rankings | age_group | Calculated: U + (year - birth_year) | Auto-computed |

### Team Data Quality Score (0-100)

| Component | Points | Logic |
|-----------|--------|-------|
| birth_year | +30 | If not null AND in valid range (2008-2020) |
| gender | +30 | If not null AND valid enum value |
| national_rank | +20 | If not null (has GotSport ranking) |
| matches_played | +10 | If > 0 (has game history) |
| elo_rating | +10 | If ‚â† 1500 (has calculated rating) |

### Match Uniqueness (Session 85 - Universal SoccerView ID Architecture)

Matches are uniquely identified by **semantic key** using SoccerView Team IDs:

```sql
-- PRIMARY uniqueness constraint (Session 85)
UNIQUE (match_date, home_team_id, away_team_id)
```

**Why semantic key?**
- Same match from different sources (V1, GotSport, HTGSports) = ONE record
- Uses SoccerView Team IDs (already resolved via canonical registries)
- Aligns with `schedules` table architecture

**Upsert Strategy (Session 85):**
```sql
INSERT INTO matches_v2 (...)
ON CONFLICT (match_date, home_team_id, away_team_id) DO UPDATE SET
  home_score = CASE WHEN matches_v2.home_score IS NOT NULL THEN matches_v2.home_score ELSE EXCLUDED.home_score END,
  away_score = CASE WHEN matches_v2.away_score IS NOT NULL THEN matches_v2.away_score ELSE EXCLUDED.away_score END,
  league_id = COALESCE(matches_v2.league_id, EXCLUDED.league_id),
  tournament_id = COALESCE(matches_v2.tournament_id, EXCLUDED.tournament_id),
  source_match_key = COALESCE(matches_v2.source_match_key, EXCLUDED.source_match_key)
```

### source_match_key (Audit Trail Only)

The `source_match_key` column is now used for **audit/tracing only**, not uniqueness:

| Format | Example | Used By |
|--------|---------|---------|
| GotSport | `gotsport-39064-91` | Universal scraper |
| HTGSports | `htg-13014-1356362` | Universal scraper |
| Heartland | `heartland-premier-{homeId}-{awayId}-{date}` | Universal scraper |
| Legacy | `legacy-{eventId8}-{homeId8}-{awayId8}-{date}` | Backfilled historical |

**Index:** `CREATE INDEX idx_matches_v2_source_match_key ON matches_v2 (source_match_key) WHERE source_match_key IS NOT NULL`

**Dropped Constraints (Session 85):**
- `matches_v2_source_match_key_unique` - Replaced by semantic constraint
- `unique_match` (on date + teams + score) - Dropped in Session 57

### Soft-Delete Architecture (Session 86+88)

Match deduplication uses soft-delete, NOT hard-delete. Session 85 hard-deleted 9,160 matches ‚Äî Session 86 recovered 6,053 and established the soft-delete pattern.

**Columns on `matches_v2`:**

| Column | Type | Purpose |
|--------|------|---------|
| `deleted_at` | TIMESTAMPTZ | NULL = active, timestamp = soft-deleted |
| `deletion_reason` | TEXT | Why deleted (e.g., "Semantic duplicate of {id}", "Reverse duplicate of {id}") |

**Current soft-deleted breakdown (Session 88):**
- 1,660 semantic duplicates (same date + same home/away teams)
- 749 reverse duplicates (same date, swapped home/away, score-consistent)
- 14 state-merge transfers

**MANDATORY: `deleted_at IS NULL` in ALL match queries:**
```sql
-- Layer 2: Direct SQL
SELECT * FROM matches_v2 WHERE deleted_at IS NULL;

-- Layer 2: Supabase client
.from("matches_v2").select("*").is("deleted_at", null);

-- Layer 3: Materialized view SQL definitions
WHERE m.deleted_at IS NULL
```

**Views with `deleted_at IS NULL` filter (Migration 088):**
- `app_team_profile` ‚Äî match subquery
- `app_matches_feed` ‚Äî main WHERE clause
- `app_league_standings` ‚Äî JOIN condition + form subquery

### Reverse Match Detection (Session 88)

The UNIQUE constraint `(match_date, home_team_id, away_team_id)` does NOT prevent reverse duplicates where teams are swapped:

```
Record A: date=Aug 14, home=TeamX, away=TeamY, score=2-3
Record B: date=Aug 14, home=TeamY, away=TeamX, score=3-2  ‚Üê ALLOWED by constraint
```

**Detection query:**
```sql
SELECT a.id, b.id FROM matches_v2 a
JOIN matches_v2 b ON a.match_date = b.match_date
  AND a.home_team_id = b.away_team_id
  AND a.away_team_id = b.home_team_id
  AND a.id < b.id
WHERE a.deleted_at IS NULL AND b.deleted_at IS NULL;
```

**Conservative resolution:** Only soft-delete score-consistent pairs (A's home_score = B's away_score). Different-score pairs are legitimate rematches.

**Pipeline prevention:**
- `fastProcessStaging.cjs`: Within-batch dedup + pre-insert DB check using `unnest`
- `dataQualityEngine.js`: Pre-insert reverse match check
- `matchDedup.js`: `detectReverseMatches()` + `resolveReverseMatches()`

### Data Integrity Rules

1. **No Arbitrary Limits** - App views include ALL data; pagination happens at app layer
2. **Authoritative Stats** - Team stats (wins/losses/draws) stored on teams_v2, not recalculated
3. **Age Group Formula** - Use GotSport formula directly (see below)
4. **Season Alignment** - ELO and stats use current season only (Aug 1 start) to match GotSport
5. **Rank History Snapshots** - Daily captures to `rank_history_v2` via GitHub Actions
6. **Match-Event Linkage** - Every match should link to a league or tournament
7. **Upcoming Section Verified Only** - `app_upcoming_schedule` ONLY includes linked matches (data integrity)
8. **Self-Healing Linkage** - Nightly inference script links orphaned matches as we learn team-event patterns
9. **Foundation First (Session 83)** - ALL historical data must be extracted and cleaned BEFORE relying on daily scrape. Volume ‚â† completeness - always check for discrepancies between data sources for the same dates/teams.

### Self-Healing Data Pipeline (Session 56)

The nightly pipeline includes `inferEventLinkage.js` which automatically links orphaned matches over time:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 SELF-HEALING INFERENCE LINKAGE                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  1. Load orphaned matches (no league_id, no tournament_id)      ‚îÇ
‚îÇ  2. For each match, find what events home/away teams play in    ‚îÇ
‚îÇ  3. If both teams share a common event AND date fits ‚Üí LINK     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Example:                                                       ‚îÇ
‚îÇ  - Team A plays 10 matches in "Kansas Premier League"           ‚îÇ
‚îÇ  - Team B plays 8 matches in "Kansas Premier League"            ‚îÇ
‚îÇ  - Team A vs Team B has an orphaned match dated Oct 15          ‚îÇ
‚îÇ  - Oct 15 falls within Kansas Premier League date range         ‚îÇ
‚îÇ  ‚Üí Infer match belongs to "Kansas Premier League"               ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  WHY IT IMPROVES OVER TIME:                                     ‚îÇ
‚îÇ  - Each night we scrape more linked matches                     ‚îÇ
‚îÇ  - We learn more about which teams play in which events         ‚îÇ
‚îÇ  - More orphaned matches can be inferred                        ‚îÇ
‚îÇ  - Orphan count shrinks: 5,789 ‚Üí approaching 0                  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Added to nightly pipeline:** Phase 2.5 runs after validation, before ELO.

### Match-Event Linkage (source_match_key)

Matches in `matches_v2` link to leagues/tournaments via `source_match_key`:

```
staging_games.source_match_key  ‚Üê‚Üí  matches_v2.source_match_key
staging_games.event_name        ‚Üí   leagues.name OR tournaments.name
```

**Linkage Script:** `scripts/maintenance/linkUnlinkedMatches.js`

| Step | Action |
|------|--------|
| 1 | Load staging_games with event_name (paginated) |
| 2 | Match unlinked matches via source_match_key |
| 3 | Lookup event UUID from leagues/tournaments |
| 4 | Create missing events if needed |
| 5 | Batch UPDATE matches_v2 |

**Common Linkage Issues:**

| Issue | Cause | Fix |
|-------|-------|-----|
| NULL source_match_key | Legacy imports | Match by date+teams (manual) |
| Event not in leagues/tournaments | Missing event record | Script auto-creates |
| Future-dated matches (2027+) | Invalid data | Delete garbage data |

**‚ö†Ô∏è IMPORTANT: Scheduled matches (0-0 scores) with dates in current/next season are NOT garbage!**
They populate the "Upcoming Games" section on team detail pages. Only delete matches dated 2027+ or impossibly far future.

### Age Group Calculation (Dynamic from Seasons Table)

Age group is computed dynamically using the **seasons table** as the single source of truth:

```sql
-- Dynamic formula using seasons table (Session 53+)
age_group = 'U' || (get_current_season_year() - birth_year)

-- Helper function reads from seasons table
CREATE FUNCTION get_current_season_year() RETURNS INTEGER AS $$
  SELECT year FROM seasons WHERE is_current = true LIMIT 1;
$$ LANGUAGE sql STABLE;
```

**Example (season 2026):**
- Birth year 2013 ‚Üí U13 (2026 - 2013 = 13)
- Birth year 2014 ‚Üí U12 (2026 - 2014 = 12)
- Birth year 2015 ‚Üí U11 (2026 - 2015 = 11)

**Key Points:**
- All materialized views compute `age_group` dynamically from `birth_year + season_year`
- The `teams_v2.age_group` column is NOT used by views (legacy, may be removed)
- Season year changes require ONE database update, no code changes

**Why GotSport formula?** GotSport is our primary data source. Their formula is used across all youth soccer. Aligning with their standard ensures consistency.

### Season Rollover Procedure

**When:** Each August 1st when the new soccer season begins.

**Single Command Rollover:**
```sql
-- Step 1: Mark current season as not current
UPDATE seasons SET is_current = false WHERE is_current = true;

-- Step 2: Insert new season
INSERT INTO seasons (name, start_date, end_date, year, is_current)
VALUES ('2026-27 Season', '2026-08-01', '2027-07-31', 2027, true);

-- Step 3: Refresh all materialized views
SELECT refresh_app_views();

-- Step 4: Recalculate ELO for new season
-- Run: node scripts/daily/recalculate_elo_v2.js
```

**What Changes Automatically:**
- All `age_group` values in materialized views update (U12 becomes U13)
- ELO script uses new season boundaries
- Validation pipeline uses new season year for birth year parsing
- TypeScript helpers use new season year (after cache expires or app restart)

**What Does NOT Change:**
- No code deployments needed
- No hardcoded years to find and replace
- `birth_year` values remain the same (they are immutable facts)

### Current Season Stats

Stats in `teams_v2` (wins, losses, draws, matches_played) are **current season only**:
- Season starts August 1, ends July 31
- Matches from previous seasons exist in `matches_v2` but don't count toward current stats
- This aligns with GotSport's annual ranking reset

---

## Session 54 Data Cleanup

### Complete Birth Year Cleanup (January 29, 2026)

Completed the data cleanup started in Session 53, eliminating all birth_year mismatches.

**Script:** `scripts/maintenance/completeBirthYearCleanup.js`

**4-Phase Approach:**
1. **Merge same-target duplicates** - Teams with same canonical_name wanting same birth_year
2. **Merge blocking teams** - Existing team already has the target birth_year
3. **Batch UPDATE** - Single SQL update for remaining mismatches (now safe)
4. **Refresh views** - All 5 materialized views

**Results:**

| Metric | Before | After |
|--------|--------|-------|
| Total teams | 143,523 | 142,541 |
| Name matches birth_year | 51,907 | 68,481 |
| Name mismatches | 25,857 | **0** |
| Duplicates merged | - | 982 |

**Why This Matters:**
- Teams now appear in correct age group filters
- No more "U12" filter showing "U13" teams
- Match history consolidated (no split across duplicates)

---

## Session 52 Data Integrity Audit

### Audit Results (January 28, 2026)

| Area | Status | Finding |
|------|--------|---------|
| ELO/Stats Consistency | ‚úÖ Pass | wins + losses + draws = matches_played for all teams |
| Stats Scope | ‚úÖ Correct | Stats are current-season only (Aug 1+) by design |
| Age Group Calculation | ‚úÖ **Fixed** | 137,872 teams updated with GotSport formula |
| Rankings Partitioning | ‚úÖ Correct | ELO ranks correctly partitioned by birth_year + gender |
| Rank History Capture | ‚úÖ Fixed | Script updated for V2 tables |

### Critical Fix: Age Group Alignment with GotSport

**Problem:** UI testing revealed age group filter was returning wrong teams. Filtering for "U11" showed teams with "(U10 Boys)" and "(U12 Boys)" in their names.

**Root Cause:** Multiple conflicting age calculation formulas:
- GotSport API: `2026 - birthYear` ‚Üí U12
- Database trigger: `seasonYear - birthYear` ‚Üí U11 (tried to be "season-aware")
- Some birth_year values didn't match team names

**Solution:** Align with GotSport formula and parse birth_year from source data:

```sql
-- Step 1: Disable trigger that was overwriting age_group
DROP TRIGGER IF EXISTS trg_teams_v2_age_group ON teams_v2;

-- Step 2: Fix birth_year from team names (source of truth)
UPDATE teams_v2
SET birth_year = (regexp_match(display_name, '(20[01][0-9])'))[1]::int
WHERE display_name ~ '20[01][0-9]'
  AND (birth_year IS NULL OR birth_year != (regexp_match(display_name, '(20[01][0-9])'))[1]::int);

-- Step 3: Apply GotSport formula
UPDATE teams_v2
SET age_group = 'U' || (2026 - birth_year)
WHERE birth_year IS NOT NULL;

-- Step 4: Update display_name suffixes to match
UPDATE teams_v2
SET display_name = regexp_replace(
    display_name,
    '\(U\d+\s*(Boys|Girls)\)',
    '(' || age_group || ' ' || CASE WHEN gender = 'M' THEN 'Boys' ELSE 'Girls' END || ')'
)
WHERE display_name ~ '\(U\d+\s*(Boys|Girls)\)';
-- 137,872 total teams updated
```

### Fixes Applied

| Issue | Fix | Impact |
|-------|-----|--------|
| Conflicting age formulas | Use GotSport formula directly | Consistency |
| Trigger overwrites | Disabled `trg_teams_v2_age_group` | No more conflicts |
| Birth_year mismatches | Parsed from team names | Source of truth |
| Display name mismatches | Updated suffixes | UI consistency |
| captureRankSnapshot.js V1 tables | Updated to `teams_v2` and `rank_history_v2` | Script works |
| GitHub workflow wrong path | Corrected to `scripts/daily/` | Workflow works |

### Key Learnings

1. **Don't over-engineer:** GotSport uses `2026 - birth_year`. We should too. No need for "season-aware" calculations.

2. **Trust source data:** Team names from GotSport contain the correct birth year and age group. Parse and use directly.

3. **Triggers can conflict:** The "smart" trigger kept overwriting correct values. Sometimes simpler is better.

4. **Verify with UI testing:** Filter mismatches in the app caught data issues that SQL audits missed

---

## Session 51 Optimizations

### Performance Improvements

| Optimization | Impact | Details |
|--------------|--------|---------|
| SQL Batch Processing | 100x faster | `batchProcessStaging.js` uses bulk SQL vs row-by-row |
| Featured Teams Index | <100ms queries | `idx_app_rankings_featured` for home tab |
| Removed LIMIT Constraints | Full data integrity | `app_team_profile.recent_matches` now unlimited |

### Data Integrity Fixes

| Fix | Scope | Details |
|-----|-------|---------|
| Age Group Calculation | 137,872 teams | Aligned with GotSport formula `U + (2026 - birth_year)` |
| Birth Year Parsing | Team names | Extracted from display_name with regex |
| Database Trigger | Disabled | `trg_teams_v2_age_group` was causing conflicts |
| Season Stats Source | All team pages | Uses stored `teams_v2` stats, not calculated |

### New Indexes

```sql
-- Fast featured teams query for home tab
CREATE INDEX idx_app_rankings_featured
ON app_rankings (elo_rating DESC)
WHERE has_matches = TRUE;
```

### Updated Scripts

| Script | Change |
|--------|--------|
| `recalculate_elo_v2.js` | Uses `teams_v2` and `matches_v2` (V2 tables) |
| `batchProcessStaging.js` | New: 100x faster staging processor |
| `dataQualityEngine.js` | Universal data quality processor (replaced validationPipeline.js in Session 79) |

---

## Layer 1: Staging Tables

### Purpose
Accept raw data from scrapers without any validation. This ensures:
- Scrapers never fail due to constraint violations
- All incoming data is captured for processing
- Bad data can be reviewed before entering production

### Tables

#### staging_games
```sql
CREATE TABLE staging_games (
  id BIGSERIAL PRIMARY KEY,
  match_date TEXT,
  match_time TEXT,
  home_team_name TEXT,
  away_team_name TEXT,
  home_score TEXT,
  away_score TEXT,
  event_name TEXT,
  event_id TEXT,
  venue_name TEXT,
  field_name TEXT,
  division TEXT,
  source_platform TEXT NOT NULL,
  source_match_key TEXT,  -- UNIQUE constraint added Session 87.2
  raw_data JSONB,
  processed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (source_match_key)  -- Session 87.2: Required for ON CONFLICT in coreScraper.js
);
```

**Note (Session 87.2):** The `source_match_key` column originally had only a non-unique index. `coreScraper.js` uses `ON CONFLICT (source_match_key) DO NOTHING` which requires a unique constraint. Fixed by adding `staging_games_source_match_key_unique UNIQUE (source_match_key)` after deduplicating 87,638 existing duplicate staging rows.

#### staging_teams
```sql
CREATE TABLE staging_teams (
  id BIGSERIAL PRIMARY KEY,
  team_name TEXT NOT NULL,
  club_name TEXT,
  birth_year TEXT,
  gender TEXT,
  state TEXT,
  source_platform TEXT NOT NULL,
  raw_data JSONB,
  processed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### staging_events
```sql
CREATE TABLE staging_events (
  id BIGSERIAL PRIMARY KEY,
  event_name TEXT NOT NULL,
  event_type TEXT,  -- 'league' or 'tournament'
  source_platform TEXT NOT NULL,
  source_event_id TEXT,
  state TEXT,
  region TEXT,
  raw_data JSONB,
  processed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## Layer 2: Production Tables

### Purpose
Store validated, normalized data with proper constraints and relationships.

### Core Tables

#### teams_v2
```sql
CREATE TABLE teams_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  team_name TEXT NOT NULL,
  club_id UUID REFERENCES clubs(id),
  birth_year INTEGER,
  gender gender_type,  -- 'boys' or 'girls'
  state TEXT,
  elo_rating NUMERIC DEFAULT 1500,
  national_rank INTEGER,
  state_rank INTEGER,
  elo_national_rank INTEGER,
  elo_state_rank INTEGER,
  matches_played INTEGER DEFAULT 0,
  wins INTEGER DEFAULT 0,
  losses INTEGER DEFAULT 0,
  draws INTEGER DEFAULT 0,
  data_quality_score INTEGER DEFAULT 0,  -- 0-100
  birth_year_source TEXT,  -- parsed/inferred/official/unknown
  gender_source TEXT,
  data_flags JSONB,
  source_platform TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(team_name, birth_year, gender, state)
);
```

#### matches_v2
```sql
CREATE TABLE matches_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  match_date DATE NOT NULL,
  match_time TIME,
  home_team_id UUID REFERENCES teams_v2(id),
  away_team_id UUID REFERENCES teams_v2(id),
  home_team_name TEXT NOT NULL,
  away_team_name TEXT NOT NULL,
  home_score INTEGER,
  away_score INTEGER,
  league_id UUID REFERENCES leagues(id),
  tournament_id UUID REFERENCES tournaments(id),
  venue_id UUID REFERENCES venues(id),
  division TEXT,
  source_platform TEXT NOT NULL,
  source_match_key TEXT,  -- Audit trail only (Session 85)
  link_status TEXT DEFAULT 'unlinked',
  deleted_at TIMESTAMPTZ,            -- Session 86: NULL = active, timestamp = soft-deleted
  deletion_reason TEXT,              -- Session 86: Why the match was soft-deleted
  created_at TIMESTAMPTZ DEFAULT NOW(),
  CHECK (home_team_id IS DISTINCT FROM away_team_id),
  UNIQUE (match_date, home_team_id, away_team_id)  -- Session 85: Semantic uniqueness
);
```

**Soft-Delete Architecture (Session 86):**

Match deduplication uses soft delete instead of hard delete. The `deleted_at` and `deletion_reason` columns allow matches to be logically removed while preserving data for recovery.

```sql
-- Active matches query (ALWAYS filter soft-deleted)
SELECT * FROM matches_v2 WHERE deleted_at IS NULL;

-- Soft-delete a duplicate match
UPDATE matches_v2
SET deleted_at = NOW(),
    deletion_reason = 'Semantic duplicate of ' || $keeper_id
WHERE id = $duplicate_id;
```

**Current counts:** 403,068 active matches + ~5,468 soft-deleted (Session 90).

#### clubs
```sql
CREATE TABLE clubs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  normalized_name TEXT NOT NULL,
  state TEXT,
  logo_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(normalized_name, state)
);
```

#### leagues
```sql
CREATE TABLE leagues (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  source_event_id TEXT,
  source_platform TEXT,
  season TEXT,
  state TEXT,
  region TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### tournaments
```sql
CREATE TABLE tournaments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  source_event_id TEXT,
  source_platform TEXT,
  start_date DATE,
  end_date DATE,
  state TEXT,
  region TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### source_entity_map (Session 89)
```sql
CREATE TABLE source_entity_map (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  entity_type TEXT NOT NULL CHECK (entity_type IN ('team', 'club', 'league', 'tournament', 'venue', 'schedule')),
  source_platform TEXT NOT NULL,      -- gotsport, htgsports, heartland, etc.
  source_entity_id TEXT NOT NULL,     -- The source's own identifier
  sv_id UUID NOT NULL,                -- SoccerView UUID (our authoritative ID)
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (entity_type, source_platform, source_entity_id)
);
```

**Universal Source Entity Resolution (Session 89):**

Maps source-specific entity IDs to SoccerView UUIDs for deterministic resolution. Enables Tier 1/2 resolution:

| Tier | Method | Accuracy | Speed |
|------|--------|----------|-------|
| **Tier 1** | Source ID ‚Üí `source_entity_map` ‚Üí SV UUID | 100% | O(1) lookup |
| **Tier 2** | Canonical name + NULL-tolerant metadata match | ~99% | O(n) scan |
| **Tier 3** | Fuzzy name + birth_year + gender | ~97% | O(n) with pg_trgm |

**Data flow with source entity resolution:**
```
Scraper emits match with source_team_ids
  ‚Üí Tier 1: Look up source_entity_map (deterministic, fastest)
  ‚Üí Tier 2: Exact canonical_name match (NULL-tolerant birth_year)
  ‚Üí Tier 3: Fuzzy match (suffix, token-based)
  ‚Üí Create new team + register in source_entity_map
```

**Current counts:** 3,253 source entity mappings (1,244 Heartland teams + 274 leagues + 1,735 tournaments).

#### rank_history_v2 (Session 68)
```sql
CREATE TABLE rank_history_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  team_id UUID REFERENCES teams_v2(id) NOT NULL,
  snapshot_date DATE NOT NULL,
  national_rank INTEGER,           -- GotSport national rank
  state_rank INTEGER,              -- GotSport state rank
  elo_rating NUMERIC,              -- SoccerView ELO rating
  elo_national_rank INTEGER,       -- SoccerView national rank (Session 68)
  elo_state_rank INTEGER,          -- SoccerView state rank (Session 68)
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(team_id, snapshot_date)
);

-- Indexes for efficient chart queries
CREATE INDEX idx_rank_history_v2_team_date ON rank_history_v2 (team_id, snapshot_date);
CREATE INDEX idx_rank_history_v2_elo_national ON rank_history_v2 (team_id, snapshot_date) WHERE elo_national_rank IS NOT NULL;
CREATE INDEX idx_rank_history_v2_elo_state ON rank_history_v2 (team_id, snapshot_date) WHERE elo_state_rank IS NOT NULL;
```

**Populated by:**
- `scripts/daily/captureRankSnapshot.js` - Daily snapshot capture via GitHub Actions
- `scripts/onetime/backfillRankHistory.js` - One-time historical rank calculation from ELO data
- `scripts/maintenance/recalculateHistoricalRanks.cjs` - Recalculate ranks with consistent baseline (Session 70)

**Rank Calculation Methodology (Session 70):**

Historical ranks use a **CONSISTENT BASELINE** (GotSport-inspired):
- Each historical ELO is ranked against TODAY's full team pool
- This ensures ranks are meaningful and comparable across time
- Example: ELO 1558 ‚Üí #304 (top 7%), ELO 1469 ‚Üí #3,551 (bottom 20%)

```sql
-- For each historical ELO, count teams with higher ELO in current pool
SELECT COUNT(*) + 1 as rank
FROM teams_v2
WHERE birth_year = $birth_year AND gender = $gender
  AND matches_played > 0
  AND elo_rating > $historical_elo
```

**See also:** [2-RANKING_METHODOLOGY.md](2-RANKING_METHODOLOGY.md) for complete ELO and ranking specification.

### Data Quality Score

Teams have a `data_quality_score` (0-100) calculated as:

| Component | Points | Logic |
|-----------|--------|-------|
| birth_year | +30 | If not null |
| gender | +30 | If not null |
| national_rank | +20 | If not null |
| matches_played | +10 | If > 0 |
| elo_rating | +10 | If ‚â† 1500 (default) |

---

## Layer 3: Materialized Views

### Purpose
Pre-computed views for fast app queries. Most app screens query these views.

**Exception (Session 75):** For user-facing aggregate data on Team Detail page, query source tables directly to avoid stale data:
- Season Stats ‚Üí Query `matches_v2` directly
- Power Rating ‚Üí Query `teams_v2` directly

See Principle 23 in CLAUDE.md and UI Pattern 21 for implementation details.

### View Definitions

#### app_rankings
Used by: Rankings tab, Teams tab
```sql
CREATE MATERIALIZED VIEW app_rankings AS
SELECT
  t.id,
  t.team_name,
  t.birth_year,
  t.gender,
  t.state,
  t.elo_rating,
  t.national_rank,
  t.state_rank,
  t.elo_national_rank,
  t.elo_state_rank,
  t.matches_played,
  t.wins,
  t.losses,
  t.draws,
  t.data_quality_score,
  c.name as club_name,
  c.logo_url as club_logo,
  -- Calculated age group
  CASE
    WHEN t.birth_year IS NOT NULL
    THEN 'U' || (EXTRACT(YEAR FROM CURRENT_DATE) - t.birth_year + 1)::TEXT
    ELSE NULL
  END as age_group
FROM teams_v2 t
LEFT JOIN clubs c ON t.club_id = c.id
WHERE t.matches_played > 0 OR t.national_rank IS NOT NULL;
```

#### app_matches_feed
Used by: Matches tab, Home tab carousels
```sql
CREATE MATERIALIZED VIEW app_matches_feed AS
SELECT
  m.id,
  m.match_date,
  m.match_time,
  m.home_score,
  m.away_score,
  m.division,
  -- Home team as JSONB
  jsonb_build_object(
    'id', ht.id,
    'name', ht.team_name,
    'elo', ht.elo_rating
  ) as home_team,
  -- Away team as JSONB
  jsonb_build_object(
    'id', at.id,
    'name', at.team_name,
    'elo', at.elo_rating
  ) as away_team,
  -- Event as JSONB
  COALESCE(
    jsonb_build_object('id', l.id, 'name', l.name, 'type', 'league'),
    jsonb_build_object('id', t.id, 'name', t.name, 'type', 'tournament')
  ) as event
FROM matches_v2 m
LEFT JOIN teams_v2 ht ON m.home_team_id = ht.id
LEFT JOIN teams_v2 at ON m.away_team_id = at.id
LEFT JOIN leagues l ON m.league_id = l.id
LEFT JOIN tournaments t ON m.tournament_id = t.id
WHERE m.match_date IS NOT NULL
ORDER BY m.match_date DESC;
```

#### app_league_standings
Used by: League detail page
```sql
CREATE MATERIALIZED VIEW app_league_standings AS
WITH match_stats AS (
  SELECT
    team_id,
    league_id,
    COUNT(*) as played,
    SUM(CASE WHEN won THEN 1 ELSE 0 END) as wins,
    SUM(CASE WHEN drawn THEN 1 ELSE 0 END) as draws,
    SUM(CASE WHEN lost THEN 1 ELSE 0 END) as losses,
    SUM(goals_for) as goals_for,
    SUM(goals_against) as goals_against
  FROM (
    -- Home matches
    SELECT home_team_id as team_id, league_id,
           home_score > away_score as won,
           home_score = away_score as drawn,
           home_score < away_score as lost,
           home_score as goals_for,
           away_score as goals_against
    FROM matches_v2 WHERE league_id IS NOT NULL AND home_score IS NOT NULL
    UNION ALL
    -- Away matches
    SELECT away_team_id as team_id, league_id,
           away_score > home_score as won,
           away_score = home_score as drawn,
           away_score < home_score as lost,
           away_score as goals_for,
           home_score as goals_against
    FROM matches_v2 WHERE league_id IS NOT NULL AND away_score IS NOT NULL
  ) sub
  GROUP BY team_id, league_id
)
SELECT
  ms.*,
  ms.wins * 3 + ms.draws as points,
  ms.goals_for - ms.goals_against as goal_difference,
  t.team_name,
  t.elo_rating,
  l.name as league_name
FROM match_stats ms
JOIN teams_v2 t ON ms.team_id = t.id
JOIN leagues l ON ms.league_id = l.id;
```

#### app_upcoming_schedule
Used by: Team detail page "Upcoming" section, home page upcoming matches.

**Critical Design Decision (Session 56):** Only shows VERIFIED matches (linked to league or tournament). Unlinked matches are EXCLUDED for data integrity - parents plan weekends around this data.

```sql
CREATE MATERIALIZED VIEW app_upcoming_schedule AS
-- Part 1: From schedules table (original)
SELECT
  s.id, s.match_date, s.match_time,
  home_team JSONB, away_team JSONB,
  event JSONB (league or tournament),
  venue JSONB, field_name, gender, birth_year, age_group, state
FROM schedules s
JOIN teams_v2 ht ON s.home_team_id = ht.id
JOIN teams_v2 at ON s.away_team_id = at.id
WHERE s.match_date >= CURRENT_DATE

UNION ALL

-- Part 2: From matches_v2 (scheduled future matches WITH KNOWN EVENTS ONLY)
SELECT ... same structure ...
FROM matches_v2 m
JOIN teams_v2 ht ON m.home_team_id = ht.id
JOIN teams_v2 at ON m.away_team_id = at.id
WHERE m.match_date >= CURRENT_DATE
  AND m.home_score = 0 AND m.away_score = 0
  -- CRITICAL: Only include matches with known events (data integrity)
  AND (m.league_id IS NOT NULL OR m.tournament_id IS NOT NULL)
  AND NOT EXISTS (SELECT 1 FROM schedules s WHERE s.id = m.id);
```

**Why UNION both sources?**
- `schedules` table: Scrapers with dedicated schedule data (venue, field info)
- `matches_v2`: Scraped games with 0-0 scores are scheduled but not yet played

**Why exclude unlinked matches?**
- User trust: "I see my kid's game" must be accurate
- Data integrity: If we don't know the event, the match might be garbage
- Better UX: Show fewer verified matches > more unverified guesses

### Refreshing Views

Views are refreshed via the `refresh_app_views()` function:

```sql
CREATE OR REPLACE FUNCTION refresh_app_views()
RETURNS void AS $$
BEGIN
  REFRESH MATERIALIZED VIEW CONCURRENTLY app_rankings;
  REFRESH MATERIALIZED VIEW CONCURRENTLY app_matches_feed;
  REFRESH MATERIALIZED VIEW CONCURRENTLY app_league_standings;
  REFRESH MATERIALIZED VIEW CONCURRENTLY app_upcoming_schedule;
  REFRESH MATERIALIZED VIEW CONCURRENTLY app_team_profile;
END;
$$ LANGUAGE plpgsql;
```

---

## Data Flow

### Scraper ‚Üí App Pipeline

```
1. SCRAPER writes to staging_games
   ‚Üì
2. dataQualityEngine.js runs:
   - Validates data quality
   - Normalizes team names
   - Creates/links teams in teams_v2
   - Inserts matches to matches_v2
   - Creates league/tournament entries
   ‚Üì
3. refresh_app_views() refreshes materialized views
   ‚Üì
4. App queries app_* views
```

### Daily Sync Workflow

```yaml
# .github/workflows/daily-data-sync.yml
jobs:
  # Phase 1: Scrape data to staging tables (Universal Framework - Session 57)
  sync-gotsport:        ‚Üí coreScraper.js --adapter gotsport (fallback: syncActiveEvents.js)
  sync-htgsports:       ‚Üí coreScraper.js --adapter htgsports (fallback: scrapeHTGSports.js)
  sync-heartland:       ‚Üí coreScraper.js --adapter heartland (fallback: legacy scripts)

  # Phase 1.5: Intake validation (Session 79)
  intake-validation:    ‚Üí intakeValidator.js (reject garbage, fix malformed)

  # Phase 2: Normalize, resolve, promote to production
  data-quality-engine:  ‚Üí dataQualityEngine.js ‚Üí teams_v2, matches_v2, leagues, tournaments

  # Phase 2.5: Self-healing inference linkage (Session 56)
  infer-event-linkage:  ‚Üí Links orphaned matches by team patterns

  # Phase 3: ELO calculation
  recalculate-elo:      ‚Üí Updates power ratings

  # Phase 4: Refresh app views
  refresh-views:        ‚Üí app_rankings, app_matches_feed, etc.
```

**Workflow Inputs (Session 57):**
| Input | Default | Purpose |
|-------|---------|---------|
| `use_universal_framework` | `true` | Use adapter-based scrapers |
| `fallback_on_error` | `true` | Auto-fallback to legacy if universal fails |

---

## Key Scripts

| Script | Purpose | Layer |
|--------|---------|-------|
| `scripts/universal/coreScraper.js` | **Universal scraping engine (Session 57)** | 1 (staging) |
| `scripts/adapters/*.js` | Source-specific configurations | Config |
| `scrapeHeartlandResults.js` | Scrape Heartland matches (legacy) | 1 (staging) |
| `scrapeHTGSports.js` | Scrape HTGSports tournaments (legacy) | 1 (staging) |
| `syncActiveEvents.js` | Scrape GotSport events (legacy) | 1 (staging) |
| `dataQualityEngine.js` | **THE processor** - Normalize, resolve, promote (Session 79) | 1 ‚Üí 2 |
| `inferEventLinkage.js` | **NIGHTLY** Self-healing orphan linkage | 2 |
| `recalculate_elo_v2.js` | Calculate ELO ratings | 2 |
| `completeBirthYearCleanup.js` | Merge duplicates, fix birth_years | 2 |
| `backfillSourceMatchKey.js` | One-time key backfill (Session 57) | Migration |
| `refresh_app_views()` | Refresh materialized views | 2 ‚Üí 3 |

---

## Migration from V1

### Archived Tables (V1)
The following tables were renamed to `*_deprecated` in Session 50:
- `teams` ‚Üí `teams_deprecated`
- `match_results` ‚Üí `match_results_deprecated`
- `event_registry` ‚Üí `event_registry_deprecated`
- `team_name_aliases` ‚Üí `team_name_aliases_deprecated`
- `rank_history` ‚Üí `rank_history_deprecated`
- `predictions` ‚Üí `predictions_deprecated`

### Why V2?
1. **Cleaner separation**: Staging vs production vs app-ready data
2. **Better data quality**: Quality scores, source tracking
3. **Faster queries**: Materialized views with embedded JSONB
4. **Easier debugging**: Staging tables preserve raw data
5. **Scalable ingestion**: No constraints on staging = no scraper failures

---

## Appendix: Type Definitions

### gender_type enum
```sql
CREATE TYPE gender_type AS ENUM ('boys', 'girls');
```

### link_status values
```sql
'unlinked'      -- Match has team names but no team_id links
'partial'       -- One team linked, one missing
'linked'        -- Both teams linked
'manual'        -- Manually verified link
```

---

*This document is the authoritative reference for SoccerView's database architecture.*
*For changes, update this document and notify the team.*
